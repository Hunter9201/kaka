<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>BAR MANAGEMENT SYSTEM - Enhanced with Purchases & Daily Sheets</title>
<meta name="description" content="Fully functional bar stock management system with purchases and daily sheet tracking">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
<script src="https://cdn.sheetjs.com/xlsx-0.20.2/package/dist/xlsx.full.min.js"></script>
<!-- Google Identity Services -->
<script src="https://accounts.google.com/gsi/client" async defer></script>
<style>
  :root{ --brand:#0ea5e9; --brand-d:#0369a1; --ok:#16a34a; --warn:#f59e0b; --bad:#ef4444; --ink:#0f172a; --muted:#64748b; --line:#e2e8f0; --bg:#f8fafc; }
  *{box-sizing:border-box; margin:0; padding:0;}
  html,body{height:100%}
  body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,sans-serif;background:var(--bg);color:var(--ink);line-height:1.5;}
  header{position:sticky;top:0;z-index:20;background:#fff;border-bottom:1px solid var(--line);padding:0 16px;}
  .nav{display:flex;gap:12px;align-items:center;justify-content:space-between;padding:12px 0;max-width:1400px;margin:0 auto;}
  .brand{display:flex;gap:10px;align-items:center;font-weight:800;font-size:18px;}
  .brand-badge{width:36px;height:36px;border-radius:10px;background:var(--brand);color:#fff;display:grid;place-items:center;font-weight:bold;}
  .tabs{display:flex;flex-wrap:wrap;gap:6px;}
  .tab{border:1px solid var(--line);background:#fff;border-radius:8px;padding:8px 16px;cursor:pointer;font-weight:600;font-size:14px;transition:all 0.2s;}
  .tab:hover{background:#f1f5f9;}
  .tab.active{background:var(--brand);border-color:var(--brand);color:#fff;}
  main{padding:20px 16px;max-width:1400px;margin:0 auto;width:100%;}
  h2{margin:0 0 20px;font-size:24px;}
  h3{margin:0 0 16px;font-size:18px;}
  h4{margin:0 0 12px;font-size:16px;}
  .row{display:grid;grid-template-columns:repeat(12,1fr);gap:16px;}
  .card{background:#fff;border:1px solid var(--line);border-radius:12px;padding:20px;box-shadow:0 2px 4px rgba(0,0,0,0.05);}
  label{font-size:14px;color:var(--muted);display:block;margin-bottom:6px;font-weight:600;}
  input,select,button,textarea{font-family:inherit;font-size:14px;}
  input[type="number"],input[type="date"],input[type="text"],select,textarea{width:100%;padding:10px 12px;border:1px solid var(--line);border-radius:8px;background:#fff;transition:border 0.2s;}
  input:focus,select:focus,textarea:focus{outline:none;border-color:var(--brand);box-shadow:0 0 0 3px rgba(14,165,233,0.1);}
  .btn{padding:10px 16px;border-radius:8px;border:1px solid var(--line);background:#fff;cursor:pointer;font-weight:600;font-size:14px;transition:all 0.2s;display:inline-flex;align-items:center;justify-content:center;gap:6px;}
  .btn:hover{background:#f8fafc;}
  .btn.primary{background:var(--brand);border-color:var(--brand);color:#fff;}
  .btn.primary:hover{background:var(--brand-d);border-color:var(--brand-d);}
  .btn.ok{background:var(--ok);border-color:var(--ok);color:#fff;}
  .btn.ok:hover{background:#15803d;}
  .btn.warn{background:var(--warn);border-color:var(--warn);color:#111827;}
  .btn.bad{background:var(--bad);border-color:var(--bad);color:#fff;}
  .stack{display:flex;flex-wrap:wrap;gap:8px;align-items:center;}
  .muted{color:var(--muted);font-size:14px;}
  .pill{display:inline-block;padding:4px 10px;border-radius:999px;border:1px solid var(--line);background:#f1f5f9;font-size:12px;font-weight:600;}
  .table{width:100%;border-collapse:separate;border-spacing:0;}
  .table th{background:#f8fafc;border-bottom:2px solid var(--line);padding:12px;text-align:left;font-size:13px;font-weight:600;color:var(--muted);}
  .table td{border-bottom:1px solid var(--line);padding:12px;font-size:14px;}
  .table tr:hover td{background:#f8fafc;}
  .help{font-size:12px;color:var(--muted);margin-top:8px;}
  .right{display:flex;justify-content:flex-end;gap:12px;}
  .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:16px;}
  .grid-3{display:grid;grid-template-columns:repeat(3,1fr);gap:16px;}
  .grid-4{display:grid;grid-template-columns:repeat(4,1fr);gap:16px;}
  .stat{padding:16px;border:1px solid var(--line);border-radius:10px;background:#fff;}
  .stat b{display:block;font-size:24px;margin-top:4px;color:var(--ink);}
  .hr{height:1px;background:var(--line);margin:20px 0;}
  .warnmsg{background:#fff7ed;border:1px solid #fdba74;color:#9a3412;padding:12px;border-radius:10px;margin:12px 0;}
  .goodmsg{background:#ecfdf5;border:1px solid #86efac;color:#065f46;padding:12px;border-radius:10px;margin:12px 0;}
  .badmsg{background:#fee2e2;border:1px solid #fca5a5;color:#991b1b;padding:12px;border-radius:10px;margin:12px 0;}
  .section-tools{display:flex;gap:12px;align-items:center;margin-bottom:16px;flex-wrap:wrap;}
  .compact-table th,.compact-table td{padding:8px 10px;font-size:13px;}
  .modal{display:none;position:fixed;z-index:1000;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,0.5);justify-content:center;align-items:center;}
  .modal-content{background:#fff;padding:24px;border-radius:12px;width:90%;max-width:500px;max-height:80vh;overflow-y:auto;box-shadow:0 10px 25px rgba(0,0,0,0.2);}
  .modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;}
  .close-modal{cursor:pointer;font-size:28px;color:var(--muted);}
  .close-modal:hover{color:var(--ink);}
  .loading{display:none;position:fixed;z-index:2000;top:0;left:0;width:100%;height:100%;background:rgba(255,255,255,0.9);justify-content:center;align-items:center;flex-direction:column;gap:16px;}
  .loading-spinner{width:40px;height:40px;border:4px solid #f3f3f3;border-top:4px solid var(--brand);border-radius:50%;animation:spin 1s linear infinite;}
  @keyframes spin{0%{transform:rotate(0deg);}100%{transform:rotate(360deg);}}
  .mono{font-family:ui-monospace, Menlo, Consolas, "Courier New", monospace; white-space: pre-wrap;}
  @media (max-width: 1200px){.grid-4{grid-template-columns:repeat(2,1fr);}}
  @media (max-width: 768px){.grid-2,.grid-3,.grid-4{grid-template-columns:1fr;}.row{grid-template-columns:1fr;}.card{padding:16px;}.nav{flex-direction:column;gap:16px;}.tabs{width:100%;justify-content:center;}}
</style>
</head>
<body>
  <header>
    <div class="nav">
      <div class="brand"><div class="brand-badge">B</div>BAR MANAGEMENT SYSTEM</div>
      <div class="tabs" id="tabs">
        <button class="tab active" data-tab="dashboard">Dashboard</button>
        <button class="tab" data-tab="inventory">Inventory</button>
        <button class="tab" data-tab="sales">Daily Sales</button>
        <button class="tab" data-tab="purchases">Purchases</button>
        <button class="tab" data-tab="expenses">Expenses</button>
        <button class="tab" data-tab="reports">Reports</button>
        <button class="tab" data-tab="products">Products</button>
        <button class="tab" data-tab="automation">Automation</button>
        <button class="tab" data-tab="data">Data</button>
      </div>
    </div>
  </header>

  <main>
    <!-- Dashboard -->
    <section id="dashboard" class="tabpanel">
      <h2>Dashboard Overview</h2>
      <div class="grid-4">
        <div class="stat"><span class="muted">Total Products</span><b id="statProducts">0</b></div>
        <div class="stat"><span class="muted">Stock Value</span><b id="statStockValue">UGX 0</b></div>
        <div class="stat"><span class="muted">Monthly Purchases</span><b id="statMonthPurchases">UGX 0</b></div>
        <div class="stat"><span class="muted">Most Moving Category</span><b id="statMostMoving">-</b></div>
      </div>
      
      <div class="hr"></div>
      
      <div class="grid-3">
        <div class="stat">
          <span class="muted">Gross Profit (Period)</span>
          <b id="statGrossProfit">UGX 0</b>
        </div>
        <div class="stat">
          <span class="muted">Total Expenses</span>
          <b id="statTotalExpenses">UGX 0</b>
        </div>
        <div class="stat">
          <span class="muted">Net Profit/Loss</span>
          <b id="statNetProfit">UGX 0</b>
        </div>
      </div>
      
      <div class="hr"></div>
      
      <div class="card" id="profitStatusCard">
        <h3>Profitability Status</h3>
        <div id="profitStatus" class="goodmsg">
          <strong>Status:</strong> Calculating profitability...
        </div>
      </div>
    </section>

    <!-- Inventory -->
    <section id="inventory" class="tabpanel" style="display:none;">
      <div class="card">
        <div class="section-tools">
          <h3 style="margin-right:auto">Inventory Management</h3>
          <button class="btn" id="btnPrintInventory">Print</button>
          <button class="btn" id="btnExportInventory">Export CSV</button>
        </div>
        
        <div class="grid-3">
          <div>
            <label>Stock Date</label>
            <input type="date" id="inventoryDate" value="">
          </div>
          <div>
            <label>Filter Category</label>
            <select id="filterCategory">
              <option value="">All Categories</option>
              <option value="beer">Beer</option>
              <option value="Soft Drink">Soft Drink</option>
              <option value="Energy Drink">Energy Drink</option>
              <option value="Spirit">Spirit</option>
              <option value="wine">Wine</option>
            </select>
          </div>
          <div class="right">
            <button class="btn primary" id="btnUpdateInventory">Update</button>
          </div>
        </div>
        
        <div class="hr"></div>
        
        <table class="table" id="inventoryTable">
          <thead>
            <tr>
              <th>Product</th>
              <th>Category</th>
              <th>Opening Stock</th>
              <th>Purchased</th>
              <th>Sold</th>
              <th>Current Stock</th>
              <th>Cost Price</th>
              <th>Sale Price</th>
              <th>Stock Value</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- Daily Sales -->
    <section id="sales" class="tabpanel" style="display:none;">
      <div class="grid-2">
        <div class="card">
          <h3>Record Daily Sales</h3>
          <div class="grid-3">
            <div>
              <label>Date (Unique Day)</label>
              <input type="date" id="saleDate" value="">
            </div>
            <div>
              <label>Sheet Reference</label>
              <input type="text" id="sheetReference" placeholder="e.g., Sheet1">
            </div>
            <div>
              <label>Record Type</label>
              <select id="recordType">
                <option value="manual">Manual Entry</option>
                <option value="excel">From Excel Sheet</option>
              </select>
            </div>
          </div>
          
          <div class="hr"></div>
          
          <h4>Daily Sales Items</h4>
          <div class="grid-4" style="margin-bottom:12px;">
            <div>
              <label>Product</label>
              <select id="saleProduct"></select>
            </div>
            <div>
              <label>Quantity Sold</label>
              <input type="number" id="saleQty" min="1" value="1">
            </div>
            <div>
              <label>Unit Price (UGX)</label>
              <input type="number" id="salePrice" min="0" value="0">
            </div>
            <div style="align-self:flex-end;">
              <button class="btn" id="btnAddSaleItem">Add Item</button>
            </div>
          </div>
          
          <table class="table compact-table" id="saleItemsTable">
            <thead><tr><th>Product</th><th>Qty</th><th>Unit Price</th><th>Total</th><th>Profit</th><th></th></tr></thead>
            <tbody></tbody>
          </table>
          
          <div class="right" style="margin-top:16px;">
            <div class="stat">
              <span class="muted">Total Sales</span>
              <b id="saleTotal">UGX 0</b>
            </div>
            <div class="stat">
              <span class="muted">Total Profit</span>
              <b id="saleProfit">UGX 0</b>
            </div>
            <button class="btn ok" id="btnSaveDailySales">Save Daily Sales</button>
          </div>
        </div>
        
        <div class="card">
          <h3>Recent Daily Sales</h3>
          <div class="grid-3" style="margin-bottom:16px;">
            <div>
              <label>From Date</label>
              <input type="date" id="saleFrom">
            </div>
            <div>
              <label>To Date</label>
              <input type="date" id="saleTo">
            </div>
            <div style="align-self:flex-end;">
              <button class="btn" id="btnFilterSales">Filter</button>
            </div>
          </div>
          
          <table class="table compact-table" id="salesHistoryTable">
            <thead>
              <tr>
                <th>Date</th>
                <th>Items Sold</th>
                <th>Total Sales</th>
                <th>Total Profit</th>
                <th>Source</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
      
      <div class="hr"></div>
      
      <div class="card">
        <h3>Product Sales History</h3>
        <div class="grid-3" style="margin-bottom:16px;">
          <div>
            <label>Product</label>
            <select id="productHistorySelect"></select>
          </div>
          <div>
            <label>From Date</label>
            <input type="date" id="productHistoryFrom">
          </div>
          <div>
            <label>To Date</label>
            <input type="date" id="productHistoryTo">
          </div>
        </div>
        
        <table class="table compact-table" id="productHistoryTable">
          <thead>
            <tr>
              <th>Date</th>
              <th>Quantity Sold</th>
              <th>Total Sales</th>
              <th>Total Profit</th>
              <th>Avg Price</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- PURCHASES SECTION - NEW -->
    <section id="purchases" class="tabpanel" style="display:none;">
      <div class="grid-2">
        <div class="card">
          <h3>Record Purchase (Restocking)</h3>
          <div class="grid-3">
            <div>
              <label>Purchase Date</label>
              <input type="date" id="purchaseDate" value="">
            </div>
            <div>
              <label>Supplier</label>
              <input type="text" id="purchaseSupplier" placeholder="Supplier name">
            </div>
            <div>
              <label>Invoice Number</label>
              <input type="text" id="purchaseInvoice" placeholder="Optional">
            </div>
          </div>
          
          <div class="hr"></div>
          
          <h4>Purchase Items</h4>
          <div class="grid-4" style="margin-bottom:12px;">
            <div>
              <label>Product</label>
              <select id="purchaseProduct"></select>
            </div>
            <div>
              <label>Quantity</label>
              <input type="number" id="purchaseQty" min="1" value="1">
            </div>
            <div>
              <label>Unit Cost (UGX)</label>
              <input type="number" id="purchaseCost" min="0" value="0">
            </div>
            <div style="align-self:flex-end;">
              <button class="btn" id="btnAddPurchaseItem">Add Item</button>
            </div>
          </div>
          
          <table class="table compact-table" id="purchaseItemsTable">
            <thead><tr><th>Product</th><th>Qty</th><th>Unit Cost</th><th>Total Cost</th><th></th></tr></thead>
            <tbody></tbody>
          </table>
          
          <div class="right" style="margin-top:16px;">
            <div class="stat">
              <span class="muted">Total Purchase</span>
              <b id="purchaseTotal">UGX 0</b>
            </div>
            <button class="btn primary" id="btnSavePurchase">Save Purchase</button>
          </div>
        </div>
        
        <div class="card">
          <h3>Recent Purchases</h3>
          <div class="grid-3" style="margin-bottom:16px;">
            <div>
              <label>From Date</label>
              <input type="date" id="purchaseFrom">
            </div>
            <div>
              <label>To Date</label>
              <input type="date" id="purchaseTo">
            </div>
            <div style="align-self:flex-end;">
              <button class="btn" id="btnFilterPurchases">Filter</button>
            </div>
          </div>
          
          <table class="table compact-table" id="purchasesTable">
            <thead>
              <tr>
                <th>Date</th>
                <th>Supplier</th>
                <th>Items</th>
                <th>Total Cost</th>
                <th></th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
          
          <div class="right" style="margin-top:16px;">
            <div class="stat">
              <span class="muted">Total Purchases</span>
              <b id="totalPurchases">UGX 0</b>
            </div>
          </div>
        </div>
      </div>
      
      <div class="hr"></div>
      
      <div class="card">
        <h3>Purchase Analysis</h3>
        <div class="grid-3" style="margin-bottom:16px;">
          <div>
            <label>Product</label>
            <select id="purchaseAnalysisProduct">
              <option value="">All Products</option>
            </select>
          </div>
          <div>
            <label>From Date</label>
            <input type="date" id="purchaseAnalysisFrom">
          </div>
          <div>
            <label>To Date</label>
            <input type="date" id="purchaseAnalysisTo">
          </div>
        </div>
        
        <div class="grid-3">
          <div class="stat">
            <span class="muted">Total Purchased Value</span>
            <b id="analysisTotalValue">UGX 0</b>
          </div>
          <div class="stat">
            <span class="muted">Average Cost</span>
            <b id="analysisAvgCost">UGX 0</b>
          </div>
          <div class="stat">
            <span class="muted">Reorder Frequency</span>
            <b id="analysisReorderFreq">-</b>
          </div>
        </div>
        
        <table class="table compact-table" id="purchaseAnalysisTable">
          <thead>
            <tr>
              <th>Product</th>
              <th>Total Purchased</th>
              <th>Total Cost</th>
              <th>Avg Unit Cost</th>
              <th>Last Purchase Date</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- Expenses -->
    <section id="expenses" class="tabpanel" style="display:none;">
      <div class="grid-2">
        <div class="card">
          <h3>Record Expense</h3>
          <div class="grid-3">
            <div>
              <label>Date</label>
              <input type="date" id="expenseDate" value="">
            </div>
            <div>
              <label>Expense Type</label>
              <select id="expenseType">
                <option value="rent">Rent</option>
                <option value="utilities">Utilities</option>
                <option value="salaries">Salaries</option>
                <option value="supplies">Supplies</option>
                <option value="maintenance">Maintenance</option>
                <option value="other">Other</option>
              </select>
            </div>
            <div>
              <label>Amount (UGX)</label>
              <input type="number" id="expenseAmount" min="0" value="0">
            </div>
          </div>
          
          <div>
            <label>Description</label>
            <textarea id="expenseDescription" rows="3" placeholder="Enter expense details..."></textarea>
          </div>
          
          <div class="right" style="margin-top:16px;">
            <button class="btn primary" id="btnSaveExpense">Save Expense</button>
          </div>
        </div>
        
        <div class="card">
          <h3>Recent Expenses</h3>
          <div class="grid-3" style="margin-bottom:16px;">
            <div>
              <label>From Date</label>
              <input type="date" id="expenseFrom">
            </div>
            <div>
              <label>To Date</label>
              <input type="date" id="expenseTo">
            </div>
            <div style="align-self:flex-end;">
              <button class="btn" id="btnFilterExpenses">Filter</button>
            </div>
          </div>
          
          <table class="table compact-table" id="expensesTable">
            <thead>
              <tr>
                <th>Date</th>
                <th>Type</th>
                <th>Description</th>
                <th>Amount</th>
                <th></th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
          
          <div class="right" style="margin-top:16px;">
            <div class="stat">
              <span class="muted">Total Expenses</span>
              <b id="totalExpenses">UGX 0</b>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Reports -->
    <section id="reports" class="tabpanel" style="display:none;">
      <div class="card">
        <div class="section-tools">
          <h3 style="margin-right:auto">Profit & Loss Report</h3>
          <button class="btn" id="btnPrintReport">Print</button>
          <button class="btn" id="btnExportReport">Export Excel</button>
        </div>
        
        <div class="grid-4">
          <div>
            <label>Report Period Start</label>
            <input type="date" id="reportStart" value="">
          </div>
          <div>
            <label>Report Period End</label>
            <input type="date" id="reportEnd" value="">
          </div>
          <div>
            <label>Report Type</label>
            <select id="reportType">
              <option value="profitloss">Profit & Loss</option>
              <option value="purchases">Purchases Summary</option>
              <option value="inventory">Inventory Valuation</option>
              <option value="combined">Combined Report</option>
            </select>
          </div>
          <div class="right">
            <button class="btn primary" id="btnGenerateReport">Generate Report</button>
          </div>
        </div>
        
        <div class="hr"></div>
        
        <div id="reportOutput">
          <!-- Report will be generated here -->
        </div>
      </div>
    </section>

    <!-- Products -->
    <section id="products" class="tabpanel" style="display:none;">
      <div class="row">
        <div class="card" style="grid-column:span 4;">
          <h3>Add/Edit Product</h3>
          <div>
            <label>Product Name</label>
            <input id="productName" type="text" placeholder="e.g., NILE Beer">
          </div>
          <div style="margin-top:12px;">
            <label>Category</label>
            <select id="productCategory">
              <option value="beer">Beer</option>
              <option value="Soft Drink">Soft Drink</option>
              <option value="Energy Drink">Energy Drink</option>
              <option value="Spirit">Spirit</option>
              <option value="wine">Wine</option>
            </select>
          </div>
          <div class="grid-2" style="margin-top:12px;gap:12px;">
            <div>
              <label>Purchase Price (UGX)</label>
              <input id="productCost" type="number" min="0" value="0">
            </div>
            <div>
              <label>Sale Price (UGX)</label>
              <input id="productPrice" type="number" min="0" value="0">
            </div>
          </div>
          <div class="grid-2" style="margin-top:12px;gap:12px;">
            <div>
              <label>Opening Stock</label>
              <input id="productOpeningStock" type="number" min="0" value="0">
            </div>
            <div>
              <label>Reorder Level</label>
              <input id="productReorderLevel" type="number" min="0" value="10">
            </div>
          </div>
          <div class="stack" style="margin-top:20px;">
            <button class="btn primary" id="btnSaveProduct">Save Product</button>
            <button class="btn bad" id="btnDeleteProduct" disabled>Delete</button>
          </div>
          <p class="help">Products are saved automatically</p>
        </div>
        
        <div class="card" style="grid-column:span 8;">
          <h3>Product List (From Excel Sheet)</h3>
          <div class="section-tools" style="margin-bottom:16px;">
            <input type="text" id="productSearch" placeholder="Search products..." style="flex:1;">
            <select id="productSort">
              <option value="name">Sort by Name</option>
              <option value="category">Sort by Category</option>
              <option value="stock">Sort by Stock</option>
              <option value="profit">Sort by Profit Margin</option>
              <option value="needReorder">Needs Reorder</option>
            </select>
          </div>
          
          <table class="table" id="productsTable">
            <thead>
              <tr>
                <th>Product</th>
                <th>Category</th>
                <th>Purchase Price</th>
                <th>Sale Price</th>
                <th>Profit Margin</th>
                <th>Opening Stock</th>
                <th>Purchased</th>
                <th>Sold</th>
                <th>Current Stock</th>
                <th></th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- Automation -->
    <section id="automation" class="tabpanel" style="display:none;">
      <div class="card">
        <h3>Excel Sheet Processor</h3>
        <div class="grid-3">
          <div class="stat">
            <span class="muted">Sheets Processed</span>
            <b id="processedSheetsCount">0</b>
          </div>
          <div class="stat">
            <span class="muted">Unique Dates</span>
            <b id="uniqueDatesCount">0</b>
          </div>
          <div class="stat">
            <span class="muted">Last Import</span>
            <b id="lastAutoRun">Never</b>
          </div>
        </div>
        
        <div class="hr"></div>
        
        <h4>Import Excel Daily Sheet</h4>
        <div class="stack">
          <label class="btn">
            <input type="file" id="dailyExcelFile" accept=".xlsx,.xls" style="display:none">
            Upload Daily Sheet
          </label>
          <button class="btn ok" id="btnProcessDailySheet">Process Sheet</button>
        </div>
        
        <div class="grid-3" style="margin-top:12px;">
          <div>
            <label>Sheet Date</label>
            <input type="date" id="sheetDate" value="">
          </div>
          <div>
            <label>Overwrite Existing</label>
            <select id="overwriteOption">
              <option value="no">Keep Existing</option>
              <option value="yes">Overwrite</option>
            </select>
          </div>
        </div>
        
        <p class="help">Each sheet must have a unique date. Uploaded sheets will create/update daily sales records.</p>
        
        <div class="hr"></div>
        
        <h4>Import Purchases Excel</h4>
        <div class="stack">
          <label class="btn">
            <input type="file" id="purchaseExcelFile" accept=".xlsx,.xls" style="display:none">
            Upload Purchases Sheet
          </label>
          <button class="btn ok" id="btnProcessPurchaseSheet">Process Purchases</button>
        </div>
        
        <div class="grid-3" style="margin-top:12px;">
          <div>
            <label>Purchase Date</label>
            <input type="date" id="purchaseSheetDate" value="">
          </div>
          <div>
            <label>Supplier</label>
            <input type="text" id="purchaseSheetSupplier" placeholder="Supplier name">
          </div>
        </div>
        
        <p class="help">Upload purchases sheet to automatically update inventory and record purchases.</p>
        
        <div class="hr"></div>
        
        <h4>Import Log</h4>
        <div style="max-height:200px;overflow-y:auto;border:1px solid var(--line);border-radius:8px;padding:12px;background:#f8fafc;">
          <pre id="importLog" style="margin:0;font-size:12px;white-space:pre-wrap;">No import activity yet.</pre>
        </div>
      </div>
    </section>

    <!-- Data -->
    <section id="data" class="tabpanel" style="display:none;">
      <div class="row">
        <!-- Backup / Restore -->
        <div class="card" style="grid-column: span 4;">
          <h3>Backup / Restore (Local JSON)</h3>
          <div class="stack section-tools">
            <button class="btn primary" id="btnBackup">Export JSON</button>
            <label class="btn">
              <input type="file" id="restoreFile" accept="application/json" style="display:none">
              Import JSON
            </label>
            <button class="btn" id="btnSaveNow">Save Now</button>
          </div>
          <div class="stat" style="margin-top:12px;">
            <span class="muted">Last Saved</span>
            <b id="lastSaveTime">Never</b>
          </div>
          <p class="help">Exports all daily sheets, products, purchases and expenses to a JSON file.</p>
        </div>

        <!-- Excel Export -->
        <div class="card" style="grid-column: span 4;">
          <h3>Excel Export</h3>
          <div class="stack section-tools">
            <button class="btn" id="btnExportAllData">Export All Data</button>
            <button class="btn" id="btnExportProfitLoss">Export P&L Report</button>
            <button class="btn" id="btnExportPurchases">Export Purchases</button>
          </div>
          
          <div class="grid-2" style="margin-top:12px; gap:8px;">
            <div>
              <label>Export From</label>
              <input type="date" id="exportFrom">
            </div>
            <div>
              <label>Export To</label>
              <input type="date" id="exportTo">
            </div>
          </div>
          
          <p class="help">Export data for specific date ranges.</p>
        </div>

        <!-- Google Drive Sync -->
        <div class="card" style="grid-column: span 4;">
          <h3>Google Drive Sync</h3>
          <div class="stack section-tools">
            <button class="btn" id="btnGSignIn">Sign in with Google</button>
            <button class="btn primary" id="btnCloudSave" disabled>Save to Drive</button>
            <button class="btn" id="btnCloudLoad" disabled>Load from Drive</button>
          </div>
          
          <div class="stack" style="margin-top:12px;">
            <span id="cloudStatus" class="pill">Signed out</span>
            <span id="cloudFileInfo" class="muted"></span>
          </div>
          
          <div class="stat" style="margin-top:12px;">
            <span class="muted">Last Cloud Backup</span>
            <b id="lastCloudBackup">Never</b>
          </div>
        </div>
      </div>

      <div class="row" style="margin-top:16px;">
        <!-- Danger Zone -->
        <div class="card" style="grid-column: span 12;">
          <h3 style="color: var(--bad);">Danger Zone</h3>
          <div class="warnmsg">
            <strong>Warning:</strong> These actions are irreversible. Make sure you have a backup.
          </div>
          <div class="stack" style="margin-top:16px;">
            <button class="btn bad" id="btnWipe">Reset ALL Data</button>
            <button class="btn bad" id="btnClearSheets">Clear All Daily Sheets</button>
            <button class="btn bad" id="btnClearPurchases">Clear All Purchases</button>
            <button class="btn bad" id="btnClearExpenses">Clear All Expenses</button>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- Loading Modal -->
  <div id="loading" class="loading">
    <div class="loading-spinner"></div>
    <p>Processing Excel files...</p>
  </div>

<script>
// ================ UTILITY FUNCTIONS ================
const UGX = (v) => new Intl.NumberFormat('en-UG', {
  style: 'currency',
  currency: 'UGX',
  maximumFractionDigits: 0
}).format(v || 0);

const todayStr = () => {
  const now = new Date();
  const year = now.getFullYear();
  const month = String(now.getMonth() + 1).padStart(2, '0');
  const day = String(now.getDate()).padStart(2, '0');
  return `${year}-${month}-${day}`;
};

function download(filename, blob) {
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  setTimeout(() => URL.revokeObjectURL(a.href), 1000);
}

function showLoading(show) {
  document.getElementById('loading').style.display = show ? 'flex' : 'none';
}

function logImport(message) {
  const logEl = document.getElementById('importLog');
  const timestamp = new Date().toLocaleTimeString();
  const logMessage = `[${timestamp}] ${message}`;
  
  if (logEl) logEl.textContent = logMessage + '\n' + logEl.textContent;
}

// ================ ENHANCED DATA MANAGEMENT ================
const STORAGE_KEY = 'bar_management_enhanced_v3';
let db = {
  // Products from the Excel sheet
  products: [],
  // Daily sheets - each with unique date
  dailySheets: {}, // key: date, value: { date, items: [], totalSales, totalProfit }
  // Purchases - new section
  purchases: [], // { id, date, supplier, invoice, items: [], total, recordedAt }
  // Expenses
  expenses: [], // { date, type, description, amount }
  // Settings
  settings: { 
    lastSave: new Date().toISOString(),
    accountingPeriod: 'monthly', // monthly, weekly, custom
    periodStart: todayStr().substring(0, 7) + '-01', // First day of current month
    periodEnd: todayStr()
  }
};

// Load saved data
try {
  const saved = localStorage.getItem(STORAGE_KEY);
  if (saved) {
    db = JSON.parse(saved);
  }
} catch (e) {
  console.error('Error loading saved data:', e);
}

function saveData() {
  try {
    db.settings.lastSave = new Date().toISOString();
    localStorage.setItem(STORAGE_KEY, JSON.stringify(db));
    updateLastSaveTime();
    return true;
  } catch (e) {
    console.error('Error saving data:', e);
    return false;
  }
}

function updateLastSaveTime() {
  const lastSaveEl = document.getElementById('lastSaveTime');
  if (lastSaveEl && db.settings.lastSave) {
    const lastSave = new Date(db.settings.lastSave);
    lastSaveEl.textContent = lastSave.toLocaleDateString() + ' ' + lastSave.toLocaleTimeString();
  }
}

// Initialize products from the Excel sheet data
function initializeProductsFromExcel() {
  // This is the data from the provided Excel sheet
  const excelProducts = [
    { name: "NILE", category: "beer", purchasePrice: 3100, salePrice: 5100, openingStock: 10 },
    { name: "LITE", category: "beer", purchasePrice: 3100, salePrice: 5100, openingStock: 10 },
    { name: "MALT", category: "beer", purchasePrice: 3100, salePrice: 5100, openingStock: 10 },
    { name: "CLUB", category: "beer", purchasePrice: 3100, salePrice: 5100, openingStock: 10 },
    { name: "BELL", category: "beer", purchasePrice: 3100, salePrice: 5100, openingStock: 10 },
    { name: "GUINESS SMALL", category: "beer", purchasePrice: 3100, salePrice: 5100, openingStock: 10 },
    { name: "GUINESS BIG", category: "beer", purchasePrice: 3100, salePrice: 5100, openingStock: 10 },
    { name: "SIRMINOFF", category: "beer", purchasePrice: 3100, salePrice: 5100, openingStock: 10 },
    { name: "T.LAGER", category: "beer", purchasePrice: 3100, salePrice: 5100, openingStock: 10 },
    { name: "EAGLE", category: "beer", purchasePrice: 3100, salePrice: 5100, openingStock: 10 },
    { name: "T.CIDER", category: "beer", purchasePrice: 3100, salePrice: 5100, openingStock: 10 },
    { name: "PILSNER", category: "beer", purchasePrice: 3100, salePrice: 5100, openingStock: 10 },
    { name: "SODA", category: "Soft Drink", purchasePrice: 1000, salePrice: 2000, openingStock: 10 },
    { name: "POWER PLAY", category: "Energy Drink", purchasePrice: 1000, salePrice: 2000, openingStock: 10 },
    { name: "PREDATOR", category: "Energy Drink", purchasePrice: 1000, salePrice: 2000, openingStock: 10 },
    { name: "ROCK BOOM", category: "Energy Drink", purchasePrice: 1000, salePrice: 2000, openingStock: 10 },
    { name: "STING", category: "Energy Drink", purchasePrice: 1000, salePrice: 2000, openingStock: 10 },
    { name: "RWENZORI", category: "Soft Drink", purchasePrice: 600, salePrice: 1000, openingStock: 10 },
    { name: "YACKET", category: "Soft Drink", purchasePrice: 416, salePrice: 1000, openingStock: 10 },
    { name: "MINUTE MAID", category: "Soft Drink", purchasePrice: 1000, salePrice: 2000, openingStock: 10 },
    { name: "ONER", category: "Soft Drink", purchasePrice: 1000, salePrice: 2000, openingStock: 10 },
    { name: "UG Big", category: "Spirit", purchasePrice: 2000, salePrice: 3000, openingStock: 10 },
    { name: "ug1/2", category: "Spirit", purchasePrice: 2000, salePrice: 3000, openingStock: 10 },
    { name: "Ug1/4", category: "Spirit", purchasePrice: 2000, salePrice: 3000, openingStock: 10 },
    { name: "Ug Plastic", category: "Spirit", purchasePrice: 2000, salePrice: 3000, openingStock: 10 },
    { name: "V&A BIG", category: "Spirit", purchasePrice: 2000, salePrice: 3000, openingStock: 10 },
    { name: "V&A 1/4", category: "Spirit", purchasePrice: 2000, salePrice: 3000, openingStock: 10 },
    { name: "FOUR COUSINS", category: "wine", purchasePrice: 2000, salePrice: 3000, openingStock: 10 },
    { name: "BLACK & WHITE", category: "wine", purchasePrice: 2000, salePrice: 3000, openingStock: 10 },
    { name: "Bond 7 ( 1/4)", category: "Spirit", purchasePrice: 2000, salePrice: 3000, openingStock: 10 },
    { name: "Bond 7 Big", category: "Spirit", purchasePrice: 2000, salePrice: 3000, openingStock: 10 },
    { name: "Gilbeys 1/4", category: "Spirit", purchasePrice: 2000, salePrice: 3000, openingStock: 10 },
    { name: "Red Bull", category: "Energy Drink", purchasePrice: 2000, salePrice: 3000, openingStock: 10 },
    { name: "Guiness Smooth", category: "beer", purchasePrice: 2000, salePrice: 3000, openingStock: 10 },
    { name: "Amalula", category: "wine", purchasePrice: 2000, salePrice: 3000, openingStock: 10 },
    { name: "Grands", category: "wine", purchasePrice: 2000, salePrice: 3000, openingStock: 10 },
    { name: "Ondavit", category: "wine", purchasePrice: 2000, salePrice: 3000, openingStock: 10 },
    { name: "C.Morgan", category: "wine", purchasePrice: 2000, salePrice: 3000, openingStock: 10 },
    { name: "Scout", category: "wine", purchasePrice: 2000, salePrice: 3000, openingStock: 10 },
    { name: "Antonious", category: "wine", purchasePrice: 2000, salePrice: 3000, openingStock: 10 },
    { name: "Robertson", category: "wine", purchasePrice: 2000, salePrice: 3000, openingStock: 10 },
    { name: "Ballanties", category: "wine", purchasePrice: 2000, salePrice: 3000, openingStock: 10 },
    { name: "Singleton", category: "wine", purchasePrice: 2000, salePrice: 3000, openingStock: 10 },
    { name: "Jameson", category: "wine", purchasePrice: 2000, salePrice: 3000, openingStock: 10 },
    { name: "Famous Grouse", category: "wine", purchasePrice: 2000, salePrice: 3000, openingStock: 10 },
    { name: "J.P Chente", category: "wine", purchasePrice: 2000, salePrice: 3000, openingStock: 10 },
    { name: "Baileys", category: "wine", purchasePrice: 2000, salePrice: 3000, openingStock: 10 },
    { name: "8PM", category: "wine", purchasePrice: 2000, salePrice: 3000, openingStock: 10 },
    { name: "GIlbeys BIG", category: "Spirit", purchasePrice: 2000, salePrice: 3000, openingStock: 10 },
    { name: "Castle Lite", category: "beer", purchasePrice: 2000, salePrice: 3000, openingStock: 10 },
    { name: "Can of Guinness", category: "beer", purchasePrice: 2000, salePrice: 3000, openingStock: 10 },
    { name: "Doprick", category: "wine", purchasePrice: 2000, salePrice: 3000, openingStock: 10 },
    { name: "High 5", category: "Spirit", purchasePrice: 2000, salePrice: 3000, openingStock: 10 }
  ];
  
  // Only initialize if no products exist
  if (db.products.length === 0) {
    db.products = excelProducts.map((p, index) => ({
      id: 'prod_' + (index + 1),
      name: p.name,
      category: p.category,
      purchasePrice: p.purchasePrice,
      salePrice: p.salePrice,
      openingStock: p.openingStock,
      reorderLevel: 10,
      purchasedQuantity: 0, // Track purchased quantity separately
      soldCount: 0,
      totalProfit: 0,
      lastPurchaseDate: null,
      lastPurchasePrice: p.purchasePrice
    }));
    saveData();
  }
}

// ================ DASHBOARD FUNCTIONS ================
function updateDashboardStats() {
  // Total products
  document.getElementById('statProducts').textContent = db.products.length;
  
  // Stock value (based on purchase price)
  const stockValue = db.products.reduce((sum, p) => {
    const currentStock = calculateCurrentStock(p);
    return sum + currentStock * (p.purchasePrice || 0);
  }, 0);
  document.getElementById('statStockValue').textContent = UGX(stockValue);
  
  // Monthly purchases (calculate from purchases array)
  const currentMonth = todayStr().substring(0, 7); // YYYY-MM
  const monthlyPurchases = db.purchases.reduce((sum, purchase) => {
    if (purchase.date && purchase.date.substring(0, 7) === currentMonth) {
      return sum + (purchase.total || 0);
    }
    return sum;
  }, 0);
  document.getElementById('statMonthPurchases').textContent = UGX(monthlyPurchases);
  
  // Most moving category
  const categorySales = {};
  Object.values(db.dailySheets).forEach(sheet => {
    sheet.items.forEach(item => {
      const product = db.products.find(p => p.name === item.productName);
      if (product) {
        const cat = product.category || 'other';
        categorySales[cat] = (categorySales[cat] || 0) + item.quantity;
      }
    });
  });
  
  let mostMovingCategory = '-';
  let maxSales = 0;
  for (const [category, sales] of Object.entries(categorySales)) {
    if (sales > maxSales) {
      maxSales = sales;
      mostMovingCategory = category;
    }
  }
  document.getElementById('statMostMoving').textContent = mostMovingCategory;
  
  // Calculate profits for the accounting period
  const periodStart = db.settings.periodStart || todayStr().substring(0, 7) + '-01';
  const periodEnd = db.settings.periodEnd || todayStr();
  
  let grossProfit = 0;
  let totalExpenses = 0;
  let totalPurchases = 0;
  
  // Calculate gross profit from daily sheets
  Object.values(db.dailySheets).forEach(sheet => {
    if (sheet.date >= periodStart && sheet.date <= periodEnd) {
      grossProfit += sheet.totalProfit || 0;
    }
  });
  
  // Calculate total purchases for period
  db.purchases.forEach(purchase => {
    if (purchase.date >= periodStart && purchase.date <= periodEnd) {
      totalPurchases += purchase.total || 0;
    }
  });
  
  // Calculate total expenses for period
  db.expenses.forEach(expense => {
    if (expense.date >= periodStart && expense.date <= periodEnd) {
      totalExpenses += expense.amount || 0;
    }
  });
  
  const netProfit = grossProfit - totalExpenses - totalPurchases;
  
  document.getElementById('statGrossProfit').textContent = UGX(grossProfit);
  document.getElementById('statTotalExpenses').textContent = UGX(totalExpenses);
  document.getElementById('statNetProfit').textContent = UGX(netProfit);
  
  // Update profitability status
  const profitStatusEl = document.getElementById('profitStatus');
  const profitStatusCard = document.getElementById('profitStatusCard');
  
  if (netProfit > 0) {
    profitStatusEl.innerHTML = `<strong>✅ PROFITABLE:</strong> Business is making a net profit of ${UGX(netProfit)}`;
    profitStatusEl.className = 'goodmsg';
    profitStatusCard.style.borderLeft = '4px solid #16a34a';
  } else if (netProfit < 0) {
    profitStatusEl.innerHTML = `<strong>⚠️ LOSS MAKING:</strong> Business is making a net loss of ${UGX(Math.abs(netProfit))}`;
    profitStatusEl.className = 'badmsg';
    profitStatusCard.style.borderLeft = '4px solid #ef4444';
  } else {
    profitStatusEl.innerHTML = `<strong>⚖️ BREAK EVEN:</strong> Business is breaking even`;
    profitStatusEl.className = 'warnmsg';
    profitStatusCard.style.borderLeft = '4px solid #f59e0b';
  }
}

// ================ TAB MANAGEMENT ================
function setupTabs() {
  const tabs = document.querySelectorAll('.tab');
  const panels = document.querySelectorAll('.tabpanel');
  
  tabs.forEach(tab => {
    tab.addEventListener('click', () => {
      // Remove active class from all tabs
      tabs.forEach(t => t.classList.remove('active'));
      // Hide all panels
      panels.forEach(p => p.style.display = 'none');
      
      // Add active class to clicked tab
      tab.classList.add('active');
      // Show corresponding panel
      const tabId = tab.getAttribute('data-tab');
      const panel = document.getElementById(tabId);
      if (panel) {
        panel.style.display = 'block';
        
        // Initialize panel if needed
        if (tabId === 'products') renderProducts();
        if (tabId === 'sales') renderSales();
        if (tabId === 'purchases') renderPurchases();
        if (tabId === 'inventory') renderInventory();
        if (tabId === 'expenses') renderExpenses();
        if (tabId === 'reports') initReports();
        if (tabId === 'automation') renderAutomation();
        if (tabId === 'data') renderDataSection();
      }
    });
  });
}

// ================ PRODUCTS MANAGEMENT ================
let editingProductId = null;

// Calculate current stock for a product
function calculateCurrentStock(product) {
  const openingStock = product.openingStock || 0;
  const purchased = product.purchasedQuantity || 0;
  const sold = product.soldCount || 0;
  return Math.max(0, openingStock + purchased - sold);
}

function renderProducts() {
  const searchTerm = document.getElementById('productSearch').value.toLowerCase();
  const sortBy = document.getElementById('productSort').value;
  
  let filtered = [...db.products];
  
  if (searchTerm) {
    filtered = filtered.filter(p => 
      p.name.toLowerCase().includes(searchTerm) || 
      (p.category || '').toLowerCase().includes(searchTerm)
    );
  }
  
  // Filter by reorder needs
  if (sortBy === 'needReorder') {
    filtered = filtered.filter(p => {
      const currentStock = calculateCurrentStock(p);
      return currentStock <= (p.reorderLevel || 10);
    });
  }
  
  // Sort products
  filtered.sort((a, b) => {
    if (sortBy === 'name') return a.name.localeCompare(b.name);
    if (sortBy === 'category') return (a.category || '').localeCompare(b.category || '');
    if (sortBy === 'stock') return calculateCurrentStock(b) - calculateCurrentStock(a);
    if (sortBy === 'profit') {
      const marginA = (a.salePrice - a.purchasePrice) / a.purchasePrice * 100;
      const marginB = (b.salePrice - b.purchasePrice) / b.purchasePrice * 100;
      return marginB - marginA;
    }
    return 0;
  });
  
  const tbody = document.querySelector('#productsTable tbody');
  if (tbody) {
    tbody.innerHTML = filtered.map(p => {
      const profitMargin = p.purchasePrice > 0 ? 
        ((p.salePrice - p.purchasePrice) / p.purchasePrice * 100).toFixed(1) : 0;
      const currentStock = calculateCurrentStock(p);
      const needsReorder = currentStock <= (p.reorderLevel || 10);
      
      return `
      <tr ${needsReorder ? 'style="background:#fff7ed"' : ''}>
        <td><strong>${p.name}</strong> ${needsReorder ? '⚠️' : ''}</td>
        <td><span class="pill">${p.category || 'other'}</span></td>
        <td>${UGX(p.purchasePrice || 0)}</td>
        <td>${UGX(p.salePrice || 0)}</td>
        <td>${profitMargin}%</td>
        <td>${p.openingStock || 0}</td>
        <td>${p.purchasedQuantity || 0}</td>
        <td>${p.soldCount || 0}</td>
        <td><strong>${currentStock}</strong></td>
        <td><button class="btn" data-edit="${p.id}">Edit</button></td>
      </tr>
      `;
    }).join('');
  }
  
  // Populate product selects
  populateProductSelects();
}

function populateProductSelects() {
  const saleSelect = document.getElementById('saleProduct');
  const purchaseSelect = document.getElementById('purchaseProduct');
  const historySelect = document.getElementById('productHistorySelect');
  const analysisSelect = document.getElementById('purchaseAnalysisProduct');
  
  if (saleSelect) {
    saleSelect.innerHTML = '<option value="">Select Product</option>' +
      db.products.map(p => {
        const currentStock = calculateCurrentStock(p);
        return `<option value="${p.id}" data-price="${p.salePrice}">${p.name} (Stock: ${currentStock})</option>`;
      }).join('');
  }
  
  if (purchaseSelect) {
    purchaseSelect.innerHTML = '<option value="">Select Product</option>' +
      db.products.map(p => {
        const currentStock = calculateCurrentStock(p);
        const needsReorder = currentStock <= (p.reorderLevel || 10);
        return `<option value="${p.id}" data-cost="${p.purchasePrice}">${p.name} ${needsReorder ? '⚠️' : ''} (Stock: ${currentStock})</option>`;
      }).join('');
  }
  
  if (historySelect) {
    historySelect.innerHTML = '<option value="">Select Product</option>' +
      db.products.map(p => 
        `<option value="${p.id}">${p.name}</option>`
      ).join('');
  }
  
  if (analysisSelect) {
    analysisSelect.innerHTML = '<option value="">All Products</option>' +
      db.products.map(p => 
        `<option value="${p.id}">${p.name}</option>`
      ).join('');
  }
}

function setupProducts() {
  // Edit product
  document.getElementById('productsTable').addEventListener('click', (e) => {
    const editBtn = e.target.closest('[data-edit]');
    if (!editBtn) return;
    
    const productId = editBtn.getAttribute('data-edit');
    const product = db.products.find(p => p.id === productId);
    if (!product) return;
    
    editingProductId = productId;
    document.getElementById('productName').value = product.name;
    document.getElementById('productCategory').value = product.category || 'beer';
    document.getElementById('productCost').value = product.purchasePrice || 0;
    document.getElementById('productPrice').value = product.salePrice || 0;
    document.getElementById('productOpeningStock').value = product.openingStock || 0;
    document.getElementById('productReorderLevel').value = product.reorderLevel || 10;
    document.getElementById('btnDeleteProduct').disabled = false;
  });
  
  // Save product
  document.getElementById('btnSaveProduct').addEventListener('click', () => {
    const name = document.getElementById('productName').value.trim();
    if (!name) {
      alert('Please enter product name');
      return;
    }
    
    const category = document.getElementById('productCategory').value;
    const purchasePrice = parseInt(document.getElementById('productCost').value) || 0;
    const salePrice = parseInt(document.getElementById('productPrice').value) || 0;
    const openingStock = parseInt(document.getElementById('productOpeningStock').value) || 0;
    const reorderLevel = parseInt(document.getElementById('productReorderLevel').value) || 10;
    
    if (editingProductId) {
      // Update existing product
      const product = db.products.find(p => p.id === editingProductId);
      if (product) {
        product.name = name;
        product.category = category;
        product.purchasePrice = purchasePrice;
        product.salePrice = salePrice;
        product.openingStock = openingStock;
        product.reorderLevel = reorderLevel;
      }
    } else {
      // Create new product
      const newProduct = {
        id: 'prod_' + Date.now(),
        name,
        category,
        purchasePrice,
        salePrice,
        openingStock,
        purchasedQuantity: 0,
        soldCount: 0,
        totalProfit: 0,
        reorderLevel,
        lastPurchaseDate: null,
        lastPurchasePrice: purchasePrice
      };
      db.products.push(newProduct);
    }
    
    saveData();
    renderProducts();
    updateDashboardStats();
    populateProductSelects();
    
    // Reset form
    document.getElementById('productName').value = '';
    document.getElementById('productCost').value = '0';
    document.getElementById('productPrice').value = '0';
    document.getElementById('productOpeningStock').value = '0';
    document.getElementById('productReorderLevel').value = '10';
    document.getElementById('btnDeleteProduct').disabled = true;
    editingProductId = null;
    
    alert('Product saved successfully!');
  });
  
  // Delete product
  document.getElementById('btnDeleteProduct').addEventListener('click', () => {
    if (!editingProductId || !confirm('Are you sure you want to delete this product?')) {
      return;
    }
    
    db.products = db.products.filter(p => p.id !== editingProductId);
    saveData();
    renderProducts();
    updateDashboardStats();
    populateProductSelects();
    
    // Reset form
    document.getElementById('productName').value = '';
    document.getElementById('productCost').value = '0';
    document.getElementById('productPrice').value = '0';
    document.getElementById('productOpeningStock').value = '0';
    document.getElementById('productReorderLevel').value = '10';
    document.getElementById('btnDeleteProduct').disabled = true;
    editingProductId = null;
    
    alert('Product deleted successfully!');
  });
  
  // Search products
  document.getElementById('productSearch').addEventListener('input', renderProducts);
  document.getElementById('productSort').addEventListener('change', renderProducts);
}

// ================ PURCHASES MANAGEMENT - NEW ================
let purchaseItems = [];

function renderPurchases() {
  const today = todayStr();
  document.getElementById('purchaseDate').value = today;
  document.getElementById('purchaseFrom').value = today;
  document.getElementById('purchaseTo').value = today;
  document.getElementById('purchaseAnalysisFrom').value = today;
  document.getElementById('purchaseAnalysisTo').value = today;
  document.getElementById('purchaseSheetDate').value = today;
  
  // Reset form
  purchaseItems = [];
  document.getElementById('purchaseSupplier').value = '';
  document.getElementById('purchaseInvoice').value = '';
  document.getElementById('purchaseQty').value = '1';
  document.getElementById('purchaseCost').value = '';
  updatePurchaseTotal();
  
  // Load recent purchases
  loadRecentPurchases();
  updatePurchaseAnalysis();
}

function updatePurchaseTotal() {
  const total = purchaseItems.reduce((sum, item) => sum + (item.totalCost || 0), 0);
  document.getElementById('purchaseTotal').textContent = UGX(total);
  
  const tbody = document.querySelector('#purchaseItemsTable tbody');
  if (tbody) {
    tbody.innerHTML = purchaseItems.map((item, index) => {
      return `
      <tr>
        <td>${item.productName}</td>
        <td>${item.quantity}</td>
        <td>${UGX(item.unitCost)}</td>
        <td>${UGX(item.totalCost)}</td>
        <td><button class="btn bad" data-remove-purchase="${index}">×</button></td>
      </tr>
      `;
    }).join('');
  }
}

function loadRecentPurchases() {
  const from = document.getElementById('purchaseFrom').value || todayStr();
  const to = document.getElementById('purchaseTo').value || todayStr();
  
  // Filter purchases by date range
  const filteredPurchases = db.purchases.filter(p => 
    p.date >= from && p.date <= to
  ).sort((a, b) => new Date(b.date) - new Date(a.date));
  
  const tbody = document.querySelector('#purchasesTable tbody');
  if (tbody) {
    tbody.innerHTML = filteredPurchases.map((purchase, index) => {
      const itemCount = purchase.items?.length || 0;
      return `
      <tr>
        <td>${purchase.date}</td>
        <td>${purchase.supplier || 'N/A'}</td>
        <td>${itemCount} items</td>
        <td>${UGX(purchase.total || 0)}</td>
        <td><button class="btn" data-view-purchase="${index}">View</button></td>
      </tr>
      `;
    }).join('');
  }
  
  // Update total purchases
  const totalPurchases = filteredPurchases.reduce((sum, p) => sum + (p.total || 0), 0);
  document.getElementById('totalPurchases').textContent = UGX(totalPurchases);
}

function updatePurchaseAnalysis() {
  const productId = document.getElementById('purchaseAnalysisProduct').value;
  const from = document.getElementById('purchaseAnalysisFrom').value || todayStr();
  const to = document.getElementById('purchaseAnalysisTo').value || todayStr();
  
  // Filter purchases
  let relevantPurchases = db.purchases.filter(p => p.date >= from && p.date <= to);
  
  if (productId) {
    const product = db.products.find(p => p.id === productId);
    if (product) {
      relevantPurchases = relevantPurchases.filter(p => 
        p.items.some(item => item.productName === product.name)
      );
    }
  }
  
  // Calculate analysis
  let totalValue = 0;
  let totalQuantity = 0;
  const productAnalysis = {};
  
  relevantPurchases.forEach(purchase => {
    purchase.items.forEach(item => {
      if (!productId || item.productName === db.products.find(p => p.id === productId)?.name) {
        totalValue += item.totalCost;
        totalQuantity += item.quantity;
        
        if (!productAnalysis[item.productName]) {
          productAnalysis[item.productName] = {
            totalQuantity: 0,
            totalCost: 0,
            lastDate: purchase.date
          };
        }
        
        productAnalysis[item.productName].totalQuantity += item.quantity;
        productAnalysis[item.productName].totalCost += item.totalCost;
        productAnalysis[item.productName].lastDate = purchase.date;
      }
    });
  });
  
  const avgCost = totalQuantity > 0 ? totalValue / totalQuantity : 0;
  
  document.getElementById('analysisTotalValue').textContent = UGX(totalValue);
  document.getElementById('analysisAvgCost').textContent = UGX(avgCost);
  document.getElementById('analysisReorderFreq').textContent = relevantPurchases.length > 0 ? 
    `${relevantPurchases.length} purchases` : '-';
  
  // Update analysis table
  const tbody = document.querySelector('#purchaseAnalysisTable tbody');
  if (tbody) {
    tbody.innerHTML = Object.entries(productAnalysis).map(([productName, data]) => {
      const avgUnitCost = data.totalQuantity > 0 ? data.totalCost / data.totalQuantity : 0;
      return `
      <tr>
        <td>${productName}</td>
        <td>${data.totalQuantity}</td>
        <td>${UGX(data.totalCost)}</td>
        <td>${UGX(avgUnitCost)}</td>
        <td>${data.lastDate}</td>
      </tr>
      `;
    }).join('');
  }
}

function setupPurchases() {
  // Auto-fill cost when product selected
  document.getElementById('purchaseProduct').addEventListener('change', function() {
    const selectedOption = this.options[this.selectedIndex];
    if (selectedOption && selectedOption.value) {
      const purchaseCost = selectedOption.getAttribute('data-cost');
      document.getElementById('purchaseCost').value = purchaseCost || '';
    }
  });
  
  // Add purchase item
  document.getElementById('btnAddPurchaseItem').addEventListener('click', () => {
    const productId = document.getElementById('purchaseProduct').value;
    const quantity = parseInt(document.getElementById('purchaseQty').value) || 1;
    const unitCost = parseInt(document.getElementById('purchaseCost').value) || 0;
    
    if (!productId) {
      alert('Please select a product');
      return;
    }
    if (quantity <= 0) {
      alert('Please enter a valid quantity');
      return;
    }
    if (unitCost <= 0) {
      alert('Please enter a valid cost');
      return;
    }
    
    const product = db.products.find(p => p.id === productId);
    if (!product) {
      alert('Product not found');
      return;
    }
    
    const totalCost = quantity * unitCost;
    
    purchaseItems.push({
      productId,
      productName: product.name,
      quantity,
      unitCost,
      totalCost
    });
    
    updatePurchaseTotal();
    
    // Reset form
    document.getElementById('purchaseQty').value = '1';
    document.getElementById('purchaseCost').value = '';
  });
  
  // Remove purchase item
  document.getElementById('purchaseItemsTable').addEventListener('click', (e) => {
    const removeBtn = e.target.closest('[data-remove-purchase]');
    if (!removeBtn) return;
    
    const index = parseInt(removeBtn.getAttribute('data-remove-purchase'));
    purchaseItems.splice(index, 1);
    updatePurchaseTotal();
  });
  
  // Save purchase
  document.getElementById('btnSavePurchase').addEventListener('click', () => {
    if (purchaseItems.length === 0) {
      alert('Please add items to the purchase');
      return;
    }
    
    const date = document.getElementById('purchaseDate').value || todayStr();
    const supplier = document.getElementById('purchaseSupplier').value.trim();
    const invoice = document.getElementById('purchaseInvoice').value.trim();
    
    if (!supplier) {
      alert('Please enter supplier name');
      return;
    }
    
    const total = purchaseItems.reduce((sum, item) => sum + item.totalCost, 0);
    
    // Update product stocks and purchase counts
    purchaseItems.forEach(item => {
      const product = db.products.find(p => p.id === item.productId);
      if (product) {
        product.purchasedQuantity = (product.purchasedQuantity || 0) + item.quantity;
        product.lastPurchaseDate = date;
        product.lastPurchasePrice = item.unitCost;
        
        // Update purchase price if different
        if (item.unitCost !== product.purchasePrice) {
          product.purchasePrice = item.unitCost;
        }
      }
    });
    
    // Save purchase record
    const newPurchase = {
      id: 'pur_' + Date.now(),
      date,
      supplier,
      invoice: invoice || null,
      items: [...purchaseItems],
      total,
      recordedAt: new Date().toISOString()
    };
    
    db.purchases.push(newPurchase);
    saveData();
    
    // Refresh display
    renderPurchases();
    renderProducts();
    renderInventory();
    updateDashboardStats();
    
    alert(`Purchase saved for ${date}! Total: ${UGX(total)}`);
  });
  
  // Filter purchases
  document.getElementById('btnFilterPurchases').addEventListener('click', loadRecentPurchases);
  
  // View purchase details
  document.getElementById('purchasesTable').addEventListener('click', (e) => {
    const viewBtn = e.target.closest('[data-view-purchase]');
    if (!viewBtn) return;
    
    const index = parseInt(viewBtn.getAttribute('data-view-purchase'));
    const purchase = db.purchases[index];
    
    if (purchase) {
      let details = `Purchase Date: ${purchase.date}\n`;
      details += `Supplier: ${purchase.supplier}\n`;
      details += `Invoice: ${purchase.invoice || 'N/A'}\n\n`;
      details += 'Items:\n';
      purchase.items.forEach(item => {
        details += `- ${item.productName}: ${item.quantity} × ${UGX(item.unitCost)} = ${UGX(item.totalCost)}\n`;
      });
      details += `\nTotal: ${UGX(purchase.total)}`;
      
      alert(details);
    }
  });
  
  // Purchase analysis
  document.getElementById('purchaseAnalysisProduct').addEventListener('change', updatePurchaseAnalysis);
  document.getElementById('purchaseAnalysisFrom').addEventListener('change', updatePurchaseAnalysis);
  document.getElementById('purchaseAnalysisTo').addEventListener('change', updatePurchaseAnalysis);
}

// ================ DAILY SALES MANAGEMENT ================
let dailySaleItems = [];

function renderSales() {
  const today = todayStr();
  document.getElementById('saleDate').value = today;
  document.getElementById('saleFrom').value = today;
  document.getElementById('saleTo').value = today;
  document.getElementById('productHistoryFrom').value = today;
  document.getElementById('productHistoryTo').value = today;
  document.getElementById('sheetDate').value = today;
  
  // Reset form
  dailySaleItems = [];
  document.getElementById('sheetReference').value = '';
  document.getElementById('saleQty').value = '1';
  document.getElementById('salePrice').value = '';
  updateDailySaleTotal();
  
  // Load recent sales
  loadRecentSales();
}

function updateDailySaleTotal() {
  const totalSales = dailySaleItems.reduce((sum, item) => sum + (item.total || 0), 0);
  const totalProfit = dailySaleItems.reduce((sum, item) => sum + (item.profit || 0), 0);
  
  document.getElementById('saleTotal').textContent = UGX(totalSales);
  document.getElementById('saleProfit').textContent = UGX(totalProfit);
  
  const tbody = document.querySelector('#saleItemsTable tbody');
  if (tbody) {
    tbody.innerHTML = dailySaleItems.map((item, index) => {
      return `
      <tr>
        <td>${item.productName}</td>
        <td>${item.quantity}</td>
        <td>${UGX(item.unitPrice)}</td>
        <td>${UGX(item.total)}</td>
        <td>${UGX(item.profit)}</td>
        <td><button class="btn bad" data-remove-sale="${index}">×</button></td>
      </tr>
      `;
    }).join('');
  }
}

function loadRecentSales() {
  const from = document.getElementById('saleFrom').value || todayStr();
  const to = document.getElementById('saleTo').value || todayStr();
  
  // Filter sheets by date range
  const filteredSheets = [];
  for (const [date, sheet] of Object.entries(db.dailySheets)) {
    if (date >= from && date <= to) {
      filteredSheets.push({ date, ...sheet });
    }
  }
  
  // Sort by date descending
  filteredSheets.sort((a, b) => new Date(b.date) - new Date(a.date));
  
  const tbody = document.querySelector('#salesHistoryTable tbody');
  if (tbody) {
    tbody.innerHTML = filteredSheets.map(sheet => {
      const itemCount = sheet.items?.length || 0;
      return `
      <tr>
        <td>${sheet.date}</td>
        <td>${itemCount} items</td>
        <td>${UGX(sheet.totalSales || 0)}</td>
        <td>${UGX(sheet.totalProfit || 0)}</td>
        <td>${sheet.source || 'manual'}</td>
      </tr>
      `;
    }).join('');
  }
}

function loadProductHistory() {
  const productId = document.getElementById('productHistorySelect').value;
  const from = document.getElementById('productHistoryFrom').value;
  const to = document.getElementById('productHistoryTo').value;
  
  if (!productId) return;
  
  const product = db.products.find(p => p.id === productId);
  if (!product) return;
  
  // Find all sales for this product in date range
  const productSales = [];
  for (const [date, sheet] of Object.entries(db.dailySheets)) {
    if (date >= from && date <= to) {
      const productItems = sheet.items.filter(item => item.productName === product.name);
      if (productItems.length > 0) {
        const totalQty = productItems.reduce((sum, item) => sum + item.quantity, 0);
        const totalSales = productItems.reduce((sum, item) => sum + item.total, 0);
        const totalProfit = productItems.reduce((sum, item) => sum + item.profit, 0);
        const avgPrice = totalQty > 0 ? totalSales / totalQty : 0;
        
        productSales.push({
          date,
          qty: totalQty,
          totalSales,
          totalProfit,
          avgPrice
        });
      }
    }
  }
  
  // Sort by date
  productSales.sort((a, b) => new Date(b.date) - new Date(a.date));
  
  const tbody = document.querySelector('#productHistoryTable tbody');
  if (tbody) {
    tbody.innerHTML = productSales.map(sale => `
      <tr>
        <td>${sale.date}</td>
        <td>${sale.qty}</td>
        <td>${UGX(sale.totalSales)}</td>
        <td>${UGX(sale.totalProfit)}</td>
        <td>${UGX(sale.avgPrice)}</td>
      </tr>
    `).join('');
  }
}

function setupSales() {
  // Auto-fill price when product selected
  document.getElementById('saleProduct').addEventListener('change', function() {
    const selectedOption = this.options[this.selectedIndex];
    if (selectedOption && selectedOption.value) {
      const salePrice = selectedOption.getAttribute('data-price');
      document.getElementById('salePrice').value = salePrice || '';
    }
  });
  
  // Add sale item
  document.getElementById('btnAddSaleItem').addEventListener('click', () => {
    const productId = document.getElementById('saleProduct').value;
    const quantity = parseInt(document.getElementById('saleQty').value) || 1;
    const unitPrice = parseInt(document.getElementById('salePrice').value) || 0;
    
    if (!productId) {
      alert('Please select a product');
      return;
    }
    if (quantity <= 0) {
      alert('Please enter a valid quantity');
      return;
    }
    if (unitPrice <= 0) {
      alert('Please enter a valid price');
      return;
    }
    
    const product = db.products.find(p => p.id === productId);
    if (!product) {
      alert('Product not found');
      return;
    }
    
    // Check stock
    const currentStock = calculateCurrentStock(product);
    if (currentStock < quantity) {
      if (!confirm(`Only ${currentStock} items in stock. Continue anyway?`)) {
        return;
      }
    }
    
    const total = quantity * unitPrice;
    const profit = quantity * (unitPrice - product.purchasePrice);
    
    dailySaleItems.push({
      productId,
      productName: product.name,
      quantity,
      unitPrice,
      total,
      profit
    });
    
    updateDailySaleTotal();
    
    // Reset form
    document.getElementById('saleQty').value = '1';
    document.getElementById('salePrice').value = '';
  });
  
  // Remove sale item
  document.getElementById('saleItemsTable').addEventListener('click', (e) => {
    const removeBtn = e.target.closest('[data-remove-sale]');
    if (!removeBtn) return;
    
    const index = parseInt(removeBtn.getAttribute('data-remove-sale'));
    dailySaleItems.splice(index, 1);
    updateDailySaleTotal();
  });
  
  // Save daily sales
  document.getElementById('btnSaveDailySales').addEventListener('click', () => {
    if (dailySaleItems.length === 0) {
      alert('Please add items to the daily sales');
      return;
    }
    
    const date = document.getElementById('saleDate').value || todayStr();
    const sheetReference = document.getElementById('sheetReference').value.trim() || 'manual';
    const recordType = document.getElementById('recordType').value;
    
    // Check if sheet for this date already exists
    const existingSheet = db.dailySheets[date];
    if (existingSheet && !confirm(`Sheet already exists for ${date}. Overwrite?`)) {
      return;
    }
    
    // Calculate totals
    const totalSales = dailySaleItems.reduce((sum, item) => sum + item.total, 0);
    const totalProfit = dailySaleItems.reduce((sum, item) => sum + item.profit, 0);
    
    // Update product stocks and counts
    dailySaleItems.forEach(item => {
      const product = db.products.find(p => p.id === item.productId);
      if (product) {
        product.soldCount = (product.soldCount || 0) + item.quantity;
        product.totalProfit = (product.totalProfit || 0) + item.profit;
      }
    });
    
    // Save daily sheet
    db.dailySheets[date] = {
      date,
      items: [...dailySaleItems],
      totalSales,
      totalProfit,
      source: recordType === 'excel' ? 'excel' : 'manual',
      sheetReference,
      recordedAt: new Date().toISOString()
    };
    
    saveData();
    
    // Refresh display
    renderSales();
    renderProducts();
    renderInventory();
    updateDashboardStats();
    
    alert(`Daily sales saved for ${date}! Total: ${UGX(totalSales)}, Profit: ${UGX(totalProfit)}`);
  });
  
  // Filter sales
  document.getElementById('btnFilterSales').addEventListener('click', loadRecentSales);
  
  // Product history
  document.getElementById('productHistorySelect').addEventListener('change', loadProductHistory);
  document.getElementById('productHistoryFrom').addEventListener('change', loadProductHistory);
  document.getElementById('productHistoryTo').addEventListener('change', loadProductHistory);
}

// ================ INVENTORY MANAGEMENT ================
function renderInventory() {
  const date = document.getElementById('inventoryDate').value || todayStr();
  const category = document.getElementById('filterCategory').value;
  
  let filtered = db.products;
  if (category) {
    filtered = filtered.filter(p => p.category === category);
  }
  
  const tbody = document.querySelector('#inventoryTable tbody');
  if (tbody) {
    tbody.innerHTML = filtered.map(product => {
      // Calculate purchased up to date
      let totalPurchased = 0;
      let totalSold = 0;
      
      db.purchases.forEach(purchase => {
        if (purchase.date <= date) {
          const productItems = purchase.items.filter(item => item.productName === product.name);
          totalPurchased += productItems.reduce((sum, item) => sum + item.quantity, 0);
        }
      });
      
      for (const [sheetDate, sheet] of Object.entries(db.dailySheets)) {
        if (sheetDate <= date) {
          const productItems = sheet.items.filter(item => item.productName === product.name);
          totalSold += productItems.reduce((sum, item) => sum + item.quantity, 0);
        }
      }
      
      const openingStock = product.openingStock || 0;
      const currentStock = Math.max(0, openingStock + totalPurchased - totalSold);
      const stockValue = currentStock * (product.purchasePrice || 0);
      const needsReorder = currentStock <= (product.reorderLevel || 10);
      
      return `
      <tr ${needsReorder ? 'style="background:#fff7ed"' : ''}>
        <td><strong>${product.name}</strong> ${needsReorder ? '⚠️' : ''}</td>
        <td><span class="pill">${product.category || 'other'}</span></td>
        <td>${openingStock}</td>
        <td>${totalPurchased}</td>
        <td>${totalSold}</td>
        <td><strong>${currentStock}</strong></td>
        <td>${UGX(product.purchasePrice || 0)}</td>
        <td>${UGX(product.salePrice || 0)}</td>
        <td>${UGX(stockValue)}</td>
      </tr>
      `;
    }).join('');
  }
}

function setupInventory() {
  document.getElementById('inventoryDate').addEventListener('change', renderInventory);
  document.getElementById('filterCategory').addEventListener('change', renderInventory);
  document.getElementById('btnUpdateInventory').addEventListener('click', renderInventory);
}

// ================ EXPENSES MANAGEMENT ================
function renderExpenses() {
  const today = todayStr();
  document.getElementById('expenseDate').value = today;
  document.getElementById('expenseFrom').value = today;
  document.getElementById('expenseTo').value = today;
  
  // Reset form
  document.getElementById('expenseDescription').value = '';
  document.getElementById('expenseAmount').value = '0';
  
  // Load expenses
  loadExpenses();
}

function loadExpenses() {
  const from = document.getElementById('expenseFrom').value || todayStr();
  const to = document.getElementById('expenseTo').value || todayStr();
  
  const filtered = db.expenses.filter(e => e.date >= from && e.date <= to)
    .sort((a, b) => new Date(b.date) - new Date(a.date));
  
  const tbody = document.querySelector('#expensesTable tbody');
  if (tbody) {
    tbody.innerHTML = filtered.map((expense, index) => {
      return `
      <tr>
        <td>${expense.date}</td>
        <td><span class="pill">${expense.type}</span></td>
        <td>${expense.description || ''}</td>
        <td>${UGX(expense.amount)}</td>
        <td><button class="btn bad" data-remove-expense="${index}">×</button></td>
      </tr>
      `;
    }).join('');
  }
  
  // Update total expenses
  const totalExpenses = filtered.reduce((sum, e) => sum + (e.amount || 0), 0);
  document.getElementById('totalExpenses').textContent = UGX(totalExpenses);
}

function setupExpenses() {
  // Save expense
  document.getElementById('btnSaveExpense').addEventListener('click', () => {
    const date = document.getElementById('expenseDate').value || todayStr();
    const type = document.getElementById('expenseType').value;
    const description = document.getElementById('expenseDescription').value.trim();
    const amount = parseInt(document.getElementById('expenseAmount').value) || 0;
    
    if (!description) {
      alert('Please enter expense description');
      return;
    }
    
    if (amount <= 0) {
      alert('Please enter a valid amount');
      return;
    }
    
    const newExpense = {
      id: 'exp_' + Date.now(),
      date,
      type,
      description,
      amount,
      recordedAt: new Date().toISOString()
    };
    
    db.expenses.push(newExpense);
    saveData();
    
    // Refresh display
    renderExpenses();
    updateDashboardStats();
    
    alert('Expense saved successfully!');
  });
  
  // Remove expense
  document.getElementById('expensesTable').addEventListener('click', (e) => {
    const removeBtn = e.target.closest('[data-remove-expense]');
    if (!removeBtn) return;
    
    const index = parseInt(removeBtn.getAttribute('data-remove-expense'));
    if (confirm('Delete this expense?')) {
      db.expenses.splice(index, 1);
      saveData();
      renderExpenses();
      updateDashboardStats();
    }
  });
  
  // Filter expenses
  document.getElementById('btnFilterExpenses').addEventListener('click', loadExpenses);
}

// ================ EXCEL AUTOMATION ================
function processExcelFile(file, sheetDate) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = function(e) {
      try {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: 'array' });
        
        const result = {
          fileName: file.name,
          date: sheetDate,
          items: [],
          totalRecords: 0,
          totalSales: 0,
          totalProfit: 0
        };
        
        workbook.SheetNames.forEach(sheetName => {
          const worksheet = workbook.Sheets[sheetName];
          const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
          
          // Parse Excel data (based on provided sheet structure)
          for (let i = 2; i < jsonData.length; i++) {
            const row = jsonData[i];
            if (row && row[1] && row[1].trim() !== '') {
              const productName = String(row[1] || '').trim();
              const category = String(row[2] || '').trim();
              const purchasePrice = parseInt(row[3]) || 0;
              const salePrice = parseInt(row[4]) || 0;
              const openingStock = parseInt(row[5]) || 0;
              const received = parseInt(row[6]) || 0;
              const sold = parseInt(row[9]) || 0;
              const profit = parseInt(row[10]) || 0;
              
              if (productName && sold > 0) {
                // Find or create product
                let product = db.products.find(p => 
                  p.name.toLowerCase() === productName.toLowerCase()
                );
                
                if (!product) {
                  product = {
                    id: 'prod_import_' + Date.now() + Math.random(),
                    name: productName,
                    category,
                    purchasePrice,
                    salePrice,
                    openingStock,
                    purchasedQuantity: 0,
                    soldCount: 0,
                    totalProfit: 0,
                    reorderLevel: 10,
                    lastPurchaseDate: null,
                    lastPurchasePrice: purchasePrice
                  };
                  db.products.push(product);
                }
                
                const total = sold * salePrice;
                const itemProfit = sold * (salePrice - purchasePrice);
                
                result.items.push({
                  productId: product.id,
                  productName,
                  quantity: sold,
                  unitPrice: salePrice,
                  total,
                  profit: itemProfit
                });
                
                result.totalRecords++;
                result.totalSales += total;
                result.totalProfit += itemProfit;
                
                // Update product
                product.soldCount = (product.soldCount || 0) + sold;
                product.totalProfit = (product.totalProfit || 0) + itemProfit;
              }
            }
          }
        });
        
        // Save daily sheet
        db.dailySheets[sheetDate] = {
          date: sheetDate,
          items: result.items,
          totalSales: result.totalSales,
          totalProfit: result.totalProfit,
          source: 'excel',
          fileName: file.name,
          recordedAt: new Date().toISOString()
        };
        
        saveData();
        logImport(`Processed sales sheet ${file.name} for ${sheetDate}: ${result.totalRecords} records, Sales: ${UGX(result.totalSales)}, Profit: ${UGX(result.totalProfit)}`);
        
        resolve(result);
      } catch (error) {
        reject(error);
      }
    };
    reader.onerror = reject;
    reader.readAsArrayBuffer(file);
  });
}

function processPurchaseExcelFile(file, sheetDate, supplier) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = function(e) {
      try {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: 'array' });
        
        const result = {
          fileName: file.name,
          date: sheetDate,
          supplier,
          items: [],
          totalRecords: 0,
          totalCost: 0
        };
        
        workbook.SheetNames.forEach(sheetName => {
          const worksheet = workbook.Sheets[sheetName];
          const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
          
          // Parse Excel data for purchases
          for (let i = 1; i < jsonData.length; i++) {
            const row = jsonData[i];
            if (row && row[0] && row[0].trim() !== '') {
              const productName = String(row[0] || '').trim();
              const quantity = parseInt(row[1]) || 0;
              const unitCost = parseInt(row[2]) || 0;
              const totalCost = quantity * unitCost;
              
              if (productName && quantity > 0) {
                // Find or create product
                let product = db.products.find(p => 
                  p.name.toLowerCase() === productName.toLowerCase()
                );
                
                if (!product) {
                  product = {
                    id: 'prod_import_' + Date.now() + Math.random(),
                    name: productName,
                    category: 'other',
                    purchasePrice: unitCost,
                    salePrice: unitCost * 1.5, // Default markup
                    openingStock: 0,
                    purchasedQuantity: 0,
                    soldCount: 0,
                    totalProfit: 0,
                    reorderLevel: 10,
                    lastPurchaseDate: sheetDate,
                    lastPurchasePrice: unitCost
                  };
                  db.products.push(product);
                }
                
                result.items.push({
                  productId: product.id,
                  productName,
                  quantity,
                  unitCost,
                  totalCost
                });
                
                result.totalRecords++;
                result.totalCost += totalCost;
                
                // Update product
                product.purchasedQuantity = (product.purchasedQuantity || 0) + quantity;
                product.lastPurchaseDate = sheetDate;
                product.lastPurchasePrice = unitCost;
                
                // Update purchase price if different
                if (unitCost !== product.purchasePrice) {
                  product.purchasePrice = unitCost;
                }
              }
            }
          }
        });
        
        // Save purchase record
        const newPurchase = {
          id: 'pur_' + Date.now(),
          date: sheetDate,
          supplier,
          items: result.items,
          total: result.totalCost,
          fileName: file.name,
          recordedAt: new Date().toISOString()
        };
        
        db.purchases.push(newPurchase);
        saveData();
        logImport(`Processed purchases sheet ${file.name} for ${sheetDate}: ${result.totalRecords} items, Total: ${UGX(result.totalCost)}`);
        
        resolve(result);
      } catch (error) {
        reject(error);
      }
    };
    reader.onerror = reject;
    reader.readAsArrayBuffer(file);
  });
}

function setupAutomation() {
  // Process daily sales sheet
  document.getElementById('btnProcessDailySheet').addEventListener('click', async () => {
    const fileInput = document.getElementById('dailyExcelFile');
    if (!fileInput.files || fileInput.files.length === 0) {
      alert('Please select an Excel file');
      return;
    }
    
    const sheetDate = document.getElementById('sheetDate').value || todayStr();
    const overwriteOption = document.getElementById('overwriteOption').value;
    
    // Check if sheet already exists
    if (db.dailySheets[sheetDate] && overwriteOption === 'no') {
      alert(`Sheet already exists for ${sheetDate}. Change overwrite option or select a different date.`);
      return;
    }
    
    showLoading(true);
    
    try {
      const result = await processExcelFile(fileInput.files[0], sheetDate);
      
      // Refresh display
      renderProducts();
      renderSales();
      renderInventory();
      updateDashboardStats();
      renderAutomation();
      
      showLoading(false);
      
      alert(`Excel sales sheet processed successfully!\nDate: ${sheetDate}\nRecords: ${result.totalRecords}\nTotal Sales: ${UGX(result.totalSales)}\nTotal Profit: ${UGX(result.totalProfit)}`);
      
      // Clear file input
      fileInput.value = '';
    } catch (error) {
      showLoading(false);
      console.error('Error processing Excel:', error);
      alert('Error processing Excel file: ' + error.message);
    }
  });
  
  // Process purchase sheet
  document.getElementById('btnProcessPurchaseSheet').addEventListener('click', async () => {
    const fileInput = document.getElementById('purchaseExcelFile');
    if (!fileInput.files || fileInput.files.length === 0) {
      alert('Please select an Excel file');
      return;
    }
    
    const sheetDate = document.getElementById('purchaseSheetDate').value || todayStr();
    const supplier = document.getElementById('purchaseSheetSupplier').value.trim();
    
    if (!supplier) {
      alert('Please enter supplier name');
      return;
    }
    
    showLoading(true);
    
    try {
      const result = await processPurchaseExcelFile(fileInput.files[0], sheetDate, supplier);
      
      // Refresh display
      renderProducts();
      renderPurchases();
      renderInventory();
      updateDashboardStats();
      renderAutomation();
      
      showLoading(false);
      
      alert(`Excel purchases sheet processed successfully!\nDate: ${sheetDate}\nSupplier: ${supplier}\nItems: ${result.totalRecords}\nTotal Cost: ${UGX(result.totalCost)}`);
      
      // Clear file input
      fileInput.value = '';
      document.getElementById('purchaseSheetSupplier').value = '';
    } catch (error) {
      showLoading(false);
      console.error('Error processing purchases Excel:', error);
      alert('Error processing purchases Excel file: ' + error.message);
    }
  });
  
  // File input click for sales
  document.getElementById('dailyExcelFile').addEventListener('change', function() {
    if (this.files && this.files[0]) {
      // Auto-set date from filename if possible
      const fileName = this.files[0].name.toLowerCase();
      const dateMatch = fileName.match(/(\d{4}[-_]\d{2}[-_]\d{2})|(\d{8})/);
      if (dateMatch) {
        let dateStr = dateMatch[0];
        // Convert 20231231 to 2023-12-31
        if (dateStr.length === 8 && !dateStr.includes('-') && !dateStr.includes('_')) {
          dateStr = `${dateStr.substring(0,4)}-${dateStr.substring(4,6)}-${dateStr.substring(6,8)}`;
        }
        // Replace underscores with dashes
        dateStr = dateStr.replace(/_/g, '-');
        document.getElementById('sheetDate').value = dateStr;
      }
    }
  });
  
  // File input click for purchases
  document.getElementById('purchaseExcelFile').addEventListener('change', function() {
    if (this.files && this.files[0]) {
      // Auto-set date from filename if possible
      const fileName = this.files[0].name.toLowerCase();
      const dateMatch = fileName.match(/(\d{4}[-_]\d{2}[-_]\d{2})|(\d{8})/);
      if (dateMatch) {
        let dateStr = dateMatch[0];
        // Convert 20231231 to 2023-12-31
        if (dateStr.length === 8 && !dateStr.includes('-') && !dateStr.includes('_')) {
          dateStr = `${dateStr.substring(0,4)}-${dateStr.substring(4,6)}-${dateStr.substring(6,8)}`;
        }
        // Replace underscores with dashes
        dateStr = dateStr.replace(/_/g, '-');
        document.getElementById('purchaseSheetDate').value = dateStr;
      }
      
      // Try to extract supplier from filename
      const supplierMatch = fileName.match(/from_([a-z0-9_]+)/i);
      if (supplierMatch) {
        document.getElementById('purchaseSheetSupplier').value = supplierMatch[1].replace(/_/g, ' ');
      }
    }
  });
}

function renderAutomation() {
  const sheetCount = Object.keys(db.dailySheets).length;
  const purchaseCount = db.purchases.length;
  
  document.getElementById('processedSheetsCount').textContent = sheetCount + purchaseCount;
  document.getElementById('uniqueDatesCount').textContent = sheetCount;
  
  if (sheetCount > 0) {
    const dates = Object.keys(db.dailySheets).sort();
    const lastDate = dates[dates.length - 1];
    const lastSheet = db.dailySheets[lastDate];
    document.getElementById('lastAutoRun').textContent = new Date(lastSheet.recordedAt).toLocaleDateString();
  }
}

// ================ REPORTS ================
function initReports() {
  const today = todayStr();
  const firstDay = today.substring(0, 7) + '-01';
  
  document.getElementById('reportStart').value = firstDay;
  document.getElementById('reportEnd').value = today;
}

function generateReport() {
  const startDate = document.getElementById('reportStart').value;
  const endDate = document.getElementById('reportEnd').value;
  const reportType = document.getElementById('reportType').value;
  
  if (!startDate || !endDate) {
    alert('Please select report period');
    return;
  }
  
  // Calculate report data based on type
  if (reportType === 'purchases') {
    generatePurchasesReport(startDate, endDate);
  } else if (reportType === 'inventory') {
    generateInventoryReport(startDate, endDate);
  } else if (reportType === 'combined') {
    generateCombinedReport(startDate, endDate);
  } else {
    generateProfitLossReport(startDate, endDate);
  }
}

function generateProfitLossReport(startDate, endDate) {
  // Calculate report data
  let totalSales = 0;
  let totalProfit = 0;
  let totalExpenses = 0;
  let totalPurchases = 0;
  const categoryBreakdown = {};
  const dailyBreakdown = [];
  
  // Get sheets for period
  for (const [date, sheet] of Object.entries(db.dailySheets)) {
    if (date >= startDate && date <= endDate) {
      totalSales += sheet.totalSales || 0;
      totalProfit += sheet.totalProfit || 0;
      
      // Daily breakdown
      dailyBreakdown.push({
        date,
        sales: sheet.totalSales || 0,
        profit: sheet.totalProfit || 0
      });
      
      // Category breakdown
      sheet.items.forEach(item => {
        const product = db.products.find(p => p.name === item.productName);
        if (product) {
          const category = product.category || 'other';
          if (!categoryBreakdown[category]) {
            categoryBreakdown[category] = {
              sales: 0,
              profit: 0,
              items: 0
            };
          }
          categoryBreakdown[category].sales += item.total;
          categoryBreakdown[category].profit += item.profit;
          categoryBreakdown[category].items += item.quantity;
        }
      });
    }
  }
  
  // Get purchases for period
  db.purchases.forEach(purchase => {
    if (purchase.date >= startDate && purchase.date <= endDate) {
      totalPurchases += purchase.total || 0;
    }
  });
  
  // Get expenses for period
  db.expenses.forEach(expense => {
    if (expense.date >= startDate && expense.date <= endDate) {
      totalExpenses += expense.amount || 0;
    }
  });
  
  const netProfit = totalProfit - totalExpenses - totalPurchases;
  const profitMargin = totalSales > 0 ? (totalProfit / totalSales * 100).toFixed(1) : 0;
  
  // Generate report HTML
  let html = `
    <div class="grid-4">
      <div class="stat">
        <span class="muted">Report Period</span>
        <b>${startDate} to ${endDate}</b>
      </div>
      <div class="stat">
        <span class="muted">Total Sales</span>
        <b>${UGX(totalSales)}</b>
      </div>
      <div class="stat">
        <span class="muted">Gross Profit</span>
        <b>${UGX(totalProfit)}</b>
      </div>
      <div class="stat">
        <span class="muted">Profit Margin</span>
        <b>${profitMargin}%</b>
      </div>
    </div>
    
    <div class="grid-4" style="margin-top:16px;">
      <div class="stat">
        <span class="muted">Total Purchases</span>
        <b>${UGX(totalPurchases)}</b>
      </div>
      <div class="stat">
        <span class="muted">Total Expenses</span>
        <b>${UGX(totalExpenses)}</b>
      </div>
      <div class="stat">
        <span class="muted">Net Profit/Loss</span>
        <b style="color: ${netProfit >= 0 ? '#16a34a' : '#ef4444'}">${UGX(netProfit)}</b>
      </div>
      <div class="stat ${netProfit >= 0 ? 'goodmsg' : 'badmsg'}">
        <span class="muted">Status</span>
        <b>${netProfit >= 0 ? 'PROFITABLE' : 'LOSS MAKING'}</b>
      </div>
    </div>
    
    <div class="hr"></div>
    
    <h4>Category Breakdown</h4>
    <table class="table" style="margin-bottom:20px;">
      <thead>
        <tr>
          <th>Category</th>
          <th>Items Sold</th>
          <th>Total Sales</th>
          <th>Gross Profit</th>
          <th>Profit Margin</th>
        </tr>
      </thead>
      <tbody>
  `;
  
  for (const [category, data] of Object.entries(categoryBreakdown)) {
    const categoryMargin = data.sales > 0 ? (data.profit / data.sales * 100).toFixed(1) : 0;
    html += `
      <tr>
        <td><strong>${category}</strong></td>
        <td>${data.items}</td>
        <td>${UGX(data.sales)}</td>
        <td>${UGX(data.profit)}</td>
        <td>${categoryMargin}%</td>
      </tr>
    `;
  }
  
  html += `
      </tbody>
    </table>
  `;
  
  document.getElementById('reportOutput').innerHTML = html;
}

function generatePurchasesReport(startDate, endDate) {
  let totalPurchases = 0;
  let totalItems = 0;
  const supplierBreakdown = {};
  const productBreakdown = {};
  
  // Filter purchases
  const filteredPurchases = db.purchases.filter(p => p.date >= startDate && p.date <= endDate);
  
  filteredPurchases.forEach(purchase => {
    totalPurchases += purchase.total || 0;
    
    // Supplier breakdown
    const supplier = purchase.supplier || 'Unknown';
    if (!supplierBreakdown[supplier]) {
      supplierBreakdown[supplier] = {
        count: 0,
        total: 0,
        items: 0
      };
    }
    supplierBreakdown[supplier].count++;
    supplierBreakdown[supplier].total += purchase.total;
    supplierBreakdown[supplier].items += purchase.items.length;
    
    // Product breakdown
    purchase.items.forEach(item => {
      totalItems += item.quantity;
      if (!productBreakdown[item.productName]) {
        productBreakdown[item.productName] = {
          quantity: 0,
          total: 0
        };
      }
      productBreakdown[item.productName].quantity += item.quantity;
      productBreakdown[item.productName].total += item.totalCost;
    });
  });
  
  let html = `
    <div class="grid-3">
      <div class="stat">
        <span class="muted">Report Period</span>
        <b>${startDate} to ${endDate}</b>
      </div>
      <div class="stat">
        <span class="muted">Total Purchases</span>
        <b>${UGX(totalPurchases)}</b>
      </div>
      <div class="stat">
        <span class="muted">Total Items</span>
        <b>${totalItems}</b>
      </div>
    </div>
    
    <div class="hr"></div>
    
    <h4>Supplier Breakdown</h4>
    <table class="table" style="margin-bottom:20px;">
      <thead>
        <tr>
          <th>Supplier</th>
          <th>Purchase Count</th>
          <th>Items</th>
          <th>Total Value</th>
          <th>Average Purchase</th>
        </tr>
      </thead>
      <tbody>
  `;
  
  for (const [supplier, data] of Object.entries(supplierBreakdown)) {
    const avgPurchase = data.count > 0 ? data.total / data.count : 0;
    html += `
      <tr>
        <td><strong>${supplier}</strong></td>
        <td>${data.count}</td>
        <td>${data.items}</td>
        <td>${UGX(data.total)}</td>
        <td>${UGX(avgPurchase)}</td>
      </tr>
    `;
  }
  
  html += `
      </tbody>
    </table>
    
    <h4>Product Breakdown</h4>
    <table class="table">
      <thead>
        <tr>
          <th>Product</th>
          <th>Quantity Purchased</th>
          <th>Total Cost</th>
          <th>Average Unit Cost</th>
        </tr>
      </thead>
      <tbody>
  `;
  
  for (const [product, data] of Object.entries(productBreakdown)) {
    const avgCost = data.quantity > 0 ? data.total / data.quantity : 0;
    html += `
      <tr>
        <td><strong>${product}</strong></td>
        <td>${data.quantity}</td>
        <td>${UGX(data.total)}</td>
        <td>${UGX(avgCost)}</td>
      </tr>
    `;
  }
  
  html += `
      </tbody>
    </table>
  `;
  
  document.getElementById('reportOutput').innerHTML = html;
}

function generateCombinedReport(startDate, endDate) {
  // Call both reports and combine
  let html = `<h3>Combined Business Report</h3>`;
  html += `<p>Period: ${startDate} to ${endDate}</p>`;
  
  // Calculate totals
  let totalSales = 0;
  let totalProfit = 0;
  let totalPurchases = 0;
  let totalExpenses = 0;
  
  // Sales and profit
  for (const [date, sheet] of Object.entries(db.dailySheets)) {
    if (date >= startDate && date <= endDate) {
      totalSales += sheet.totalSales || 0;
      totalProfit += sheet.totalProfit || 0;
    }
  }
  
  // Purchases
  db.purchases.forEach(purchase => {
    if (purchase.date >= startDate && purchase.date <= endDate) {
      totalPurchases += purchase.total || 0;
    }
  });
  
  // Expenses
  db.expenses.forEach(expense => {
    if (expense.date >= startDate && expense.date <= endDate) {
      totalExpenses += expense.amount || 0;
    }
  });
  
  const netProfit = totalProfit - totalExpenses - totalPurchases;
  
  html += `
    <div class="grid-4" style="margin-top:16px;">
      <div class="stat">
        <span class="muted">Total Sales</span>
        <b>${UGX(totalSales)}</b>
      </div>
      <div class="stat">
        <span class="muted">Gross Profit</span>
        <b>${UGX(totalProfit)}</b>
      </div>
      <div class="stat">
        <span class="muted">Total Purchases</span>
        <b>${UGX(totalPurchases)}</b>
      </div>
      <div class="stat">
        <span class="muted">Total Expenses</span>
        <b>${UGX(totalExpenses)}</b>
      </div>
    </div>
    
    <div class="grid-2" style="margin-top:16px;">
      <div class="stat" style="background: ${netProfit >= 0 ? '#ecfdf5' : '#fee2e2'};">
        <span class="muted">Net Profit/Loss</span>
        <b style="color: ${netProfit >= 0 ? '#16a34a' : '#ef4444'}; font-size:28px;">${UGX(netProfit)}</b>
      </div>
      <div class="stat">
        <span class="muted">Profit Margin</span>
        <b>${totalSales > 0 ? ((totalProfit / totalSales) * 100).toFixed(1) : 0}%</b>
      </div>
    </div>
    
    <div class="hr"></div>
    
    <div class="grid-2">
      <div>
        <h4>Top Selling Products</h4>
        <table class="table">
          <thead>
            <tr>
              <th>Product</th>
              <th>Quantity Sold</th>
              <th>Sales Value</th>
            </tr>
          </thead>
          <tbody>
  `;
  
  // Calculate top selling products
  const productSales = {};
  for (const [date, sheet] of Object.entries(db.dailySheets)) {
    if (date >= startDate && date <= endDate) {
      sheet.items.forEach(item => {
        if (!productSales[item.productName]) {
          productSales[item.productName] = {
            quantity: 0,
            sales: 0
          };
        }
        productSales[item.productName].quantity += item.quantity;
        productSales[item.productName].sales += item.total;
      });
    }
  }
  
  // Sort by sales
  const sortedProducts = Object.entries(productSales)
    .sort((a, b) => b[1].sales - a[1].sales)
    .slice(0, 10);
  
  sortedProducts.forEach(([product, data]) => {
    html += `
      <tr>
        <td>${product}</td>
        <td>${data.quantity}</td>
        <td>${UGX(data.sales)}</td>
      </tr>
    `;
  });
  
  html += `
          </tbody>
        </table>
      </div>
      
      <div>
        <h4>Top Purchased Products</h4>
        <table class="table">
          <thead>
            <tr>
              <th>Product</th>
              <th>Quantity Purchased</th>
              <th>Purchase Value</th>
            </tr>
          </thead>
          <tbody>
  `;
  
  // Calculate top purchased products
  const productPurchases = {};
  db.purchases.forEach(purchase => {
    if (purchase.date >= startDate && purchase.date <= endDate) {
      purchase.items.forEach(item => {
        if (!productPurchases[item.productName]) {
          productPurchases[item.productName] = {
            quantity: 0,
            cost: 0
          };
        }
        productPurchases[item.productName].quantity += item.quantity;
        productPurchases[item.productName].cost += item.totalCost;
      });
    }
  });
  
  // Sort by cost
  const sortedPurchases = Object.entries(productPurchases)
    .sort((a, b) => b[1].cost - a[1].cost)
    .slice(0, 10);
  
  sortedPurchases.forEach(([product, data]) => {
    html += `
      <tr>
        <td>${product}</td>
        <td>${data.quantity}</td>
        <td>${UGX(data.cost)}</td>
      </tr>
    `;
  });
  
  html += `
          </tbody>
        </table>
      </div>
    </div>
  `;
  
  document.getElementById('reportOutput').innerHTML = html;
}

function setupReports() {
  document.getElementById('btnGenerateReport').addEventListener('click', generateReport);
  
  // Export report
  document.getElementById('btnExportReport').addEventListener('click', () => {
    const startDate = document.getElementById('reportStart').value;
    const endDate = document.getElementById('reportEnd').value;
    const reportType = document.getElementById('reportType').value;
    
    if (!startDate || !endDate) {
      alert('Please select report period first');
      return;
    }
    
    // Generate Excel report based on type
    let reportData = [];
    
    if (reportType === 'purchases') {
      reportData = [
        ["BAR MANAGEMENT SYSTEM - PURCHASES REPORT"],
        ["Period:", `${startDate} to ${endDate}`],
        ["Generated:", new Date().toLocaleString()],
        [],
        ["PURCHASES SUMMARY"],
        ["Total Purchases", "Total Items", "Number of Purchases"],
      ];
      
      let totalPurchases = 0;
      let totalItems = 0;
      const filteredPurchases = db.purchases.filter(p => p.date >= startDate && p.date <= endDate);
      
      filteredPurchases.forEach(p => {
        totalPurchases += p.total || 0;
        totalItems += p.items.length;
      });
      
      reportData.push([
        UGX(totalPurchases).replace('UGX', '').trim(),
        totalItems,
        filteredPurchases.length
      ]);
      
      reportData.push([], ["DETAILED PURCHASES"]);
      reportData.push(["Date", "Supplier", "Invoice", "Items", "Total"]);
      
      filteredPurchases.forEach(p => {
        reportData.push([
          p.date,
          p.supplier || 'N/A',
          p.invoice || 'N/A',
          p.items.length,
          UGX(p.total || 0).replace('UGX', '').trim()
        ]);
      });
    } else {
      // Default P&L report
      reportData = [
        ["BAR MANAGEMENT SYSTEM - PROFIT & LOSS REPORT"],
        ["Period:", `${startDate} to ${endDate}`],
        ["Generated:", new Date().toLocaleString()],
        [],
        ["SUMMARY"],
        ["Total Sales", "Total Expenses", "Gross Profit", "Net Profit", "Profit Margin"],
      ];
      
      // Calculate totals
      let totalSales = 0;
      let totalProfit = 0;
      let totalExpenses = 0;
      let totalPurchases = 0;
      
      for (const [date, sheet] of Object.entries(db.dailySheets)) {
        if (date >= startDate && date <= endDate) {
          totalSales += sheet.totalSales || 0;
          totalProfit += sheet.totalProfit || 0;
        }
      }
      
      db.purchases.forEach(purchase => {
        if (purchase.date >= startDate && purchase.date <= endDate) {
          totalPurchases += purchase.total || 0;
        }
      });
      
      db.expenses.forEach(expense => {
        if (expense.date >= startDate && expense.date <= endDate) {
          totalExpenses += expense.amount || 0;
        }
      });
      
      const netProfit = totalProfit - totalExpenses - totalPurchases;
      const profitMargin = totalSales > 0 ? (totalProfit / totalSales * 100).toFixed(1) : 0;
      
      reportData.push([
        UGX(totalSales).replace('UGX', '').trim(),
        UGX(totalExpenses).replace('UGX', '').trim(),
        UGX(totalProfit).replace('UGX', '').trim(),
        UGX(netProfit).replace('UGX', '').trim(),
        `${profitMargin}%`
      ]);
      
      reportData.push([], ["DAILY BREAKDOWN"]);
      reportData.push(["Date", "Sales", "Profit", "Expenses", "Net"]);
      
      for (const [date, sheet] of Object.entries(db.dailySheets)) {
        if (date >= startDate && date <= endDate) {
          const dailyExpenses = db.expenses
            .filter(e => e.date === date)
            .reduce((sum, e) => sum + (e.amount || 0), 0);
          const dailyPurchases = db.purchases
            .filter(p => p.date === date)
            .reduce((sum, p) => sum + (p.total || 0), 0);
          const dailyNet = (sheet.totalProfit || 0) - dailyExpenses - dailyPurchases;
          
          reportData.push([
            date,
            UGX(sheet.totalSales || 0).replace('UGX', '').trim(),
            UGX(sheet.totalProfit || 0).replace('UGX', '').trim(),
            UGX(dailyExpenses).replace('UGX', '').trim(),
            UGX(dailyNet).replace('UGX', '').trim()
          ]);
        }
      }
    }
    
    const ws = XLSX.utils.aoa_to_sheet(reportData);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Report");
    
    const wbout = XLSX.write(wb, { bookType: 'xlsx', type: 'binary' });
    
    function s2ab(s) {
      const buf = new ArrayBuffer(s.length);
      const view = new Uint8Array(buf);
      for (let i = 0; i < s.length; i++) view[i] = s.charCodeAt(i) & 0xFF;
      return buf;
    }
    
    const fileName = reportType === 'purchases' 
      ? `purchases-report-${startDate}-to-${endDate}.xlsx`
      : `profit-loss-report-${startDate}-to-${endDate}.xlsx`;
    
    download(fileName, new Blob([s2ab(wbout)], { type: "application/octet-stream" }));
  });
}

// ================ DATA SECTION ================
function renderDataSection() {
  updateLastSaveTime();
}

function setupDataManagement() {
  // Backup data
  document.getElementById('btnBackup').addEventListener('click', () => {
    const dataStr = JSON.stringify(db, null, 2);
    const blob = new Blob([dataStr], { type: 'application/json' });
    download(`bar-backup-${todayStr()}.json`, blob);
  });
  
  // Save data
  document.getElementById('btnSaveNow').addEventListener('click', () => {
    if (saveData()) {
      const btn = document.getElementById('btnSaveNow');
      const originalText = btn.textContent;
      btn.textContent = "✓ Saved!";
      btn.style.background = '#16a34a';
      setTimeout(() => {
        btn.textContent = originalText;
        btn.style.background = '';
      }, 1500);
    }
  });
  
  // Restore data
  document.getElementById('restoreFile').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = function(event) {
      try {
        const newData = JSON.parse(event.target.result);
        if (confirm('Restore this data? Current data will be replaced.')) {
          db = newData;
          saveData();
          location.reload();
        }
      } catch (err) {
        alert('Error restoring data: ' + err.message);
      }
    };
    reader.readAsText(file);
    this.value = '';
  });
  
  // Export all data
  document.getElementById('btnExportAllData').addEventListener('click', () => {
    try {
      // Create workbook with multiple sheets
      const wb = XLSX.utils.book_new();
      
      // Products sheet
      const productsData = db.products.map(p => ({
        'Name': p.name,
        'Category': p.category,
        'Purchase Price': p.purchasePrice,
        'Sale Price': p.salePrice,
        'Opening Stock': p.openingStock,
        'Purchased Quantity': p.purchasedQuantity || 0,
        'Sold Count': p.soldCount || 0,
        'Current Stock': calculateCurrentStock(p),
        'Reorder Level': p.reorderLevel || 10,
        'Total Profit': p.totalProfit || 0,
        'Last Purchase Date': p.lastPurchaseDate,
        'Last Purchase Price': p.lastPurchasePrice || p.purchasePrice
      }));
      
      const wsProducts = XLSX.utils.json_to_sheet(productsData);
      XLSX.utils.book_append_sheet(wb, wsProducts, 'Products');
      
      // Daily sheets summary
      const dailyData = [];
      for (const [date, sheet] of Object.entries(db.dailySheets)) {
        dailyData.push({
          'Date': date,
          'Items Count': sheet.items.length,
          'Total Sales': sheet.totalSales || 0,
          'Total Profit': sheet.totalProfit || 0,
          'Source': sheet.source || 'manual',
          'Recorded At': sheet.recordedAt ? new Date(sheet.recordedAt).toLocaleString() : ''
        });
      }
      
      if (dailyData.length > 0) {
        const wsDaily = XLSX.utils.json_to_sheet(dailyData);
        XLSX.utils.book_append_sheet(wb, wsDaily, 'Daily Sheets');
      }
      
      // Purchases sheet
      if (db.purchases.length > 0) {
        const purchaseData = db.purchases.flatMap(p => 
          p.items.map(item => ({
            'Date': p.date,
            'Supplier': p.supplier || 'N/A',
            'Invoice': p.invoice || 'N/A',
            'Product': item.productName,
            'Quantity': item.quantity,
            'Unit Cost': item.unitCost,
            'Total Cost': item.totalCost
          }))
        );
        
        const wsPurchases = XLSX.utils.json_to_sheet(purchaseData);
        XLSX.utils.book_append_sheet(wb, wsPurchases, 'Purchases');
      }
      
      // Expenses sheet
      if (db.expenses.length > 0) {
        const wsExpenses = XLSX.utils.json_to_sheet(db.expenses);
        XLSX.utils.book_append_sheet(wb, wsExpenses, 'Expenses');
      }
      
      // Download
      const wbout = XLSX.write(wb, { bookType: 'xlsx', type: 'binary' });
      
      function s2ab(s) {
        const buf = new ArrayBuffer(s.length);
        const view = new Uint8Array(buf);
        for (let i = 0; i < s.length; i++) view[i] = s.charCodeAt(i) & 0xFF;
        return buf;
      }
      
      download(`bar-data-export-${todayStr()}.xlsx`, new Blob([s2ab(wbout)], { type: "application/octet-stream" }));
      
      alert('All data exported to Excel successfully!');
    } catch (error) {
      console.error('Export error:', error);
      alert('Error exporting data: ' + error.message);
    }
  });
  
  // Export purchases
  document.getElementById('btnExportPurchases').addEventListener('click', () => {
    const from = document.getElementById('exportFrom').value;
    const to = document.getElementById('exportTo').value;
    
    // Filter purchases by date range
    let filteredPurchases = db.purchases;
    if (from && to) {
      filteredPurchases = db.purchases.filter(p => p.date >= from && p.date <= to);
    }
    
    if (filteredPurchases.length === 0) {
      alert('No purchases found for the selected date range');
      return;
    }
    
    const purchaseData = filteredPurchases.flatMap(p => 
      p.items.map(item => ({
        'Date': p.date,
        'Supplier': p.supplier || 'N/A',
        'Invoice': p.invoice || 'N/A',
        'Product': item.productName,
        'Quantity': item.quantity,
        'Unit Cost': item.unitCost,
        'Total Cost': item.totalCost
      }))
    );
    
    const ws = XLSX.utils.json_to_sheet(purchaseData);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Purchases");
    
    const wbout = XLSX.write(wb, { bookType: 'xlsx', type: 'binary' });
    
    function s2ab(s) {
      const buf = new ArrayBuffer(s.length);
      const view = new Uint8Array(buf);
      for (let i = 0; i < s.length; i++) view[i] = s.charCodeAt(i) & 0xFF;
      return buf;
    }
    
    const fileName = `purchases-export-${from || 'all'}-to-${to || 'all'}.xlsx`;
    download(fileName, new Blob([s2ab(wbout)], { type: "application/octet-stream" }));
    
    alert('Purchases exported successfully!');
  });
  
  // Wipe data
  document.getElementById('btnWipe').addEventListener('click', () => {
    if (confirm('ARE YOU SURE? This will delete ALL data and cannot be undone!')) {
      localStorage.removeItem(STORAGE_KEY);
      location.reload();
    }
  });
  
  // Clear sheets
  document.getElementById('btnClearSheets').addEventListener('click', () => {
    if (confirm('Clear all daily sheets? This cannot be undone!')) {
      db.dailySheets = {};
      saveData();
      renderSales();
      renderProducts();
      updateDashboardStats();
      alert('All daily sheets cleared!');
    }
  });
  
  // Clear purchases
  document.getElementById('btnClearPurchases').addEventListener('click', () => {
    if (confirm('Clear all purchases? This will also reset purchased quantities. This cannot be undone!')) {
      // Reset purchased quantities in products
      db.products.forEach(product => {
        product.purchasedQuantity = 0;
      });
      
      db.purchases = [];
      saveData();
      renderPurchases();
      renderProducts();
      updateDashboardStats();
      alert('All purchases cleared!');
    }
  });
  
  // Clear expenses
  document.getElementById('btnClearExpenses').addEventListener('click', () => {
    if (confirm('Clear all expenses? This cannot be undone!')) {
      db.expenses = [];
      saveData();
      renderExpenses();
      updateDashboardStats();
      alert('All expenses cleared!');
    }
  });
}

// ================ GOOGLE DRIVE INTEGRATION ================
const GOOGLE_CLIENT_ID = "1012401719257-nm0hj0h1na9d7tm8eat4tllgigjrbir0.apps.googleusercontent.com";
const DRIVE_SCOPE = "https://www.googleapis.com/auth/drive.file";
const DRIVE_FILE_NAME = "bar-management-backup.json";
let driveAccessToken = null;
let driveTokenClient = null;

function setCloudStatus(text, good = false) {
  const el = document.getElementById('cloudStatus');
  if (el) {
    el.textContent = text;
    el.style.background = good ? '#16a34a' : '#64748b';
    el.style.color = 'white';
  }
}

async function initGoogleDrive() {
  return new Promise((resolve) => {
    if (typeof google === 'undefined' || !google.accounts) {
      setTimeout(() => initGoogleDrive().then(resolve), 100);
      return;
    }
    
    try {
      driveTokenClient = google.accounts.oauth2.initTokenClient({
        client_id: GOOGLE_CLIENT_ID,
        scope: DRIVE_SCOPE,
        callback: async (tokenResponse) => {
          if (tokenResponse && tokenResponse.access_token) {
            driveAccessToken = tokenResponse.access_token;
            setCloudStatus("✓ Signed in", true);
            document.getElementById('btnCloudSave').disabled = false;
            document.getElementById('btnCloudLoad').disabled = false;
            document.getElementById('btnGSignIn').disabled = true;
          }
        }
      });
      
      resolve();
    } catch (error) {
      console.error('Google Drive init error:', error);
      setCloudStatus("✗ Not available", false);
      resolve();
    }
  });
}

async function driveSave() {
  const ok = await driveEnsureToken(true);
  if (!ok) {
    alert("Please sign in to Google first.");
    return;
  }
  
  const btn = document.getElementById('btnCloudSave');
  const originalText = btn.textContent;
  
  try {
    btn.textContent = "Saving...";
    btn.disabled = true;
    
    const jsonData = JSON.stringify(db, null, 2);
    const existing = await driveFindBackup();
    
    if (existing) {
      await driveUpdateBackup(existing.id, jsonData);
    } else {
      await driveCreateBackup(jsonData);
    }
    
    const now = new Date().toISOString();
    document.getElementById('lastCloudBackup').textContent = new Date(now).toLocaleString();
    setCloudStatus(`✓ Saved: ${new Date().toLocaleTimeString()}`, true);
    
    btn.textContent = "✓ Saved!";
    setTimeout(() => {
      btn.textContent = originalText;
      btn.disabled = false;
    }, 2000);
    
    alert("✅ Backup saved to Google Drive!");
  } catch (error) {
    console.error('Google Drive save error:', error);
    btn.textContent = originalText;
    btn.disabled = false;
    alert("Error saving to Google Drive: " + error.message);
  }
}

async function driveLoad() {
  const ok = await driveEnsureToken(true);
  if (!ok) {
    alert("Please sign in to Google first.");
    return;
  }
  
  try {
    const existing = await driveFindBackup();
    if (!existing) {
      alert("No backup file found in Google Drive.");
      return;
    }
    
    if (!confirm(`Load backup from ${new Date(existing.modifiedTime).toLocaleString()}?`)) {
      return;
    }
    
    const jsonText = await driveDownloadFile(existing.id);
    const backupData = JSON.parse(jsonText);
    
    if (confirm("This will replace ALL current data. Continue?")) {
      db = backupData;
      saveData();
      
      const btn = document.getElementById('btnCloudLoad');
      const originalText = btn.textContent;
      btn.textContent = "✓ Loaded!";
      btn.disabled = true;
      
      setTimeout(() => {
        btn.textContent = originalText;
        btn.disabled = false;
        location.reload();
      }, 1000);
    }
  } catch (error) {
    console.error('Google Drive load error:', error);
    alert("Error loading from Google Drive: " + error.message);
  }
}

async function driveEnsureToken(interactive = true) {
  return new Promise((resolve) => {
    if (driveAccessToken) {
      resolve(true);
      return;
    }
    
    if (!driveTokenClient) {
      setCloudStatus("Google Drive not initialized");
      resolve(false);
      return;
    }
    
    driveTokenClient.callback = (resp) => {
      if (resp && resp.access_token) {
        driveAccessToken = resp.access_token;
        setCloudStatus("✓ Signed in", true);
        document.getElementById('btnCloudSave').disabled = false;
        document.getElementById('btnCloudLoad').disabled = false;
        document.getElementById('btnGSignIn').disabled = true;
        resolve(true);
      } else {
        resolve(false);
      }
    };
    
    driveTokenClient.requestAccessToken(interactive ? {prompt: 'consent'} : {prompt: ''});
  });
}

async function driveFindBackup() {
  try {
    const q = encodeURIComponent(`name='${DRIVE_FILE_NAME}' and mimeType='application/json' and trashed=false`);
    const url = `https://www.googleapis.com/drive/v3/files?q=${q}&fields=files(id,name,modifiedTime,size)`;
    
    const response = await fetch(url, {
      headers: { Authorization: `Bearer ${driveAccessToken}` }
    });
    
    if (!response.ok) {
      throw new Error(`Drive API error: ${response.status}`);
    }
    
    const data = await response.json();
    return data.files && data.files[0] ? data.files[0] : null;
  } catch (error) {
    console.error('Error finding backup:', error);
    return null;
  }
}

async function driveDownloadFile(fileId) {
  const response = await fetch(`https://www.googleapis.com/drive/v3/files/${fileId}?alt=media`, {
    headers: { Authorization: `Bearer ${driveAccessToken}` }
  });
  
  if (!response.ok) {
    throw new Error(`Download failed: ${response.status}`);
  }
  
  return response.text();
}

function makeMultipartBody(meta, contentStr) {
  const boundary = "-------bar-backup" + Math.random().toString(36).slice(2);
  const delimiter = `\r\n--${boundary}\r\n`;
  const close = `\r\n--${boundary}--`;
  
  const body = delimiter +
    "Content-Type: application/json; charset=UTF-8\r\n\r\n" +
    JSON.stringify(meta) +
    delimiter +
    "Content-Type: application/json\r\n\r\n" +
    contentStr +
    close;
  
  return {
    body,
    headers: {
      "Content-Type": `multipart/related; boundary=${boundary}`,
      "Authorization": `Bearer ${driveAccessToken}`
    }
  };
}

async function driveCreateBackup(jsonStr) {
  const meta = {
    name: DRIVE_FILE_NAME,
    mimeType: "application/json",
    description: "Bar Management System Backup"
  };
  
  const { body, headers } = makeMultipartBody(meta, jsonStr);
  const url = "https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart";
  
  const response = await fetch(url, {
    method: "POST",
    headers,
    body
  });
  
  if (!response.ok) {
    throw new Error(`Create failed: ${response.status}`);
  }
  
  return response.json();
}

async function driveUpdateBackup(fileId, jsonStr) {
  const meta = { mimeType: "application/json" };
  const { body, headers } = makeMultipartBody(meta, jsonStr);
  const url = `https://www.googleapis.com/upload/drive/v3/files/${fileId}?uploadType=multipart`;
  
  const response = await fetch(url, {
    method: "PATCH",
    headers,
    body
  });
  
  if (!response.ok) {
    throw new Error(`Update failed: ${response.status}`);
  }
  
  return response.json();
}

function setupGoogleDrive() {
  document.getElementById('btnGSignIn').addEventListener('click', async () => {
    const ok = await driveEnsureToken(true);
    if (ok) {
      setCloudStatus("✓ Signed in", true);
    }
  });
  
  document.getElementById('btnCloudSave').addEventListener('click', driveSave);
  document.getElementById('btnCloudLoad').addEventListener('click', driveLoad);
}

// ================ INITIALIZATION ================
async function initializeApp() {
  // Set today's date in all date fields
  const today = todayStr();
  document.querySelectorAll('input[type="date"]').forEach(input => {
    if (!input.value) input.value = today;
  });
  
  // Initialize products from Excel if empty
  initializeProductsFromExcel();
  
  // Setup all components
  setupTabs();
  setupProducts();
  setupSales();
  setupPurchases();
  setupInventory();
  setupExpenses();
  setupReports();
  setupAutomation();
  setupDataManagement();
  
  // Initialize Google Drive
  await initGoogleDrive();
  setupGoogleDrive();
  
  // Initial render
  renderProducts();
  updateDashboardStats();
  renderAutomation();
  updateLastSaveTime();
  
  console.log('Enhanced Bar Management System with Purchases initialized successfully!');
}

// Start the application
document.addEventListener('DOMContentLoaded', initializeApp);
</script>
</body>
</html>
