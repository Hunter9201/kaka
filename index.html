<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>BAR MANAGEMENT SYSTEM – Inventory, Purchases & Sales</title>
<meta name="description" content="Bar stock management system: track purchases, inventory, sales, and profits. With Excel and Gmail integration.">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
<!-- SheetJS library for Excel operations -->
<script src="https://cdn.sheetjs.com/xlsx-0.20.2/package/dist/xlsx.full.min.js"></script>
<style>
  :root{ --brand:#0ea5e9; --brand-d:#0369a1; --ok:#16a34a; --warn:#f59e0b; --bad:#ef4444; --ink:#0f172a; --muted:#64748b; --line:#e2e8f0; --bg:#f8fafc; }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,sans-serif;background:var(--bg);color:var(--ink)}
  header{position:sticky;top:0;z-index:20;background:#fff;border-bottom:1px solid var(--line)}
  .nav{display:flex;gap:12px;align-items:center;justify-content:space-between;padding:12px 16px}
  .brand{display:flex;gap:10px;align-items:center;font-weight:800}
  .brand-badge{width:36px;height:36px;border-radius:10px;background:var(--brand);color:#fff;display:grid;place-items:center}
  .tabs{display:flex;flex-wrap:wrap;gap:8px}
  .tab{border:1px solid var(--line);background:#fff;border-radius:10px;padding:8px 12px;cursor:pointer;font-weight:700}
  .tab.active{background:var(--brand);border-color:var(--brand);color:#fff}
  main{padding:16px;max-width:1420px;margin:0 auto}
  h2{margin:.2rem 0 1rem}
  .row{display:grid;grid-template-columns:repeat(12,1fr);gap:12px}
  .card{background:#fff;border:1px solid var(--line);border-radius:12px;padding:12px}
  .card h3{margin:.3rem 0 .8rem}
  label{font-size:12px;color:var(--muted);display:block;margin-bottom:4px}
  input,select,button,textarea{font:inherit}
  input[type="number"],input[type="date"],input[type="text"],input[type="tel"],select,textarea{width:100%;padding:10px;border:1px solid var(--line);border-radius:8px;background:#fff}
  .btn{padding:10px 14px;border-radius:10px;border:1px solid var(--line);background:#fff;cursor:pointer;font-weight:700}
  .btn.primary{background:var(--brand);border-color:var(--brand);color:#fff}
  .btn.primary:hover{background:var(--brand-d);border-color:var(--brand-d)}
  .btn.ok{background:var(--ok);border-color:var(--ok);color:#fff}
  .btn.warn{background:var(--warn);border-color:var(--warn);color:#111827}
  .btn.bad{background:var(--bad);border-color:var(--bad);color:#fff}
  .stack{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
  .muted{color:var(--muted)}
  .pill{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid var(--line);background:#f1f5f9;font-size:12px}
  .table{width:100%;border-collapse:collapse}
  .table th,.table td{border-bottom:1px dashed var(--line);padding:8px;text-align:left;font-size:14px}
  .help{font-size:12px;color:var(--muted)}
  .right{display:flex;justify-content:flex-end;gap:8px}
  .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .grid-3{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
  .grid-4{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
  @media (max-width: 900px){ .row{grid-template-columns:1fr} .grid-2,.grid-3,.grid-4{grid-template-columns:1fr} }
  .stat{padding:10px;border:1px solid var(--line);border-radius:10px;background:#fff}
  .stat b{display:block;font-size:20px;margin-top:4px}
  .hr{height:1px;background:var(--line);margin:12px 0}
  .warnmsg{background:#fff7ed;border:1px solid #fdba74;color:#9a3412;padding:8px;border-radius:10px}
  .goodmsg{background:#ecfdf5;border:1px solid #86efac;color:#065f46;padding:8px;border-radius:10px}
  .mono{font-family: ui-monospace, Menlo, Consolas, "Courier New", monospace; white-space: pre-wrap;}
  img{max-width:100%}
  .section-tools{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .compact-table{font-size:12px}
  .compact-table th,.compact-table td{padding:4px 6px}
  .modal{display:none;position:fixed;z-index:100;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,0.5);justify-content:center;align-items:center}
  .modal-content{background:#fff;padding:20px;border-radius:12px;width:90%;max-width:500px;max-height:80vh;overflow-y:auto}
  .modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:15px}
  .close-modal{cursor:pointer;font-size:24px}
  .loading{display:none;text-align:center;padding:20px}
  @media print {
    header, .tabs, .section-tools, .btn { display:none !important; }
    main{max-width:none}
    .card{border:0}
  }
</style>
</head>
<body>
  <header>
    <div class="nav">
      <div class="brand"><div class="brand-badge">B</div> BAR MANAGEMENT SYSTEM</div>
      <div class="tabs" id="tabs">
        <button class="tab active" data-tab="dashboard">Dashboard</button>
        <button class="tab" data-tab="inventory">Inventory</button>
        <button class="tab" data-tab="purchases">Purchases</button>
        <button class="tab" data-tab="sales">Sales</button>
        <button class="tab" data-tab="products">Products</button>
        <button class="tab" data-tab="reports">Reports</button>
        <button class="tab" data-tab="automation">Automation</button>
        <button class="tab" data-tab="data">Data</button>
      </div>
    </div>
  </header>

  <main>
    <!-- DASHBOARD -->
    <section id="dashboard" class="tabpanel">
      <h2>Bar Dashboard</h2>
      <div class="grid-4">
        <div class="stat"><span class="muted">Total Products</span><b id="statProducts">0</b></div>
        <div class="stat"><span class="muted">Current Stock Value</span><b id="statStockValue">UGX 0</b></div>
        <div class="stat"><span class="muted">Today's Sales</span><b id="statTodaySales">UGX 0</b></div>
        <div class="stat"><span class="muted">Month Purchases</span><b id="statMonthPurchases">UGX 0</b></div>
      </div>
      <div class="grid-4" style="margin-top:8px">
        <div class="stat"><span class="muted">Profit Margin</span><b id="statProfitMargin">0%</b></div>
        <div class="stat"><span class="muted">Fast Moving Items</span><b id="statFastMoving">0</b></div>
        <div class="stat"><span class="muted">Low Stock Items</span><b id="statLowStock">0</b></div>
        <div class="stat"><span class="muted">Auto-Imported Days</span><b id="statImportedDays">0</b></div>
      </div>
      
      <div class="hr"></div>
      
      <div class="grid-2">
        <div class="card">
          <h3>Quick Actions</h3>
          <div class="stack">
            <button class="btn primary" id="btnNewPurchase">New Purchase</button>
            <button class="btn ok" id="btnNewSale">Record Sale</button>
            <button class="btn" id="btnToday">Today</button>
            <button class="btn warn" id="btnGenerateBlankExcel">Blank Excel Template</button>
            <button class="btn" id="btnBackup">Export data (JSON)</button>
            <button class="btn" id="btnSaveNow">Save</button>
          </div>
          <p class="help">Use "Blank Excel Template" to create daily sheets. Data saves locally.</p>
        </div>
        
        <div class="card">
          <h3>Auto-Import Status</h3>
          <div id="autoImportStatus" class="goodmsg" style="margin-bottom:10px">
            Last import: <span id="lastImportTime">Never</span>
          </div>
          <button class="btn primary" id="btnCheckGmail">Check Gmail for Sheets</button>
          <p class="help">Searches for Excel attachments in your Gmail</p>
        </div>
      </div>
      
      <div class="hr"></div>
      
      <div class="grid-2">
        <div class="card">
          <h3>Recent Sales</h3>
          <table class="table compact-table" id="recentSalesTable">
            <thead><tr><th>Date</th><th>Product</th><th>Qty</th><th>Amount</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
        
        <div class="card">
          <h3>Low Stock Alert</h3>
          <table class="table compact-table" id="lowStockTable">
            <thead><tr><th>Product</th><th>Stock</th><th>Min Level</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- AUTOMATION SECTION (NEW) -->
    <section id="automation" class="tabpanel" hidden>
      <div class="card">
        <h3>Gmail & Excel Automation</h3>
        
        <div class="grid-3">
          <div class="stat">
            <span class="muted">Excel Sheets Processed</span>
            <b id="processedSheetsCount">0</b>
          </div>
          <div class="stat">
            <span class="muted">Auto-Import Days</span>
            <b id="autoImportDays">0</b>
          </div>
          <div class="stat">
            <span class="muted">Last Auto-Run</span>
            <b id="lastAutoRun">Never</b>
          </div>
        </div>
        
        <div class="hr"></div>
        
        <h4>Gmail Integration Setup</h4>
        <div class="warnmsg" style="margin-bottom:12px">
          <strong>Note:</strong> For Gmail access, you need to create a Google Apps Script. See instructions below.
        </div>
        
        <div class="grid-2">
          <div>
            <label>Gmail Search Query</label>
            <input type="text" id="gmailQuery" value="has:attachment filename:xlsx OR filename:xls subject:daily" placeholder="Gmail search query">
            <p class="help">Search for Excel attachments in Gmail</p>
          </div>
          <div>
            <label>Process Emails From Last (days)</label>
            <input type="number" id="emailDays" value="7" min="1" max="30">
          </div>
        </div>
        
        <div class="stack" style="margin-top:12px">
          <button class="btn primary" id="btnSetupGmail">Setup Instructions</button>
          <button class="btn ok" id="btnManualImport">Manual Import Excel</button>
          <button class="btn" id="btnRunAutoImport">Run Auto-Import Now</button>
          <button class="btn warn" id="btnViewImportLog">View Import Log</button>
        </div>
      </div>
      
      <div class="card" style="margin-top:12px">
        <h3>Excel Template Generator</h3>
        <p>Generate blank Excel templates for daily data entry:</p>
        
        <div class="grid-3" style="margin-top:12px">
          <button class="btn" id="btnTemplateDailySales">Daily Sales Template</button>
          <button class="btn" id="btnTemplateDailyPurchases">Daily Purchases Template</button>
          <button class="btn" id="btnTemplateInventory">Inventory Template</button>
        </div>
        
        <div class="hr" style="margin:12px 0"></div>
        
        <h4>Batch Process Multiple Files</h4>
        <div class="stack">
          <label class="btn">
            <input type="file" id="batchExcelFiles" multiple accept=".xlsx,.xls" style="display:none">
            Upload Multiple Excel Files
          </label>
          <button class="btn ok" id="btnProcessBatch">Process Batch</button>
        </div>
        <p class="help">Upload multiple daily Excel sheets to automatically aggregate data</p>
      </div>
      
      <div class="card" style="margin-top:12px">
        <h3>Auto-Import Log</h3>
        <div style="max-height:200px;overflow-y:auto;border:1px solid var(--line);border-radius:8px;padding:8px">
          <pre id="importLog" style="margin:0;font-size:12px;white-space:pre-wrap">No import activity yet.</pre>
        </div>
        <div class="right" style="margin-top:8px">
          <button class="btn" id="btnClearLog">Clear Log</button>
        </div>
      </div>
    </section>

    <!-- MODAL FOR SETUP INSTRUCTIONS -->
    <div id="gmailSetupModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3>Gmail Integration Setup</h3>
          <span class="close-modal">&times;</span>
        </div>
        <div>
          <h4>Step 1: Create Google Apps Script</h4>
          <ol>
            <li>Go to <a href="https://script.google.com" target="_blank">script.google.com</a></li>
            <li>Create new project</li>
            <li>Paste the provided script code</li>
            <li>Deploy as Web App</li>
            <li>Copy the Web App URL</li>
          </ol>
          
          <h4>Step 2: Configure Script</h4>
          <textarea id="googleScriptCode" readonly style="width:100%;height:200px;font-family:monospace;font-size:12px;margin:10px 0"></textarea>
          <button class="btn" onclick="copyScriptCode()">Copy Script Code</button>
          
          <h4>Step 3: Configure This System</h4>
          <div class="grid-2">
            <div>
              <label>Web App URL</label>
              <input type="text" id="webAppUrl" placeholder="https://script.google.com/...">
            </div>
            <div>
              <label>Access Token</label>
              <input type="text" id="accessToken" placeholder="Optional: for secured access">
            </div>
          </div>
          
          <div class="right" style="margin-top:15px">
            <button class="btn primary" id="btnSaveGmailConfig">Save Configuration</button>
          </div>
        </div>
      </div>
    </div>

    <!-- LOADING INDICATOR -->
    <div id="loading" class="loading">
      <div style="font-size:24px">⏳</div>
      <p>Processing Excel files...</p>
    </div>

<!-- Rest of your existing HTML code remains the same (Inventory, Purchases, Sales, Products, Reports, Data sections) -->
<!-- I've omitted those sections here for brevity, but they should remain in your actual code -->

<script>
/* ========= ENHANCED UTILITIES ========= */
const UGX = (v)=> new Intl.NumberFormat('en-UG', {style:'currency', currency:'UGX', maximumFractionDigits:0}).format(v||0);
const todayStr = ()=> new Date().toLocaleDateString('en-CA', { timeZone: 'Africa/Kampala' });
const parseDate = s => new Date(s+'T00:00:00');
const daysBetween = (a,b)=> Math.max(0, Math.round((parseDate(b)-parseDate(a)) / (1000*60*60*24)));
const clone = x => JSON.parse(JSON.stringify(x));
function download(filename, blob){
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = filename;
  a.click();
  setTimeout(()=> URL.revokeObjectURL(a.href), 1000);
}
function showLoading(show){
  document.getElementById('loading').style.display = show ? 'block' : 'none';
}
function logImport(message){
  const logEl = document.getElementById('importLog');
  const timestamp = new Date().toLocaleTimeString();
  logEl.textContent = `[${timestamp}] ${message}\n${logEl.textContent}`;
}

/* ========= ENHANCED DATA MODEL ========= */
const KEY='bar_management_v2';
let db = {};
try { 
  db = JSON.parse(localStorage.getItem(KEY) || '{}'); 
} catch(e){ 
  console.warn('Local data corrupted. Resetting storage.', e); 
  localStorage.removeItem(KEY); 
  db = {}; 
}

// Initialize if empty with enhanced structure
if(!db.products){
  db = {
    products: [],
    purchases: [],
    sales: [],
    inventory: [],
    dailySheets: [], // NEW: Store imported daily sheets
    importLog: [],   // NEW: Track import activities
    automation: {    // NEW: Automation settings
      gmailWebAppUrl: '',
      lastAutoRun: null,
      processedSheets: 0,
      autoImportQuery: 'has:attachment filename:xlsx OR filename:xls subject:daily'
    },
    settings: { 
      updatedAt: new Date().toISOString(),
      version: '2.0'
    }
  };
  save();
}

function save(){
  db.settings.updatedAt = new Date().toISOString();
  localStorage.setItem(KEY, JSON.stringify(db));
  updateDashboardStats();
}

/* ========= EXCEL TEMPLATE GENERATION ========= */
function generateBlankExcelTemplate(type) {
  let wb = XLSX.utils.book_new();
  let ws_data, ws_name, fileName;
  
  switch(type) {
    case 'sales':
      ws_name = "Daily_Sales";
      ws_data = [
        ["DAILY SALES REPORT"],
        ["Date:", todayStr()],
        [],
        ["Product", "Quantity", "Unit Price (UGX)", "Total Amount (UGX)", "Customer", "Payment Method"],
        ["Gilbeys (s)", 5, 12000, 60000, "Walk-in", "Cash"],
        ["Ug Plastic", 3, 7000, 21000, "Regular", "Mobile Money"],
        ["CLUB Beer", 10, 4000, 40000, "Walk-in", "Cash"],
        // Add more sample rows as needed
      ];
      fileName = `Daily_Sales_Template_${todayStr()}.xlsx`;
      break;
      
    case 'purchases':
      ws_name = "Daily_Purchases";
      ws_data = [
        ["DAILY PURCHASES REPORT"],
        ["Date:", todayStr()],
        ["Supplier:", "Example Supplier"],
        [],
        ["Product", "Quantity", "Unit Cost (UGX)", "Total Cost (UGX)", "Supplier", "Receipt No"],
        ["Gilbeys (s)", 12, 8500, 102000, "Distributor", "REC-001"],
        ["Ug Plastic", 24, 5000, 120000, "Wholesaler", "REC-002"],
        ["HIGH 5", 48, 2083, 100000, "Energy Drinks Co", "REC-003"],
      ];
      fileName = `Daily_Purchases_Template_${todayStr()}.xlsx`;
      break;
      
    case 'inventory':
      ws_name = "Inventory_Check";
      ws_data = [
        ["DAILY INVENTORY CHECK"],
        ["Date:", todayStr()],
        [],
        ["Product", "Category", "Opening Stock", "Purchased Today", "Sold Today", "Closing Stock", "Notes"],
        ["Gilbeys (s)", "Spirits", 15, 0, 5, 10, "Stock good"],
        ["Ug Plastic", "Spirits", 10, 0, 3, 7, "Reorder needed"],
        ["CLUB Beer", "Beer", 20, 10, 15, 15, ""],
      ];
      fileName = `Inventory_Template_${todayStr()}.xlsx`;
      break;
  }
  
  const ws = XLSX.utils.aoa_to_sheet(ws_data);
  
  // Style the header row
  const range = XLSX.utils.decode_range(ws['!ref']);
  for(let C = range.s.c; C <= range.e.c; ++C) {
    const cell_address = XLSX.utils.encode_cell({r:0, c:C});
    if(!ws[cell_address]) continue;
    ws[cell_address].s = { // Style for title
      font: { bold: true, sz: 14 },
      alignment: { horizontal: "center" }
    };
  }
  
  // Style the column headers
  const headerRow = type === 'sales' ? 3 : type === 'purchases' ? 4 : 3;
  for(let C = range.s.c; C <= range.e.c; ++C) {
    const cell_address = XLSX.utils.encode_cell({r:headerRow, c:C});
    if(!ws[cell_address]) continue;
    ws[cell_address].s = {
      font: { bold: true },
      fill: { fgColor: { rgb: "E0E0E0" } }
    };
  }
  
  XLSX.utils.book_append_sheet(wb, ws, ws_name);
  
  // Generate and download
  const wbout = XLSX.write(wb, {bookType:'xlsx', type:'binary'});
  function s2ab(s) {
    const buf = new ArrayBuffer(s.length);
    const view = new Uint8Array(buf);
    for (let i=0; i<s.length; i++) view[i] = s.charCodeAt(i) & 0xFF;
    return buf;
  }
  download(fileName, new Blob([s2ab(wbout)],{type:"application/octet-stream"}));
}

/* ========= EXCEL IMPORT & PROCESSING ========= */
function processExcelFile(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = function(e) {
      try {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, {type: 'array'});
        
        const result = {
          fileName: file.name,
          processedDate: new Date().toISOString(),
          sheets: [],
          totalRecords: 0
        };
        
        // Process each sheet
        workbook.SheetNames.forEach(sheetName => {
          const worksheet = workbook.Sheets[sheetName];
          const jsonData = XLSX.utils.sheet_to_json(worksheet, {header: 1});
          
          // Detect sheet type and process accordingly
          const sheetType = detectSheetType(jsonData);
          const processedData = processSheetData(jsonData, sheetType);
          
          result.sheets.push({
            name: sheetName,
            type: sheetType,
            data: processedData,
            rowCount: processedData.length
          });
          
          result.totalRecords += processedData.length;
          
          // Automatically add to database based on sheet type
          autoAddToDatabase(processedData, sheetType, file.name);
        });
        
        // Log the import
        db.dailySheets.push({
          fileName: file.name,
          importDate: new Date().toISOString(),
          recordCount: result.totalRecords,
          sheetCount: result.sheets.length
        });
        
        db.automation.processedSheets = (db.automation.processedSheets || 0) + 1;
        db.automation.lastAutoRun = new Date().toISOString();
        
        logImport(`Processed ${file.name}: ${result.totalRecords} records from ${result.sheets.length} sheets`);
        save();
        
        resolve(result);
      } catch (error) {
        reject(error);
      }
    };
    reader.onerror = reject;
    reader.readAsArrayBuffer(file);
  });
}

function detectSheetType(data) {
  // Simple detection based on content
  const headerRow = data[0] ? data[0].join(' ').toLowerCase() : '';
  
  if (headerRow.includes('sales') || headerRow.includes('customer')) return 'sales';
  if (headerRow.includes('purchase') || headerRow.includes('supplier')) return 'purchases';
  if (headerRow.includes('inventory') || headerRow.includes('stock')) return 'inventory';
  if (headerRow.includes('product') && headerRow.includes('price')) return 'products';
  
  return 'unknown';
}

function processSheetData(data, type) {
  // Skip empty rows and header rows
  const processed = [];
  let startRow = 0;
  
  // Find the start of data (skip title rows)
  for (let i = 0; i < Math.min(5, data.length); i++) {
    if (data[i] && data[i].some(cell => cell && typeof cell === 'string' && 
        (cell.toLowerCase().includes('product') || cell.toLowerCase().includes('date')))) {
      startRow = i;
      break;
    }
  }
  
  // Process data rows
  for (let i = startRow + 1; i < data.length; i++) {
    const row = data[i];
    if (!row || row.every(cell => cell === null || cell === '')) continue;
    
    let record = { originalRow: i + 1 };
    
    // Map columns based on sheet type
    switch(type) {
      case 'sales':
        if (row.length >= 4) {
          record = {
            productName: String(row[0] || ''),
            quantity: parseInt(row[1]) || 0,
            unitPrice: parseInt(row[2]) || 0,
            totalAmount: parseInt(row[3]) || 0,
            customer: row[4] || 'Walk-in',
            date: row[6] || todayStr()
          };
        }
        break;
        
      case 'purchases':
        if (row.length >= 4) {
          record = {
            productName: String(row[0] || ''),
            quantity: parseInt(row[1]) || 0,
            unitCost: parseInt(row[2]) || 0,
            totalCost: parseInt(row[3]) || 0,
            supplier: row[4] || '',
            date: row[6] || todayStr()
          };
        }
        break;
    }
    
    if (record.productName && record.quantity > 0) {
      processed.push(record);
    }
  }
  
  return processed;
}

function autoAddToDatabase(data, type, sourceFile) {
  data.forEach(record => {
    switch(type) {
      case 'sales':
        addSaleFromImport(record, sourceFile);
        break;
      case 'purchases':
        addPurchaseFromImport(record, sourceFile);
        break;
    }
  });
}

function addSaleFromImport(record, sourceFile) {
  // Find or create product
  let product = db.products.find(p => 
    p.name.toLowerCase().includes(record.productName.toLowerCase()) ||
    record.productName.toLowerCase().includes(p.name.toLowerCase())
  );
  
  if (!product) {
    // Create new product
    const productId = 'prod_import_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    product = {
      id: productId,
      name: record.productName,
      category: 'imported',
      costPrice: Math.round(record.unitPrice * 0.7), // Estimate cost
      sellingPrice: record.unitPrice,
      currentStock: 0,
      minStockLevel: 5
    };
    db.products.push(product);
  }
  
  // Create sale record
  const saleId = 'sale_import_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
  const sale = {
    id: saleId,
    date: record.date || todayStr(),
    customer: record.customer || 'Imported',
    receiptNo: `IMP-${sourceFile}-${record.originalRow}`,
    items: [{
      productId: product.id,
      qty: record.quantity,
      unitPrice: record.unitPrice,
      total: record.totalAmount || (record.quantity * record.unitPrice)
    }],
    totalAmount: record.totalAmount || (record.quantity * record.unitPrice),
    source: 'excel_import',
    sourceFile: sourceFile
  };
  
  db.sales.push(sale);
  
  // Update product stock
  product.currentStock = Math.max(0, (product.currentStock || 0) - record.quantity);
}

function addPurchaseFromImport(record, sourceFile) {
  // Similar implementation for purchases
  // ... (omitted for brevity, but follows same pattern)
}

/* ========= BATCH PROCESSING ========= */
async function processBatchExcelFiles(files) {
  showLoading(true);
  let totalProcessed = 0;
  
  for (let i = 0; i < files.length; i++) {
    try {
      const result = await processExcelFile(files[i]);
      totalProcessed += result.totalRecords;
      logImport(`✓ ${files[i].name}: ${result.totalRecords} records`);
    } catch (error) {
      logImport(`✗ ${files[i].name}: Error - ${error.message}`);
    }
  }
  
  showLoading(false);
  alert(`Batch processing complete!\nProcessed ${files.length} files with ${totalProcessed} total records.`);
  updateDashboardStats();
  renderAutomationSection();
}

/* ========= GMAIL INTEGRATION ========= */
function showGmailSetupModal() {
  const scriptCode = `// Google Apps Script for Bar Management System
function doGet(e) {
  return ContentService.createTextOutput("Bar Management System Gmail Bridge");
}

function getExcelAttachments() {
  var query = 'has:attachment (filename:xlsx OR filename:xls) subject:daily newer_than:7d';
  var threads = GmailApp.search(query, 0, 10);
  var results = [];
  
  for (var i = 0; i < threads.length; i++) {
    var messages = threads[i].getMessages();
    for (var j = 0; j < messages.length; j++) {
      var attachments = messages[j].getAttachments();
      for (var k = 0; k < attachments.length; k++) {
        var attachment = attachments[k];
        if (attachment.getName().match(/\\.(xlsx|xls)$/i)) {
          results.push({
            messageId: messages[j].getId(),
            subject: messages[j].getSubject(),
            date: messages[j].getDate().toISOString(),
            attachment: {
              name: attachment.getName(),
              data: Utilities.base64Encode(attachment.getBytes()),
              size: attachment.getSize()
            }
          });
        }
      }
    }
  }
  
  return ContentService
    .createTextOutput(JSON.stringify({success: true, count: results.length, files: results}))
    .setMimeType(ContentService.MimeType.JSON);
}`;
  
  document.getElementById('googleScriptCode').value = scriptCode;
  document.getElementById('gmailSetupModal').style.display = 'flex';
}

async function checkGmailForSheets() {
  const webAppUrl = db.automation.gmailWebAppUrl;
  if (!webAppUrl) {
    alert('Please configure Gmail integration first.');
    showGmailSetupModal();
    return;
  }
  
  showLoading(true);
  
  try {
    const response = await fetch(`${webAppUrl}?action=getAttachments`, {
      method: 'GET',
      headers: {
        'Authorization': db.automation.accessToken ? `Bearer ${db.automation.accessToken}` : ''
      }
    });
    
    if (!response.ok) throw new Error('Failed to fetch from Gmail');
    
    const result = await response.json();
    
    if (result.success && result.files && result.files.length > 0) {
      logImport(`Found ${result.files.length} Excel files in Gmail`);
      
      // Process each file
      for (const file of result.files) {
        // Convert base64 to blob and process
        const binary = atob(file.attachment.data);
        const array = new Uint8Array(binary.length);
        for (let i = 0; i < binary.length; i++) {
          array[i] = binary.charCodeAt(i);
        }
        
        const blob = new Blob([array], {type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'});
        const fileObj = new File([blob], file.attachment.name);
        
        await processExcelFile(fileObj);
      }
      
      alert(`Imported ${result.files.length} Excel files from Gmail successfully!`);
    } else {
      logImport('No Excel files found in Gmail');
      alert('No Excel attachments found in your Gmail.');
    }
  } catch (error) {
    console.error('Gmail import error:', error);
    logImport(`Gmail import failed: ${error.message}`);
    alert('Error connecting to Gmail. Check your configuration.');
  }
  
  showLoading(false);
}

/* ========= ENHANCED DASHBOARD & AUTOMATION ========= */
function updateDashboardStats() {
  // Existing stats updates...
  document.getElementById('statProducts').textContent = db.products.length;
  
  // New automation stats
  document.getElementById('statImportedDays').textContent = db.dailySheets.length;
  document.getElementById('processedSheetsCount').textContent = db.automation.processedSheets || 0;
  document.getElementById('autoImportDays').textContent = db.dailySheets.length;
  
  const lastRun = db.automation.lastAutoRun;
  document.getElementById('lastAutoRun').textContent = lastRun ? 
    new Date(lastRun).toLocaleDateString() : 'Never';
  
  document.getElementById('lastImportTime').textContent = db.dailySheets.length > 0 ?
    new Date(db.dailySheets[db.dailySheets.length-1].importDate).toLocaleString() : 'Never';
}

function renderAutomationSection() {
  updateDashboardStats();
  // Update import log display
  const logEntries = db.importLog || [];
  if (logEntries.length > 0) {
    document.getElementById('importLog').textContent = logEntries
      .map(entry => `[${new Date(entry.timestamp).toLocaleString()}] ${entry.message}`)
      .join('\n');
  }
}

/* ========= ENHANCED REPORTING WITH AUTO-AGGREGATION ========= */
function generateAutoAggregatedReport(fromDate, toDate) {
  // Aggregate sales from all sources (manual + imported)
  const allSales = db.sales.filter(s => {
    const saleDate = s.date || todayStr();
    return saleDate >= fromDate && saleDate <= toDate;
  });
  
  // Group by date and product
  const dailySummary = {};
  
  allSales.forEach(sale => {
    const date = sale.date;
    if (!dailySummary[date]) {
      dailySummary[date] = {
        date: date,
        totalSales: 0,
        items: {},
        sourceCount: {
          manual: 0,
          imported: 0
        }
      };
    }
    
    dailySummary[date].totalSales += sale.totalAmount || 0;
    
    if (sale.source === 'excel_import') {
      dailySummary[date].sourceCount.imported++;
    } else {
      dailySummary[date].sourceCount.manual++;
    }
    
    // Aggregate items
    (sale.items || []).forEach(item => {
      const product = getProductById(item.productId);
      const productName = product ? product.name : 'Unknown';
      
      if (!dailySummary[date].items[productName]) {
        dailySummary[date].items[productName] = {
          quantity: 0,
          revenue: 0
        };
      }
      
      dailySummary[date].items[productName].quantity += item.qty || 0;
      dailySummary[date].items[productName].revenue += item.total || 0;
    });
  });
  
  // Generate report HTML
  let html = `<h3>Auto-Aggregated Report: ${fromDate} to ${toDate}</h3>`;
  html += `<div class="grid-3">
    <div class="stat"><span class="muted">Total Days</span><b>${Object.keys(dailySummary).length}</b></div>
    <div class="stat"><span class="muted">Total Sales</span><b>${UGX(Object.values(dailySummary).reduce((sum, day) => sum + day.totalSales, 0))}</b></div>
    <div class="stat"><span class="muted">Imported Sheets</span><b>${db.dailySheets.length}</b></div>
  </div>`;
  
  // Daily breakdown
  Object.keys(dailySummary).sort().reverse().forEach(date => {
    const day = dailySummary[date];
    html += `<div class="card" style="margin-top:12px">
      <h4>${date} (${day.sourceCount.manual} manual, ${day.sourceCount.imported} imported)</h4>
      <div class="grid-2">
        <div>
          <h5>Top Products</h5>
          <table class="table compact-table">
            <thead><tr><th>Product</th><th>Qty</th><th>Revenue</th></tr></thead>
            <tbody>`;
    
    Object.entries(day.items)
      .sort((a, b) => b[1].revenue - a[1].revenue)
      .slice(0, 5)
      .forEach(([product, data]) => {
        html += `<tr>
          <td>${product}</td>
          <td>${data.quantity}</td>
          <td>${UGX(data.revenue)}</td>
        </tr>`;
      });
    
    html += `</tbody></table></div>
        <div style="text-align:center">
          <div class="stat"><span class="muted">Daily Total</span><b>${UGX(day.totalSales)}</b></div>
          <div class="help">Includes data from ${day.sourceCount.imported} imported sheets</div>
        </div>
      </div>
    </div>`;
  });
  
  return html;
}

/* ========= INITIALIZE ENHANCED FUNCTIONALITY ========= */
function initializeEnhancedFeatures() {
  // Excel Template Buttons
  document.getElementById('btnGenerateBlankExcel')?.addEventListener('click', () => {
    generateBlankExcelTemplate('sales');
  });
  document.getElementById('btnTemplateDailySales')?.addEventListener('click', () => {
    generateBlankExcelTemplate('sales');
  });
  document.getElementById('btnTemplateDailyPurchases')?.addEventListener('click', () => {
    generateBlankExcelTemplate('purchases');
  });
  document.getElementById('btnTemplateInventory')?.addEventListener('click', () => {
    generateBlankExcelTemplate('inventory');
  });
  
  // Batch Processing
  document.getElementById('batchExcelFiles')?.addEventListener('change', function(e) {
    if (this.files.length > 0) {
      processBatchExcelFiles(Array.from(this.files));
      this.value = '';
    }
  });
  
  document.getElementById('btnProcessBatch')?.addEventListener('click', () => {
    document.getElementById('batchExcelFiles').click();
  });
  
  // Gmail Integration
  document.getElementById('btnSetupGmail')?.addEventListener('click', showGmailSetupModal);
  document.getElementById('btnCheckGmail')?.addEventListener('click', checkGmailForSheets);
  document.getElementById('btnRunAutoImport')?.addEventListener('click', checkGmailForSheets);
  
  // Modal handling
  document.querySelector('.close-modal')?.addEventListener('click', () => {
    document.getElementById('gmailSetupModal').style.display = 'none';
  });
  
  document.getElementById('btnSaveGmailConfig')?.addEventListener('click', () => {
    db.automation.gmailWebAppUrl = document.getElementById('webAppUrl').value;
    db.automation.accessToken = document.getElementById('accessToken').value;
    save();
    alert('Gmail configuration saved!');
    document.getElementById('gmailSetupModal').style.display = 'none';
  });
  
  // Manual Import
  document.getElementById('btnManualImport')?.addEventListener('click', () => {
    document.getElementById('batchExcelFiles').click();
  });
  
  // Import Log
  document.getElementById('btnViewImportLog')?.addEventListener('click', () => {
    // Already visible in automation section
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelector('[data-tab="automation"]').classList.add('active');
    document.querySelectorAll('.tabpanel').forEach(p => p.hidden = true);
    document.getElementById('automation').hidden = false;
  });
  
  document.getElementById('btnClearLog')?.addEventListener('click', () => {
    if (confirm('Clear import log?')) {
      db.importLog = [];
      save();
      document.getElementById('importLog').textContent = 'Log cleared.';
    }
  });
  
  // Initialize with existing data
  if (db.automation.gmailWebAppUrl) {
    document.getElementById('webAppUrl').value = db.automation.gmailWebAppUrl;
  }
  if (db.automation.accessToken) {
    document.getElementById('accessToken').value = db.automation.accessToken;
  }
  
  // Update tabs to include automation
  const tabsEl = document.getElementById('tabs');
  if(tabsEl) {
    tabsEl.addEventListener('click', e=>{
      const b = e.target.closest('.tab'); if(!b) return;
      document.querySelectorAll('.tab').forEach(x=>x.classList.toggle('active', x===b));
      document.querySelectorAll('.tabpanel').forEach(p=>p.hidden = p.id !== b.dataset.tab);
      if(b.dataset.tab==='automation') renderAutomationSection();
    });
  }
}

/* ========= GOOGLE APPS SCRIPT HELPER ========= */
function copyScriptCode() {
  const textarea = document.getElementById('googleScriptCode');
  textarea.select();
  document.execCommand('copy');
  alert('Script code copied to clipboard!');
}

/* ========= MAIN INITIALIZATION ========= */
document.addEventListener('DOMContentLoaded', () => {
  // Your existing initialization code...
  
  // Initialize enhanced features
  initializeEnhancedFeatures();
  
  // Initial render
  updateDashboardStats();
  renderAutomationSection();
  
  console.log('Enhanced Bar Management System initialized with Excel & Gmail integration!');
});
</script>
</body>
</html>
