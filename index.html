<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>BAR MANAGEMENT SYSTEM – Inventory, Purchases & Sales</title>
<meta name="description" content="Bar stock management system: track purchases, inventory, sales, and profits. Based on your Excel data structure.">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
<style>
  :root{ --brand:#0ea5e9; --brand-d:#0369a1; --ok:#16a34a; --warn:#f59e0b; --bad:#ef4444; --ink:#0f172a; --muted:#64748b; --line:#e2e8f0; --bg:#f8fafc; }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,sans-serif;background:var(--bg);color:var(--ink)}
  header{position:sticky;top:0;z-index:20;background:#fff;border-bottom:1px solid var(--line)}
  .nav{display:flex;gap:12px;align-items:center;justify-content:space-between;padding:12px 16px}
  .brand{display:flex;gap:10px;align-items:center;font-weight:800}
  .brand-badge{width:36px;height:36px;border-radius:10px;background:var(--brand);color:#fff;display:grid;place-items:center}
  .tabs{display:flex;flex-wrap:wrap;gap:8px}
  .tab{border:1px solid var(--line);background:#fff;border-radius:10px;padding:8px 12px;cursor:pointer;font-weight:700}
  .tab.active{background:var(--brand);border-color:var(--brand);color:#fff}
  main{padding:16px;max-width:1420px;margin:0 auto}
  h2{margin:.2rem 0 1rem}
  .row{display:grid;grid-template-columns:repeat(12,1fr);gap:12px}
  .card{background:#fff;border:1px solid var(--line);border-radius:12px;padding:12px}
  .card h3{margin:.3rem 0 .8rem}
  label{font-size:12px;color:var(--muted);display:block;margin-bottom:4px}
  input,select,button,textarea{font:inherit}
  input[type="number"],input[type="date"],input[type="text"],input[type="tel"],select,textarea{width:100%;padding:10px;border:1px solid var(--line);border-radius:8px;background:#fff}
  .btn{padding:10px 14px;border-radius:10px;border:1px solid var(--line);background:#fff;cursor:pointer;font-weight:700}
  .btn.primary{background:var(--brand);border-color:var(--brand);color:#fff}
  .btn.primary:hover{background:var(--brand-d);border-color:var(--brand-d)}
  .btn.ok{background:var(--ok);border-color:var(--ok);color:#fff}
  .btn.warn{background:var(--warn);border-color:var(--warn);color:#111827}
  .btn.bad{background:var(--bad);border-color:var(--bad);color:#fff}
  .stack{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
  .muted{color:var(--muted)}
  .pill{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid var(--line);background:#f1f5f9;font-size:12px}
  .table{width:100%;border-collapse:collapse}
  .table th,.table td{border-bottom:1px dashed var(--line);padding:8px;text-align:left;font-size:14px}
  .help{font-size:12px;color:var(--muted)}
  .right{display:flex;justify-content:flex-end;gap:8px}
  .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .grid-3{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
  .grid-4{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
  @media (max-width: 900px){ .row{grid-template-columns:1fr} .grid-2,.grid-3,.grid-4{grid-template-columns:1fr} }
  .stat{padding:10px;border:1px solid var(--line);border-radius:10px;background:#fff}
  .stat b{display:block;font-size:20px;margin-top:4px}
  .hr{height:1px;background:var(--line);margin:12px 0}
  .warnmsg{background:#fff7ed;border:1px solid #fdba74;color:#9a3412;padding:8px;border-radius:10px}
  .goodmsg{background:#ecfdf5;border:1px solid #86efac;color:#065f46;padding:8px;border-radius:10px}
  .mono{font-family: ui-monospace, Menlo, Consolas, "Courier New", monospace; white-space: pre-wrap;}
  img{max-width:100%}
  .section-tools{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .compact-table{font-size:12px}
  .compact-table th,.compact-table td{padding:4px 6px}
  @media print {
    header, .tabs, .section-tools, .btn { display:none !important; }
    main{max-width:none}
    .card{border:0}
  }
</style>
</head>
<body>
  <header>
    <div class="nav">
      <div class="brand"><div class="brand-badge">B</div> BAR MANAGEMENT SYSTEM</div>
      <div class="tabs" id="tabs">
        <button class="tab active" data-tab="dashboard">Dashboard</button>
        <button class="tab" data-tab="inventory">Inventory</button>
        <button class="tab" data-tab="purchases">Purchases</button>
        <button class="tab" data-tab="sales">Sales</button>
        <button class="tab" data-tab="products">Products</button>
        <button class="tab" data-tab="reports">Reports</button>
        <button class="tab" data-tab="data">Data</button>
      </div>
    </div>
  </header>

  <main>
    <!-- DASHBOARD -->
    <section id="dashboard" class="tabpanel">
      <h2>Bar Dashboard</h2>
      <div class="grid-4">
        <div class="stat"><span class="muted">Total Products</span><b id="statProducts">0</b></div>
        <div class="stat"><span class="muted">Current Stock Value</span><b id="statStockValue">UGX 0</b></div>
        <div class="stat"><span class="muted">Today's Sales</span><b id="statTodaySales">UGX 0</b></div>
        <div class="stat"><span class="muted">Month Purchases</span><b id="statMonthPurchases">UGX 0</b></div>
      </div>
      <div class="grid-4" style="margin-top:8px">
        <div class="stat"><span class="muted">Profit Margin</span><b id="statProfitMargin">0%</b></div>
        <div class="stat"><span class="muted">Fast Moving Items</span><b id="statFastMoving">0</b></div>
        <div class="stat"><span class="muted">Low Stock Items</span><b id="statLowStock">0</b></div>
        <div class="stat"><span class="muted">Expiring Soon</span><b id="statExpiring">0</b></div>
      </div>
      
      <div class="hr"></div>
      
      <div class="grid-2">
        <div class="card">
          <h3>Quick Actions</h3>
          <div class="stack">
            <button class="btn primary" id="btnNewPurchase">New Purchase</button>
            <button class="btn ok" id="btnNewSale">Record Sale</button>
            <button class="btn" id="btnToday">Today</button>
            <button class="btn" id="btnBackup">Export data (JSON)</button>
            <label class="btn"><input type="file" id="restoreFile" accept="application/json" style="display:none">Import data</label>
            <button class="btn" id="btnSaveNow">Save</button>
          </div>
          <p class="help">All data saves locally (browser). Use export/import for backups.</p>
        </div>
        
        <div class="card">
          <h3>Print & Tools</h3>
          <div class="stack section-tools">
            <button class="btn" id="btnPrintStock">Stock Report</button>
            <button class="btn" id="btnPrintSales">Sales Report</button>
            <button class="btn" id="btnPrintPurchases">Purchase Report</button>
          </div>
        </div>
      </div>
      
      <div class="hr"></div>
      
      <div class="grid-2">
        <div class="card">
          <h3>Recent Sales</h3>
          <table class="table compact-table" id="recentSalesTable">
            <thead><tr><th>Date</th><th>Product</th><th>Qty</th><th>Amount</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
        
        <div class="card">
          <h3>Low Stock Alert</h3>
          <table class="table compact-table" id="lowStockTable">
            <thead><tr><th>Product</th><th>Stock</th><th>Min Level</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- INVENTORY -->
    <section id="inventory" class="tabpanel" hidden>
      <div class="card">
        <div class="section-tools">
          <h3 style="margin-right:auto">Inventory Management</h3>
          <button class="btn" id="btnPrintInventory">Print</button>
          <button class="btn" id="btnExportInventory">Export CSV</button>
        </div>
        
        <div class="grid-3">
          <div>
            <label>Stock Date</label>
            <input type="date" id="inventoryDate" value="">
          </div>
          <div>
            <label>Filter by Category</label>
            <select id="filterCategory">
              <option value="">All Categories</option>
              <option value="spirits">Spirits</option>
              <option value="beer">Beer</option>
              <option value="soft">Soft Drinks</option>
              <option value="wine">Wine</option>
              <option value="energy">Energy Drinks</option>
            </select>
          </div>
          <div class="right" style="align-items:end">
            <button class="btn primary" id="btnUpdateInventory">Update Inventory</button>
          </div>
        </div>
        
        <div class="hr"></div>
        
        <table class="table" id="inventoryTable">
          <thead>
            <tr>
              <th>Product</th>
              <th>Category</th>
              <th>Opening Stock</th>
              <th>Purchased Today</th>
              <th>Total Available</th>
              <th>Sold Today</th>
              <th>Closing Stock</th>
              <th>Unit Price</th>
              <th>Stock Value</th>
              <th>Min Level</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- PURCHASES -->
    <section id="purchases" class="tabpanel" hidden>
      <div class="grid-2">
        <div class="card">
          <h3>Record Purchase</h3>
          <div class="grid-3">
            <div>
              <label>Purchase Date</label>
              <input type="date" id="purchaseDate" value="">
            </div>
            <div>
              <label>Supplier</label>
              <input type="text" id="purchaseSupplier" placeholder="Supplier name">
            </div>
            <div>
              <label>Receipt No</label>
              <input type="text" id="purchaseReceiptNo" placeholder="Optional">
            </div>
          </div>
          
          <div class="hr" style="margin:12px 0"></div>
          
          <h4>Purchase Items</h4>
          <div class="grid-4" style="margin-bottom:8px">
            <div>
              <label>Product</label>
              <select id="purchaseProduct"></select>
            </div>
            <div>
              <label>Quantity</label>
              <input type="number" id="purchaseQty" min="1" value="1">
            </div>
            <div>
              <label>Unit Price (UGX)</label>
              <input type="number" id="purchasePrice" min="0" step="1" value="0">
            </div>
            <div style="align-self:end">
              <button class="btn" id="btnAddPurchaseItem">Add Item</button>
            </div>
          </div>
          
          <table class="table compact-table" id="purchaseItemsTable">
            <thead><tr><th>Product</th><th>Qty</th><th>Unit Price</th><th>Total</th><th></th></tr></thead>
            <tbody></tbody>
          </table>
          
          <div class="right" style="margin-top:10px">
            <div class="stat">
              <span class="muted">Total Amount</span>
              <b id="purchaseTotal">UGX 0</b>
            </div>
            <button class="btn ok" id="btnSavePurchase">Save Purchase</button>
          </div>
        </div>
        
        <div class="card">
          <h3>Recent Purchases</h3>
          <div class="grid-3" style="margin-bottom:12px">
            <div>
              <label>From Date</label>
              <input type="date" id="purchaseFrom">
            </div>
            <div>
              <label>To Date</label>
              <input type="date" id="purchaseTo">
            </div>
            <div style="align-self:end">
              <button class="btn" id="btnFilterPurchases">Filter</button>
            </div>
          </div>
          
          <table class="table compact-table" id="purchasesTable">
            <thead><tr><th>Date</th><th>Supplier</th><th>Items</th><th>Total</th><th></th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- SALES -->
    <section id="sales" class="tabpanel" hidden>
      <div class="grid-2">
        <div class="card">
          <h3>Record Sale</h3>
          <div class="grid-3">
            <div>
              <label>Sale Date</label>
              <input type="date" id="saleDate" value="">
            </div>
            <div>
              <label>Customer</label>
              <input type="text" id="saleCustomer" placeholder="Walk-in / Customer name">
            </div>
            <div>
              <label>Receipt No</label>
              <input type="text" id="saleReceiptNo" placeholder="Optional">
            </div>
          </div>
          
          <div class="hr" style="margin:12px 0"></div>
          
          <h4>Sale Items</h4>
          <div class="grid-4" style="margin-bottom:8px">
            <div>
              <label>Product</label>
              <select id="saleProduct"></select>
            </div>
            <div>
              <label>Quantity</label>
              <input type="number" id="saleQty" min="1" value="1">
            </div>
            <div>
              <label>Unit Price (UGX)</label>
              <input type="number" id="salePrice" min="0" step="1" value="0">
            </div>
            <div style="align-self:end">
              <button class="btn" id="btnAddSaleItem">Add Item</button>
            </div>
          </div>
          
          <table class="table compact-table" id="saleItemsTable">
            <thead><tr><th>Product</th><th>Qty</th><th>Unit Price</th><th>Total</th><th></th></tr></thead>
            <tbody></tbody>
          </table>
          
          <div class="right" style="margin-top:10px">
            <div class="stat">
              <span class="muted">Total Amount</span>
              <b id="saleTotal">UGX 0</b>
            </div>
            <button class="btn ok" id="btnSaveSale">Save Sale</button>
          </div>
        </div>
        
        <div class="card">
          <h3>Recent Sales</h3>
          <div class="grid-3" style="margin-bottom:12px">
            <div>
              <label>From Date</label>
              <input type="date" id="saleFrom">
            </div>
            <div>
              <label>To Date</label>
              <input type="date" id="saleTo">
            </div>
            <div style="align-self:end">
              <button class="btn" id="btnFilterSales">Filter</button>
            </div>
          </div>
          
          <table class="table compact-table" id="salesHistoryTable">
            <thead><tr><th>Date</th><th>Customer</th><th>Items</th><th>Total</th><th></th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- PRODUCTS -->
    <section id="products" class="tabpanel" hidden>
      <div class="row">
        <div class="card" style="grid-column: span 4;">
          <h3>Add / Edit Product</h3>
          <div>
            <label>Product Name</label>
            <input id="productName" type="text" placeholder="e.g., Gilbeys (s)">
          </div>
          <div style="margin-top:8px">
            <label>Category</label>
            <select id="productCategory">
              <option value="spirits">Spirits</option>
              <option value="beer">Beer</option>
              <option value="soft">Soft Drinks</option>
              <option value="wine">Wine</option>
              <option value="energy">Energy Drinks</option>
              <option value="other">Other</option>
            </select>
          </div>
          <div class="grid-2" style="margin-top:8px;gap:8px">
            <div>
              <label>Unit Cost (UGX)</label>
              <input id="productCost" type="number" min="0" step="1" value="0">
            </div>
            <div>
              <label>Selling Price (UGX)</label>
              <input id="productPrice" type="number" min="0" step="1" value="0">
            </div>
          </div>
          <div class="grid-2" style="margin-top:8px;gap:8px">
            <div>
              <label>Current Stock</label>
              <input id="productStock" type="number" min="0" step="1" value="0">
            </div>
            <div>
              <label>Min Stock Level</label>
              <input id="productMinStock" type="number" min="0" step="1" value="5">
            </div>
          </div>
          <div class="stack" style="margin-top:10px">
            <button class="btn primary" id="btnSaveProduct">Save Product</button>
            <button class="btn bad" id="btnDeleteProduct" disabled>Delete</button>
          </div>
          <p class="help">Products from your Excel: Gilbeys, Ug Plastic, HIGH 5, 4 COUSINS, etc.</p>
        </div>
        
        <div class="card" style="grid-column: span 8;">
          <h3>Product List</h3>
          <div class="section-tools" style="margin-bottom:12px">
            <input type="text" id="productSearch" placeholder="Search products..." style="flex:1">
            <select id="productSort">
              <option value="name">Sort by Name</option>
              <option value="category">Sort by Category</option>
              <option value="stock">Sort by Stock</option>
            </select>
          </div>
          
          <table class="table" id="productsTable">
            <thead>
              <tr>
                <th>Product</th>
                <th>Category</th>
                <th>Stock</th>
                <th>Min Level</th>
                <th>Cost Price</th>
                <th>Selling Price</th>
                <th>Margin</th>
                <th>Stock Value</th>
                <th></th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- REPORTS -->
    <section id="reports" class="tabpanel" hidden>
      <div class="card">
        <div class="section-tools">
          <h3 style="margin-right:auto">Daily Sales Report</h3>
          <button class="btn" id="btnPrintDailyReport">Print</button>
          <button class="btn" id="btnExportDailyCSV">Export CSV</button>
        </div>
        <div class="grid-3">
          <div>
            <label>Report Date</label>
            <input type="date" id="reportDate" value="">
          </div>
          <div>
            <label>Compare With</label>
            <input type="date" id="compareDate">
          </div>
          <div class="right" style="align-items:end">
            <button class="btn primary" id="btnGenerateDaily">Generate Report</button>
          </div>
        </div>
        <div class="hr"></div>
        <div id="dailyReportOut"></div>
      </div>

      <div class="card" style="margin-top:12px">
        <div class="section-tools">
          <h3 style="margin-right:auto">Profit & Loss Statement</h3>
          <button class="btn" id="btnPrintPandL">Print</button>
        </div>
        <div class="grid-3">
          <div>
            <label>From Date</label>
            <input type="date" id="plFrom">
          </div>
          <div>
            <label>To Date</label>
            <input type="date" id="plTo">
          </div>
          <div class="right" style="align-items:end">
            <button class="btn primary" id="btnGeneratePandL">Generate P&L</button>
          </div>
        </div>
        <div class="hr"></div>
        <div id="plOut"></div>
      </div>

      <div class="card" style="margin-top:12px">
        <div class="section-tools">
          <h3 style="margin-right:auto">Stock Movement Report</h3>
          <button class="btn" id="btnPrintStockMovement">Print</button>
        </div>
        <div class="grid-3">
          <div>
            <label>Product</label>
            <select id="movementProduct">
              <option value="all">All Products</option>
            </select>
          </div>
          <div>
            <label>From Date</label>
            <input type="date" id="movementFrom">
          </div>
          <div>
            <label>To Date</label>
            <input type="date" id="movementTo">
          </div>
        </div>
        <div class="right" style="align-items:end;margin-top:8px">
          <button class="btn primary" id="btnGenerateMovement">Generate Report</button>
        </div>
        <div class="hr"></div>
        <div id="movementOut"></div>
      </div>
    </section>

    <!-- DATA -->
    <section id="data" class="tabpanel" hidden>
      <div class="grid-2">
        <div class="card">
          <h3>Backup / Restore (Local JSON)</h3>
          <div class="stack section-tools">
            <button class="btn primary" id="btnBackup2">Export JSON</button>
            <label class="btn"><input type="file" id="restoreFile2" accept="application/json" style="display:none">Import JSON</label>
            <button class="btn" id="btnSaveNow2">Save</button>
          </div>
          <p class="help">Exports all products, purchases, sales, and inventory data.</p>
        </div>

        <div class="card">
          <h3>Excel Import / Export</h3>
          <div class="stack section-tools">
            <button class="btn" id="btnExportExcel">Export Excel</button>
            <label class="btn"><input type="file" id="importExcel" accept=".xlsx,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" style="display:none">Import Excel</label>
          </div>
          <p class="help">Import your existing Excel data (kaka.xlsx format).</p>
        </div>

        <div class="card">
          <h3>Initialize from Your Excel</h3>
          <div class="stack section-tools">
            <button class="btn ok" id="btnInitFromExcel">Initialize Products</button>
          </div>
          <p class="help">Will create products from your Excel file data.</p>
        </div>

        <div class="card">
          <h3>Danger Zone</h3>
          <button class="btn bad" id="btnWipe">Reset ALL data</button>
          <p class="help">Irreversible (unless you exported a backup).</p>
        </div>
      </div>
    </section>
  </main>

<script>
/* ========= Utilities ========= */
const UGX = (v)=> new Intl.NumberFormat('en-UG', {style:'currency', currency:'UGX', maximumFractionDigits:0}).format(v||0);
const todayStr = ()=> new Date().toLocaleDateString('en-CA', { timeZone: 'Africa/Kampala' });
const parseDate = s => new Date(s+'T00:00:00');
const daysBetween = (a,b)=> Math.max(0, Math.round((parseDate(b)-parseDate(a)) / (1000*60*60*24)));
const clone = x => JSON.parse(JSON.stringify(x));
function download(filename, blob){
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = filename;
  a.click();
  setTimeout(()=> URL.revokeObjectURL(a.href), 1000);
}

/* ========= Data Model ========= */
const KEY='bar_management_v1';
let db = {};
try { db = JSON.parse(localStorage.getItem(KEY) || '{}'); }
catch(e){ console.warn('Local data corrupted. Resetting storage.', e); localStorage.removeItem(KEY); db = {}; }

// Initialize if empty
if(!db.products){
  db = {
    products: [], // {id, name, category, costPrice, sellingPrice, currentStock, minStockLevel}
    purchases: [], // {id, date, supplier, receiptNo, items:[{productId, qty, unitPrice, total}], totalAmount}
    sales: [], // {id, date, customer, receiptNo, items:[{productId, qty, unitPrice, total}], totalAmount}
    inventory: [], // {date, productId, openingStock, purchased, sold, closingStock}
    settings: { updatedAt: new Date().toISOString() }
  };
  save();
}

function save(){
  db.settings.updatedAt = new Date().toISOString();
  localStorage.setItem(KEY, JSON.stringify(db));
}

/* ========= Tabs ========= */
function wireTabs(){
  const tabsEl = document.getElementById('tabs');
  if(!tabsEl) return;
  tabsEl.addEventListener('click', e=>{
    const b = e.target.closest('.tab'); if(!b) return;
    document.querySelectorAll('.tab').forEach(x=>x.classList.toggle('active', x===b));
    document.querySelectorAll('.tabpanel').forEach(p=>p.hidden = p.id !== b.dataset.tab);
    if(b.dataset.tab==='dashboard') renderDashboard();
    if(b.dataset.tab==='inventory') renderInventory();
    if(b.dataset.tab==='purchases') renderPurchases();
    if(b.dataset.tab==='sales') renderSales();
    if(b.dataset.tab==='products') renderProducts();
    if(b.dataset.tab==='reports') initReports();
    if(b.dataset.tab==='data') { /* nothing extra */ }
  });
}

/* ========= Dashboard ========= */
function renderDashboard(){
  // Update stats
  document.getElementById('statProducts').textContent = db.products.length;
  
  const stockValue = db.products.reduce((sum, p) => sum + (p.currentStock || 0) * (p.costPrice || 0), 0);
  document.getElementById('statStockValue').textContent = UGX(stockValue);
  
  const today = todayStr();
  const todaySales = db.sales
    .filter(s => s.date === today)
    .reduce((sum, s) => sum + (s.totalAmount || 0), 0);
  document.getElementById('statTodaySales').textContent = UGX(todaySales);
  
  const month = today.slice(0, 7); // YYYY-MM
  const monthPurchases = db.purchases
    .filter(p => p.date && p.date.startsWith(month))
    .reduce((sum, p) => sum + (p.totalAmount || 0), 0);
  document.getElementById('statMonthPurchases').textContent = UGX(monthPurchases);
  
  // Calculate profit margin (average)
  let totalCost = 0;
  let totalPrice = 0;
  db.products.forEach(p => {
    totalCost += p.costPrice || 0;
    totalPrice += p.sellingPrice || 0;
  });
  const avgMargin = totalCost > 0 ? ((totalPrice - totalCost) / totalCost * 100).toFixed(1) : 0;
  document.getElementById('statProfitMargin').textContent = `${avgMargin}%`;
  
  // Fast moving items (sold today)
  const fastMoving = db.sales
    .filter(s => s.date === today)
    .flatMap(s => s.items || [])
    .reduce((acc, item) => {
      acc[item.productId] = (acc[item.productId] || 0) + (item.qty || 0);
      return acc;
    }, {});
  const fastMovingCount = Object.keys(fastMoving).length;
  document.getElementById('statFastMoving').textContent = fastMovingCount;
  
  // Low stock items
  const lowStock = db.products.filter(p => (p.currentStock || 0) <= (p.minStockLevel || 5)).length;
  document.getElementById('statLowStock').textContent = lowStock;
  
  // Recent sales table
  const recentSalesTbody = document.querySelector('#recentSalesTable tbody');
  if(recentSalesTbody){
    const recentSales = [...db.sales]
      .sort((a,b) => new Date(b.date) - new Date(a.date))
      .slice(0, 10)
      .flatMap(sale => (sale.items || []).map(item => ({
        date: sale.date,
        product: getProductById(item.productId)?.name || 'Unknown',
        qty: item.qty,
        amount: item.total
      })));
    
    recentSalesTbody.innerHTML = recentSales.map(s => `
      <tr>
        <td>${s.date}</td>
        <td>${s.product}</td>
        <td>${s.qty}</td>
        <td>${UGX(s.amount)}</td>
      </tr>
    `).join('');
  }
  
  // Low stock table
  const lowStockTbody = document.querySelector('#lowStockTable tbody');
  if(lowStockTbody){
    const lowStockItems = db.products
      .filter(p => (p.currentStock || 0) <= (p.minStockLevel || 5))
      .slice(0, 10);
    
    lowStockTbody.innerHTML = lowStockItems.map(p => `
      <tr>
        <td>${p.name}</td>
        <td>${p.currentStock || 0}</td>
        <td>${p.minStockLevel || 5}</td>
      </tr>
    `).join('');
  }
}

/* ========= Products Management ========= */
let editingProductId = null;

function getProductById(id){
  return db.products.find(p => p.id === id);
}

function getProductByName(name){
  return db.products.find(p => p.name.toLowerCase() === name.toLowerCase());
}

function renderProducts(){
  const searchTerm = document.getElementById('productSearch')?.value.toLowerCase() || '';
  const sortBy = document.getElementById('productSort')?.value || 'name';
  
  let filtered = [...db.products];
  
  if(searchTerm){
    filtered = filtered.filter(p => 
      p.name.toLowerCase().includes(searchTerm) || 
      (p.category || '').toLowerCase().includes(searchTerm)
    );
  }
  
  filtered.sort((a,b) => {
    if(sortBy === 'name') return a.name.localeCompare(b.name);
    if(sortBy === 'category') return (a.category || '').localeCompare(b.category || '');
    if(sortBy === 'stock') return (b.currentStock || 0) - (a.currentStock || 0);
    return 0;
  });
  
  const tbody = document.querySelector('#productsTable tbody');
  if(tbody){
    tbody.innerHTML = filtered.map(p => {
      const margin = p.costPrice > 0 ? ((p.sellingPrice - p.costPrice) / p.costPrice * 100).toFixed(1) : 0;
      const stockValue = (p.currentStock || 0) * (p.costPrice || 0);
      const isLowStock = (p.currentStock || 0) <= (p.minStockLevel || 5);
      
      return `
      <tr ${isLowStock ? 'style="background:#fff7ed"' : ''}>
        <td><b>${p.name}</b></td>
        <td><span class="pill">${p.category || 'other'}</span></td>
        <td>${p.currentStock || 0}</td>
        <td>${p.minStockLevel || 5}</td>
        <td>${UGX(p.costPrice || 0)}</td>
        <td>${UGX(p.sellingPrice || 0)}</td>
        <td>${margin}%</td>
        <td>${UGX(stockValue)}</td>
        <td><button class="btn" data-edit="${p.id}">Edit</button></td>
      </tr>
    `}).join('');
  }
  
  // Populate product selects
  const purchaseSelect = document.getElementById('purchaseProduct');
  const saleSelect = document.getElementById('saleProduct');
  const movementSelect = document.getElementById('movementProduct');
  
  if(purchaseSelect){
    purchaseSelect.innerHTML = '<option value="">Select Product</option>' +
      db.products.map(p => `<option value="${p.id}">${p.name} (Stock: ${p.currentStock || 0})</option>`).join('');
  }
  
  if(saleSelect){
    saleSelect.innerHTML = '<option value="">Select Product</option>' +
      db.products.map(p => `<option value="${p.id}">${p.name} (Stock: ${p.currentStock || 0})</option>`).join('');
  }
  
  if(movementSelect){
    movementSelect.innerHTML = '<option value="all">All Products</option>' +
      db.products.map(p => `<option value="${p.id}">${p.name}</option>`).join('');
  }
}

function resetProductForm(){
  editingProductId = null;
  document.getElementById('productName').value = '';
  document.getElementById('productCategory').value = 'spirits';
  document.getElementById('productCost').value = '0';
  document.getElementById('productPrice').value = '0';
  document.getElementById('productStock').value = '0';
  document.getElementById('productMinStock').value = '5';
  document.getElementById('btnDeleteProduct').disabled = true;
}

function wireProducts(){
  // Edit product
  document.getElementById('productsTable')?.addEventListener('click', e => {
    const editBtn = e.target.closest('[data-edit]');
    if(!editBtn) return;
    
    const productId = editBtn.dataset.edit;
    const product = getProductById(productId);
    if(!product) return;
    
    editingProductId = productId;
    document.getElementById('productName').value = product.name;
    document.getElementById('productCategory').value = product.category || 'spirits';
    document.getElementById('productCost').value = product.costPrice || 0;
    document.getElementById('productPrice').value = product.sellingPrice || 0;
    document.getElementById('productStock').value = product.currentStock || 0;
    document.getElementById('productMinStock').value = product.minStockLevel || 5;
    document.getElementById('btnDeleteProduct').disabled = false;
  });
  
  // Save product
  document.getElementById('btnSaveProduct')?.addEventListener('click', () => {
    const name = document.getElementById('productName').value.trim();
    if(!name){ alert('Enter product name'); return; }
    
    const category = document.getElementById('productCategory').value;
    const costPrice = parseInt(document.getElementById('productCost').value) || 0;
    const sellingPrice = parseInt(document.getElementById('productPrice').value) || 0;
    const currentStock = parseInt(document.getElementById('productStock').value) || 0;
    const minStockLevel = parseInt(document.getElementById('productMinStock').value) || 5;
    
    if(editingProductId){
      const product = getProductById(editingProductId);
      if(product){
        product.name = name;
        product.category = category;
        product.costPrice = costPrice;
        product.sellingPrice = sellingPrice;
        product.currentStock = currentStock;
        product.minStockLevel = minStockLevel;
      }
    } else {
      const id = 'p_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
      db.products.push({
        id,
        name,
        category,
        costPrice,
        sellingPrice,
        currentStock,
        minStockLevel
      });
    }
    
    save();
    renderProducts();
    renderDashboard();
    resetProductForm();
    alert('Product saved!');
  });
  
  // Delete product
  document.getElementById('btnDeleteProduct')?.addEventListener('click', () => {
    if(!editingProductId || !confirm('Delete this product?')) return;
    
    db.products = db.products.filter(p => p.id !== editingProductId);
    // Also remove from purchases and sales
    db.purchases = db.purchases.filter(p => {
      p.items = p.items.filter(item => item.productId !== editingProductId);
      return p.items.length > 0;
    });
    db.sales = db.sales.filter(s => {
      s.items = s.items.filter(item => item.productId !== editingProductId);
      return s.items.length > 0;
    });
    
    save();
    renderProducts();
    renderDashboard();
    resetProductForm();
  });
  
  // Search products
  document.getElementById('productSearch')?.addEventListener('input', renderProducts);
  document.getElementById('productSort')?.addEventListener('change', renderProducts);
}

/* ========= Purchases Management ========= */
let currentPurchaseItems = [];

function renderPurchases(){
  // Set today's date
  const today = todayStr();
  document.getElementById('purchaseDate').value = today;
  document.getElementById('purchaseFrom').value = today;
  document.getElementById('purchaseTo').value = today;
  
  // Reset purchase form
  currentPurchaseItems = [];
  document.getElementById('purchaseSupplier').value = '';
  document.getElementById('purchaseReceiptNo').value = '';
  document.getElementById('purchaseQty').value = '1';
  document.getElementById('purchasePrice').value = '';
  document.getElementById('purchaseTotal').textContent = 'UGX 0';
  renderPurchaseItemsTable();
  
  // Load recent purchases
  const from = document.getElementById('purchaseFrom').value || today;
  const to = document.getElementById('purchaseTo').value || today;
  
  const filteredPurchases = db.purchases.filter(p => {
    if(!p.date) return false;
    return p.date >= from && p.date <= to;
  }).sort((a,b) => new Date(b.date) - new Date(a.date));
  
  const tbody = document.querySelector('#purchasesTable tbody');
  if(tbody){
    tbody.innerHTML = filteredPurchases.map(p => {
      const itemCount = p.items?.length || 0;
      const itemNames = p.items?.map(item => {
        const product = getProductById(item.productId);
        return product ? `${product.name} (${item.qty})` : 'Unknown';
      }).join(', ') || '';
      
      return `
      <tr>
        <td>${p.date}</td>
        <td>${p.supplier || '-'}</td>
        <td title="${itemNames}">${itemCount} items</td>
        <td>${UGX(p.totalAmount || 0)}</td>
        <td><button class="btn" data-view-purchase="${p.id}">View</button></td>
      </tr>
    `}).join('');
  }
}

function renderPurchaseItemsTable(){
  const tbody = document.querySelector('#purchaseItemsTable tbody');
  if(!tbody) return;
  
  const total = currentPurchaseItems.reduce((sum, item) => sum + (item.total || 0), 0);
  document.getElementById('purchaseTotal').textContent = UGX(total);
  
  tbody.innerHTML = currentPurchaseItems.map((item, index) => {
    const product = getProductById(item.productId);
    return `
    <tr>
      <td>${product?.name || 'Unknown'}</td>
      <td>${item.qty}</td>
      <td>${UGX(item.unitPrice)}</td>
      <td>${UGX(item.total)}</td>
      <td><button class="btn bad" data-remove="${index}">×</button></td>
    </tr>
  `}).join('');
}

function wirePurchases(){
  // Add item to purchase
  document.getElementById('btnAddPurchaseItem')?.addEventListener('click', () => {
    const productId = document.getElementById('purchaseProduct').value;
    const qty = parseInt(document.getElementById('purchaseQty').value) || 1;
    const unitPrice = parseInt(document.getElementById('purchasePrice').value) || 0;
    
    if(!productId){ alert('Select a product'); return; }
    if(qty <= 0){ alert('Enter valid quantity'); return; }
    if(unitPrice <= 0){ alert('Enter valid price'); return; }
    
    const product = getProductById(productId);
    if(!product){ alert('Product not found'); return; }
    
    currentPurchaseItems.push({
      productId,
      qty,
      unitPrice,
      total: qty * unitPrice
    });
    
    renderPurchaseItemsTable();
    
    // Reset form
    document.getElementById('purchaseQty').value = '1';
    document.getElementById('purchasePrice').value = '';
  });
  
  // Remove item from purchase
  document.getElementById('purchaseItemsTable')?.addEventListener('click', e => {
    const removeBtn = e.target.closest('[data-remove]');
    if(!removeBtn) return;
    
    const index = parseInt(removeBtn.dataset.remove);
    currentPurchaseItems.splice(index, 1);
    renderPurchaseItemsTable();
  });
  
  // Save purchase
  document.getElementById('btnSavePurchase')?.addEventListener('click', () => {
    if(currentPurchaseItems.length === 0){ alert('Add items to purchase'); return; }
    
    const date = document.getElementById('purchaseDate').value || todayStr();
    const supplier = document.getElementById('purchaseSupplier').value.trim() || 'Unknown Supplier';
    const receiptNo = document.getElementById('purchaseReceiptNo').value.trim() || '';
    const totalAmount = currentPurchaseItems.reduce((sum, item) => sum + item.total, 0);
    
    const purchaseId = 'purchase_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    
    // Update product stocks
    currentPurchaseItems.forEach(item => {
      const product = getProductById(item.productId);
      if(product){
        product.currentStock = (product.currentStock || 0) + item.qty;
      }
    });
    
    db.purchases.push({
      id: purchaseId,
      date,
      supplier,
      receiptNo,
      items: [...currentPurchaseItems],
      totalAmount
    });
    
    save();
    renderPurchases();
    renderProducts();
    renderDashboard();
    alert('Purchase saved! Stock updated.');
  });
  
  // Filter purchases
  document.getElementById('btnFilterPurchases')?.addEventListener('click', renderPurchases);
}

/* ========= Sales Management ========= */
let currentSaleItems = [];

function renderSales(){
  // Set today's date
  const today = todayStr();
  document.getElementById('saleDate').value = today;
  document.getElementById('saleFrom').value = today;
  document.getElementById('saleTo').value = today;
  
  // Reset sale form
  currentSaleItems = [];
  document.getElementById('saleCustomer').value = 'Walk-in';
  document.getElementById('saleReceiptNo').value = '';
  document.getElementById('saleQty').value = '1';
  document.getElementById('salePrice').value = '';
  document.getElementById('saleTotal').textContent = 'UGX 0';
  renderSaleItemsTable();
  
  // Load recent sales
  const from = document.getElementById('saleFrom').value || today;
  const to = document.getElementById('saleTo').value || today;
  
  const filteredSales = db.sales.filter(s => {
    if(!s.date) return false;
    return s.date >= from && s.date <= to;
  }).sort((a,b) => new Date(b.date) - new Date(a.date));
  
  const tbody = document.querySelector('#salesHistoryTable tbody');
  if(tbody){
    tbody.innerHTML = filteredSales.map(s => {
      const itemCount = s.items?.length || 0;
      const itemNames = s.items?.map(item => {
        const product = getProductById(item.productId);
        return product ? `${product.name} (${item.qty})` : 'Unknown';
      }).join(', ') || '';
      
      return `
      <tr>
        <td>${s.date}</td>
        <td>${s.customer || 'Walk-in'}</td>
        <td title="${itemNames}">${itemCount} items</td>
        <td>${UGX(s.totalAmount || 0)}</td>
        <td><button class="btn" data-view-sale="${s.id}">View</button></td>
      </tr>
    `}).join('');
  }
}

function renderSaleItemsTable(){
  const tbody = document.querySelector('#saleItemsTable tbody');
  if(!tbody) return;
  
  const total = currentSaleItems.reduce((sum, item) => sum + (item.total || 0), 0);
  document.getElementById('saleTotal').textContent = UGX(total);
  
  tbody.innerHTML = currentSaleItems.map((item, index) => {
    const product = getProductById(item.productId);
    return `
    <tr>
      <td>${product?.name || 'Unknown'}</td>
      <td>${item.qty}</td>
      <td>${UGX(item.unitPrice)}</td>
      <td>${UGX(item.total)}</td>
      <td><button class="btn bad" data-remove-sale="${index}">×</button></td>
    </tr>
  `}).join('');
}

function wireSales(){
  // Add item to sale
  document.getElementById('btnAddSaleItem')?.addEventListener('click', () => {
    const productId = document.getElementById('saleProduct').value;
    const qty = parseInt(document.getElementById('saleQty').value) || 1;
    const unitPrice = parseInt(document.getElementById('salePrice').value) || 0;
    
    if(!productId){ alert('Select a product'); return; }
    if(qty <= 0){ alert('Enter valid quantity'); return; }
    
    const product = getProductById(productId);
    if(!product){ alert('Product not found'); return; }
    
    // Check stock availability
    if((product.currentStock || 0) < qty){
      if(!confirm(`Only ${product.currentStock || 0} items in stock. Continue anyway?`)){
        return;
      }
    }
    
    // Use product selling price if not specified
    const finalPrice = unitPrice > 0 ? unitPrice : (product.sellingPrice || 0);
    if(finalPrice <= 0){ alert('Enter valid price'); return; }
    
    currentSaleItems.push({
      productId,
      qty,
      unitPrice: finalPrice,
      total: qty * finalPrice
    });
    
    renderSaleItemsTable();
    
    // Reset form
    document.getElementById('saleQty').value = '1';
    document.getElementById('salePrice').value = '';
  });
  
  // Remove item from sale
  document.getElementById('saleItemsTable')?.addEventListener('click', e => {
    const removeBtn = e.target.closest('[data-remove-sale]');
    if(!removeBtn) return;
    
    const index = parseInt(removeBtn.dataset.removeSale);
    currentSaleItems.splice(index, 1);
    renderSaleItemsTable();
  });
  
  // Save sale
  document.getElementById('btnSaveSale')?.addEventListener('click', () => {
    if(currentSaleItems.length === 0){ alert('Add items to sale'); return; }
    
    const date = document.getElementById('saleDate').value || todayStr();
    const customer = document.getElementById('saleCustomer').value.trim() || 'Walk-in';
    const receiptNo = document.getElementById('saleReceiptNo').value.trim() || '';
    const totalAmount = currentSaleItems.reduce((sum, item) => sum + item.total, 0);
    
    // Check stock and update
    for(const item of currentSaleItems){
      const product = getProductById(item.productId);
      if(product){
        if((product.currentStock || 0) < item.qty){
          alert(`Not enough stock for ${product.name}. Available: ${product.currentStock || 0}, Requested: ${item.qty}`);
          return;
        }
      }
    }
    
    // Update product stocks
    currentSaleItems.forEach(item => {
      const product = getProductById(item.productId);
      if(product){
        product.currentStock = Math.max(0, (product.currentStock || 0) - item.qty);
      }
    });
    
    const saleId = 'sale_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    
    db.sales.push({
      id: saleId,
      date,
      customer,
      receiptNo,
      items: [...currentSaleItems],
      totalAmount
    });
    
    save();
    renderSales();
    renderProducts();
    renderDashboard();
    alert('Sale saved! Stock updated.');
  });
  
  // Filter sales
  document.getElementById('btnFilterSales')?.addEventListener('click', renderSales);
}

/* ========= Inventory Management ========= */
function renderInventory(){
  const date = document.getElementById('inventoryDate')?.value || todayStr();
  const category = document.getElementById('filterCategory')?.value || '';
  
  // Calculate inventory for the date
  const inventoryData = calculateInventoryForDate(date);
  
  const tbody = document.querySelector('#inventoryTable tbody');
  if(tbody){
    let filteredData = [...inventoryData];
    
    if(category){
      filteredData = filteredData.filter(item => item.category === category);
    }
    
    tbody.innerHTML = filteredData.map(item => {
      const totalAvailable = (item.openingStock || 0) + (item.purchased || 0);
      const closingStock = totalAvailable - (item.sold || 0);
      const stockValue = closingStock * (item.costPrice || 0);
      
      return `
      <tr ${closingStock <= (item.minStock || 5) ? 'style="background:#fff7ed"' : ''}>
        <td><b>${item.productName}</b></td>
        <td><span class="pill">${item.category || 'other'}</span></td>
        <td>${item.openingStock || 0}</td>
        <td>${item.purchased || 0}</td>
        <td>${totalAvailable}</td>
        <td>${item.sold || 0}</td>
        <td><b>${closingStock}</b></td>
        <td>${UGX(item.costPrice || 0)}</td>
        <td>${UGX(stockValue)}</td>
        <td>${item.minStock || 5}</td>
      </tr>
    `}).join('');
  }
}

function calculateInventoryForDate(date){
  const result = [];
  
  // For each product, calculate opening, purchased, sold for the date
  db.products.forEach(product => {
    // Opening stock (closing of previous day)
    const previousDate = new Date(new Date(date).getTime() - 24*60*60*1000).toISOString().slice(0,10);
    const previousInventory = calculateInventoryForDate(previousDate)
      .find(item => item.productId === product.id);
    const openingStock = previousInventory ? previousInventory.closingStock : product.currentStock;
    
    // Purchased on this date
    const purchased = db.purchases
      .filter(p => p.date === date)
      .flatMap(p => p.items || [])
      .filter(item => item.productId === product.id)
      .reduce((sum, item) => sum + (item.qty || 0), 0);
    
    // Sold on this date
    const sold = db.sales
      .filter(s => s.date === date)
      .flatMap(s => s.items || [])
      .filter(item => item.productId === product.id)
      .reduce((sum, item) => sum + (item.qty || 0), 0);
    
    result.push({
      productId: product.id,
      productName: product.name,
      category: product.category,
      openingStock,
      purchased,
      sold,
      costPrice: product.costPrice,
      minStock: product.minStockLevel,
      closingStock: openingStock + purchased - sold
    });
  });
  
  return result;
}

function wireInventory(){
  document.getElementById('inventoryDate')?.addEventListener('change', renderInventory);
  document.getElementById('filterCategory')?.addEventListener('change', renderInventory);
  document.getElementById('btnUpdateInventory')?.addEventListener('click', () => {
    renderInventory();
    alert('Inventory updated!');
  });
}

/* ========= Reports ========= */
function initReports(){
  const today = todayStr();
  document.getElementById('reportDate').value = today;
  document.getElementById('plFrom').value = today;
  document.getElementById('plTo').value = today;
  document.getElementById('movementFrom').value = today;
  document.getElementById('movementTo').value = today;
}

function wireReports(){
  // Daily report
  document.getElementById('btnGenerateDaily')?.addEventListener('click', generateDailyReport);
  // Profit & Loss
  document.getElementById('btnGeneratePandL')?.addEventListener('click', generatePandL);
  // Stock movement
  document.getElementById('btnGenerateMovement')?.addEventListener('click', generateStockMovement);
}

function generateDailyReport(){
  const date = document.getElementById('reportDate').value || todayStr();
  const compareDate = document.getElementById('compareDate').value;
  
  const dailySales = db.sales
    .filter(s => s.date === date)
    .flatMap(s => s.items || [])
    .reduce((acc, item) => {
      const product = getProductById(item.productId);
      const key = product?.name || 'Unknown';
      if(!acc[key]) acc[key] = { qty: 0, amount: 0, product };
      acc[key].qty += item.qty || 0;
      acc[key].amount += item.total || 0;
      return acc;
    }, {});
  
  const totalSales = Object.values(dailySales).reduce((sum, item) => sum + item.amount, 0);
  const totalItems = Object.values(dailySales).reduce((sum, item) => sum + item.qty, 0);
  
  let html = `
    <div class="grid-3">
      <div class="stat"><span class="muted">Date</span><b>${date}</b></div>
      <div class="stat"><span class="muted">Total Sales</span><b>${UGX(totalSales)}</b></div>
      <div class="stat"><span class="muted">Items Sold</span><b>${totalItems}</b></div>
    </div>
    <h4 style="margin-top:12px">Sales Breakdown</h4>
    <table class="table">
      <thead><tr><th>Product</th><th>Quantity</th><th>Unit Price</th><th>Total Amount</th></tr></thead>
      <tbody>
        ${Object.entries(dailySales).map(([name, data]) => `
          <tr>
            <td>${name}</td>
            <td>${data.qty}</td>
            <td>${UGX(data.amount / data.qty)}</td>
            <td>${UGX(data.amount)}</td>
          </tr>
        `).join('')}
      </tbody>
    </table>
  `;
  
  if(compareDate){
    const compareSales = db.sales
      .filter(s => s.date === compareDate)
      .flatMap(s => s.items || [])
      .reduce((sum, item) => sum + (item.total || 0), 0);
    
    const diff = totalSales - compareSales;
    const diffPercent = compareSales > 0 ? ((diff / compareSales) * 100).toFixed(1) : 0;
    
    html += `
      <div class="grid-2" style="margin-top:12px">
        <div class="stat"><span class="muted">Compared to ${compareDate}</span><b>${UGX(compareSales)}</b></div>
        <div class="stat ${diff >= 0 ? 'goodmsg' : 'warnmsg'}">
          <span class="muted">Difference</span>
          <b>${diff >= 0 ? '+' : ''}${UGX(diff)} (${diff >= 0 ? '+' : ''}${diffPercent}%)</b>
        </div>
      </div>
    `;
  }
  
  document.getElementById('dailyReportOut').innerHTML = html;
}

function generatePandL(){
  const from = document.getElementById('plFrom').value;
  const to = document.getElementById('plTo').value;
  
  if(!from || !to){ alert('Select date range'); return; }
  
  // Calculate revenue
  const revenue = db.sales
    .filter(s => s.date >= from && s.date <= to)
    .reduce((sum, sale) => sum + (sale.totalAmount || 0), 0);
  
  // Calculate cost of goods sold
  let cogs = 0;
  db.sales
    .filter(s => s.date >= from && s.date <= to)
    .forEach(sale => {
      (sale.items || []).forEach(item => {
        const product = getProductById(item.productId);
        if(product){
          cogs += (item.qty || 0) * (product.costPrice || 0);
        }
      });
    });
  
  // Calculate purchases
  const purchases = db.purchases
    .filter(p => p.date >= from && p.date <= to)
    .reduce((sum, purchase) => sum + (purchase.totalAmount || 0), 0);
  
  const grossProfit = revenue - cogs;
  const grossMargin = revenue > 0 ? (grossProfit / revenue * 100).toFixed(1) : 0;
  
  const html = `
    <div class="grid-4">
      <div class="stat"><span class="muted">Period</span><b>${from} to ${to}</b></div>
      <div class="stat"><span class="muted">Revenue</span><b>${UGX(revenue)}</b></div>
      <div class="stat"><span class="muted">COGS</span><b>${UGX(cogs)}</b></div>
      <div class="stat"><span class="muted">Purchases</span><b>${UGX(purchases)}</b></div>
    </div>
    <div class="grid-2" style="margin-top:12px">
      <div class="stat goodmsg">
        <span class="muted">Gross Profit</span>
        <b>${UGX(grossProfit)}</b>
      </div>
      <div class="stat goodmsg">
        <span class="muted">Gross Margin</span>
        <b>${grossMargin}%</b>
      </div>
    </div>
    <h4 style="margin-top:12px">Product Performance</h4>
    <table class="table">
      <thead><tr><th>Product</th><th>Sold</th><th>Revenue</th><th>COGS</th><th>Profit</th><th>Margin</th></tr></thead>
      <tbody>
        ${getProductPerformance(from, to).map(p => `
          <tr>
            <td>${p.name}</td>
            <td>${p.sold}</td>
            <td>${UGX(p.revenue)}</td>
            <td>${UGX(p.cogs)}</td>
            <td>${UGX(p.profit)}</td>
            <td>${p.margin}%</td>
          </tr>
        `).join('')}
      </tbody>
    </table>
  `;
  
  document.getElementById('plOut').innerHTML = html;
}

function getProductPerformance(from, to){
  const performance = {};
  
  db.sales
    .filter(s => s.date >= from && s.date <= to)
    .forEach(sale => {
      (sale.items || []).forEach(item => {
        const product = getProductById(item.productId);
        if(product){
          const key = product.id;
          if(!performance[key]){
            performance[key] = {
              name: product.name,
              sold: 0,
              revenue: 0,
              cogs: 0
            };
          }
          performance[key].sold += item.qty || 0;
          performance[key].revenue += item.total || 0;
          performance[key].cogs += (item.qty || 0) * (product.costPrice || 0);
        }
      });
    });
  
  return Object.values(performance).map(p => ({
    ...p,
    profit: p.revenue - p.cogs,
    margin: p.revenue > 0 ? ((p.revenue - p.cogs) / p.revenue * 100).toFixed(1) : 0
  })).sort((a,b) => b.profit - a.profit);
}

function generateStockMovement(){
  const productId = document.getElementById('movementProduct').value;
  const from = document.getElementById('movementFrom').value;
  const to = document.getElementById('movementTo').value;
  
  if(!from || !to){ alert('Select date range'); return; }
  
  let html = '';
  
  if(productId === 'all'){
    // Show all products movement summary
    const movements = db.products.map(product => {
      const sales = db.sales
        .filter(s => s.date >= from && s.date <= to)
        .flatMap(s => s.items || [])
        .filter(item => item.productId === product.id)
        .reduce((sum, item) => sum + (item.qty || 0), 0);
      
      const purchases = db.purchases
        .filter(p => p.date >= from && s.date <= to)
        .flatMap(p => p.items || [])
        .filter(item => item.productId === product.id)
        .reduce((sum, item) => sum + (item.qty || 0), 0);
      
      return {
        name: product.name,
        sales,
        purchases,
        net: purchases - sales
      };
    }).filter(m => m.sales > 0 || m.purchases > 0)
      .sort((a,b) => b.sales - a.sales);
    
    html = `
      <h4>Stock Movement Summary (${from} to ${to})</h4>
      <table class="table">
        <thead><tr><th>Product</th><th>Purchased</th><th>Sold</th><th>Net Movement</th></tr></thead>
        <tbody>
          ${movements.map(m => `
            <tr>
              <td>${m.name}</td>
              <td>${m.purchases}</td>
              <td>${m.sales}</td>
              <td ${m.net > 0 ? 'style="color:green"' : m.net < 0 ? 'style="color:red"' : ''}>
                ${m.net > 0 ? '+' : ''}${m.net}
              </td>
            </tr>
          `).join('')}
        </tbody>
      </table>
    `;
  } else {
    // Show detailed movement for single product
    const product = getProductById(productId);
    if(!product){ alert('Product not found'); return; }
    
    // Get all transactions
    const transactions = [];
    
    // Purchases
    db.purchases
      .filter(p => p.date >= from && p.date <= to)
      .forEach(purchase => {
        (purchase.items || []).forEach(item => {
          if(item.productId === productId){
            transactions.push({
              date: purchase.date,
              type: 'Purchase',
              qty: item.qty,
              price: item.unitPrice,
              total: item.total,
              ref: purchase.supplier
            });
          }
        });
      });
    
    // Sales
    db.sales
      .filter(s => s.date >= from && s.date <= to)
      .forEach(sale => {
        (sale.items || []).forEach(item => {
          if(item.productId === productId){
            transactions.push({
              date: sale.date,
              type: 'Sale',
              qty: -item.qty,
              price: item.unitPrice,
              total: item.total,
              ref: sale.customer
            });
          }
        });
      });
    
    transactions.sort((a,b) => new Date(a.date) - new Date(b.date));
    
    let runningTotal = 0;
    
    html = `
      <h4>Stock Movement for ${product.name} (${from} to ${to})</h4>
      <table class="table">
        <thead><tr><th>Date</th><th>Type</th><th>Reference</th><th>Quantity</th><th>Unit Price</th><th>Total</th><th>Running Total</th></tr></thead>
        <tbody>
          ${transactions.map(t => {
            runningTotal += t.qty;
            return `
            <tr>
              <td>${t.date}</td>
              <td><span class="pill">${t.type}</span></td>
              <td>${t.ref}</td>
              <td ${t.qty > 0 ? 'style="color:green"' : 'style="color:red"'}>${t.qty > 0 ? '+' : ''}${t.qty}</td>
              <td>${UGX(t.price)}</td>
              <td>${UGX(t.total)}</td>
              <td><b>${runningTotal}</b></td>
            </tr>
          `}).join('')}
        </tbody>
      </table>
    `;
  }
  
  document.getElementById('movementOut').innerHTML = html;
}

/* ========= Data Management ========= */
function wireData(){
  // Backup
  document.getElementById('btnBackup')?.addEventListener('click', backupData);
  document.getElementById('btnBackup2')?.addEventListener('click', backupData);
  
  // Restore
  document.getElementById('restoreFile')?.addEventListener('change', handleRestore);
  document.getElementById('restoreFile2')?.addEventListener('change', handleRestore);
  
  // Save
  document.getElementById('btnSaveNow')?.addEventListener('click', saveNow);
  document.getElementById('btnSaveNow2')?.addEventListener('click', saveNow);
  
  // Wipe data
  document.getElementById('btnWipe')?.addEventListener('click', wipeData);
  
  // Excel import/export
  document.getElementById('btnExportExcel')?.addEventListener('click', exportToExcel);
  document.getElementById('importExcel')?.addEventListener('change', importFromExcel);
  
  // Initialize from Excel data
  document.getElementById('btnInitFromExcel')?.addEventListener('click', initializeFromExcelData);
  
  // Quick actions
  document.getElementById('btnNewPurchase')?.addEventListener('click', () => {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelector('[data-tab="purchases"]').classList.add('active');
    document.querySelectorAll('.tabpanel').forEach(p => p.hidden = true);
    document.getElementById('purchases').hidden = false;
    renderPurchases();
  });
  
  document.getElementById('btnNewSale')?.addEventListener('click', () => {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelector('[data-tab="sales"]').classList.add('active');
    document.querySelectorAll('.tabpanel').forEach(p => p.hidden = true);
    document.getElementById('sales').hidden = false;
    renderSales();
  });
  
  document.getElementById('btnToday')?.addEventListener('click', () => {
    const today = todayStr();
    const dateInputs = document.querySelectorAll('input[type="date"]');
    dateInputs.forEach(input => input.value = today);
    renderDashboard();
    renderInventory();
  });
}

function backupData(){
  const dataStr = JSON.stringify(db, null, 2);
  const blob = new Blob([dataStr], {type: 'application/json'});
  download(`bar-backup-${todayStr()}.json`, blob);
}

function handleRestore(e){
  const file = e.target.files[0];
  if(!file) return;
  
  const reader = new FileReader();
  reader.onload = function(event){
    try{
      const newData = JSON.parse(event.target.result);
      if(!newData.products || !newData.purchases || !newData.sales){
        throw new Error('Invalid backup file');
      }
      
      if(confirm('Restore data? This will replace current data.')){
        db = newData;
        save();
        location.reload();
      }
    } catch(err){
      alert('Error restoring data: ' + err.message);
    }
  };
  reader.readAsText(file);
  e.target.value = '';
}

function saveNow(){
  save();
  alert('Data saved!');
}

function wipeData(){
  if(confirm('Delete ALL data? This cannot be undone!')){
    localStorage.removeItem(KEY);
    location.reload();
  }
}

/* ========= Excel Import/Export ========= */
function exportToExcel(){
  // Simple CSV export for now
  const productsCSV = 'Product,Category,Stock,Min Stock,Cost Price,Selling Price\n' +
    db.products.map(p => 
      `"${p.name}","${p.category || ''}",${p.currentStock || 0},${p.minStockLevel || 5},${p.costPrice || 0},${p.sellingPrice || 0}`
    ).join('\n');
  
  const purchasesCSV = 'Date,Supplier,Product,Qty,Unit Price,Total\n' +
    db.purchases.flatMap(p => 
      (p.items || []).map(item => {
        const product = getProductById(item.productId);
        return `"${p.date}","${p.supplier || ''}","${product?.name || 'Unknown'}",${item.qty || 0},${item.unitPrice || 0},${item.total || 0}`;
      })
    ).join('\n');
  
  const salesCSV = 'Date,Customer,Product,Qty,Unit Price,Total\n' +
    db.sales.flatMap(s => 
      (s.items || []).map(item => {
        const product = getProductById(item.productId);
        return `"${s.date}","${s.customer || ''}","${product?.name || 'Unknown'}",${item.qty || 0},${item.unitPrice || 0},${item.total || 0}`;
      })
    ).join('\n');
  
  // Combine all CSV data
  const combined = `BAR MANAGEMENT DATA EXPORT - ${todayStr()}\n\n=== PRODUCTS ===\n${productsCSV}\n\n=== PURCHASES ===\n${purchasesCSV}\n\n=== SALES ===\n${salesCSV}`;
  
  download(`bar-data-${todayStr()}.csv`, new Blob([combined], {type: 'text/csv'}));
}

function importFromExcel(e){
  const file = e.target.files[0];
  if(!file) return;
  
  // For now, we'll just alert about manual import
  alert('For Excel import, please use the "Initialize Products" button first, then manually add purchase and sales data.');
  e.target.value = '';
}

/* ========= Initialize from Excel Data ========= */
function initializeFromExcelData(){
  // Create products from your Excel data
  const excelProducts = [
    // From your Excel sheets
    {name: "gilbeys (s)", category: "spirits", costPrice: 8500, sellingPrice: 12000, stock: 15},
    {name: "gilbeys (b)", category: "spirits", costPrice: 33000, sellingPrice: 45000, stock: 5},
    {name: "Ug Plastic", category: "spirits", costPrice: 5000, sellingPrice: 7000, stock: 10},
    {name: "HIGH 5", category: "energy", costPrice: 2083, sellingPrice: 3000, stock: 12},
    {name: "4 COUSINS", category: "wine", costPrice: 33000, sellingPrice: 50000, stock: 4},
    {name: "UG GLASS BIG", category: "spirits", costPrice: 28000, sellingPrice: 45000, stock: 4},
    {name: "REDBULL", category: "energy", costPrice: 6500, sellingPrice: 10000, stock: 8},
    {name: "BOND PEP", category: "spirits", costPrice: 5500, sellingPrice: 11000, stock: 5},
    {name: "CAPTAIN MORGAN", category: "spirits", costPrice: 33000, sellingPrice: 45000, stock: 2},
    {name: "UG Glass", category: "spirits", costPrice: 7500, sellingPrice: 20000, stock: 5},
    {name: "Bond 7 Glass", category: "spirits", costPrice: 8500, sellingPrice: 11000, stock: 5},
    {name: "V$ A BIG", category: "spirits", costPrice: 28000, sellingPrice: 45000, stock: 3},
    {name: "V$ A SMALL", category: "spirits", costPrice: 8500, sellingPrice: 11000, stock: 3},
    {name: "CLUB", category: "beer", costPrice: 3100, sellingPrice: 4000, stock: 20},
    {name: "LITE", category: "beer", costPrice: 3000, sellingPrice: 4000, stock: 20},
    {name: "GUINESS", category: "beer", costPrice: 3000, sellingPrice: 4000, stock: 20},
    {name: "TUSKER LAGER", category: "beer", costPrice: 3000, sellingPrice: 4000, stock: 10},
    {name: "PILSNER", category: "beer", costPrice: 2700, sellingPrice: 4000, stock: 10},
    {name: "YAKET", category: "beer", costPrice: 4750, sellingPrice: 1000, stock: 2},
    {name: "STING", category: "energy", costPrice: 19000, sellingPrice: 3000, stock: 1},
    {name: "ROCKBOOM", category: "energy", costPrice: 19000, sellingPrice: 3000, stock: 1},
    {name: "BELL", category: "beer", costPrice: 2800, sellingPrice: 4000, stock: 10},
    {name: "GUINESS SMOOTH", category: "beer", costPrice: 3000, sellingPrice: 4000, stock: 10},
    {name: "MINUTE MAID", category: "soft", costPrice: 26000, sellingPrice: 3000, stock: 1},
    {name: "NILE", category: "beer", costPrice: 3500, sellingPrice: 5000, stock: 20},
    {name: "predator", category: "energy", costPrice: 19000, sellingPrice: 3000, stock: 1},
    {name: "smirnoff", category: "spirits", costPrice: 3400, sellingPrice: 5000, stock: 5},
    {name: "malt", category: "soft", costPrice: 3000, sellingPrice: 4000, stock: 10},
  ];
  
  if(db.products.length > 0 && !confirm('Replace existing products?')){
    return;
  }
  
  db.products = excelProducts.map((p, index) => ({
    id: 'prod_' + (index + 1),
    name: p.name,
    category: p.category,
    costPrice: p.costPrice,
    sellingPrice: p.sellingPrice,
    currentStock: p.stock,
    minStockLevel: 5
  }));
  
  save();
  renderProducts();
  renderDashboard();
  alert(`${excelProducts.length} products initialized from Excel data!`);
}

/* ========= Print Functions ========= */
function wirePrint(){
  document.getElementById('btnPrintStock')?.addEventListener('click', printStockReport);
  document.getElementById('btnPrintSales')?.addEventListener('click', printSalesReport);
  document.getElementById('btnPrintPurchases')?.addEventListener('click', printPurchaseReport);
  document.getElementById('btnPrintInventory')?.addEventListener('click', printInventory);
  document.getElementById('btnExportInventory')?.addEventListener('click', exportInventoryCSV);
}

function printStockReport(){
  const html = `
    <h2>Stock Report - ${todayStr()}</h2>
    <table class="table">
      <thead><tr><th>Product</th><th>Category</th><th>Stock</th><th>Min Level</th><th>Cost Price</th><th>Selling Price</th><th>Stock Value</th></tr></thead>
      <tbody>
        ${db.products.map(p => {
          const stockValue = (p.currentStock || 0) * (p.costPrice || 0);
          return `
          <tr ${(p.currentStock || 0) <= (p.minStockLevel || 5) ? 'style="background:#fff7ed"' : ''}>
            <td>${p.name}</td>
            <td>${p.category || 'other'}</td>
            <td>${p.currentStock || 0}</td>
            <td>${p.minStockLevel || 5}</td>
            <td>${UGX(p.costPrice || 0)}</td>
            <td>${UGX(p.sellingPrice || 0)}</td>
            <td>${UGX(stockValue)}</td>
          </tr>
        `}).join('')}
      </tbody>
    </table>
  `;
  
  printHTML(html, 'Stock Report');
}

function printSalesReport(){
  const today = todayStr();
  const salesToday = db.sales.filter(s => s.date === today);
  const total = salesToday.reduce((sum, s) => sum + (s.totalAmount || 0), 0);
  
  const html = `
    <h2>Sales Report - ${today}</h2>
    <div style="margin:20px 0;font-size:18px">Total Sales: <b>${UGX(total)}</b></div>
    <table class="table">
      <thead><tr><th>Time</th><th>Customer</th><th>Items</th><th>Amount</th></tr></thead>
      <tbody>
        ${salesToday.map(s => `
          <tr>
            <td>${s.date}</td>
            <td>${s.customer || 'Walk-in'}</td>
            <td>${(s.items || []).map(item => {
              const product = getProductById(item.productId);
              return `${product?.name || 'Unknown'} (${item.qty})`;
            }).join(', ')}</td>
            <td>${UGX(s.totalAmount || 0)}</td>
          </tr>
        `).join('')}
      </tbody>
    </table>
  `;
  
  printHTML(html, 'Sales Report');
}

function printPurchaseReport(){
  const today = todayStr();
  const purchasesToday = db.purchases.filter(p => p.date === today);
  const total = purchasesToday.reduce((sum, p) => sum + (p.totalAmount || 0), 0);
  
  const html = `
    <h2>Purchase Report - ${today}</h2>
    <div style="margin:20px 0;font-size:18px">Total Purchases: <b>${UGX(total)}</b></div>
    <table class="table">
      <thead><tr><th>Time</th><th>Supplier</th><th>Items</th><th>Amount</th></tr></thead>
      <tbody>
        ${purchasesToday.map(p => `
          <tr>
            <td>${p.date}</td>
            <td>${p.supplier || '-'}</td>
            <td>${(p.items || []).map(item => {
              const product = getProductById(item.productId);
              return `${product?.name || 'Unknown'} (${item.qty})`;
            }).join(', ')}</td>
            <td>${UGX(p.totalAmount || 0)}</td>
          </tr>
        `).join('')}
      </tbody>
    </table>
  `;
  
  printHTML(html, 'Purchase Report');
}

function printInventory(){
  // Just trigger the browser print for the inventory tab
  window.print();
}

function exportInventoryCSV(){
  const inventory = calculateInventoryForDate(todayStr());
  const csv = 'Product,Category,Opening Stock,Purchased Today,Sold Today,Closing Stock,Unit Cost,Stock Value,Min Level\n' +
    inventory.map(item => {
      const totalAvailable = (item.openingStock || 0) + (item.purchased || 0);
      const closingStock = totalAvailable - (item.sold || 0);
      const stockValue = closingStock * (item.costPrice || 0);
      
      return `"${item.productName}","${item.category || ''}",${item.openingStock || 0},${item.purchased || 0},${item.sold || 0},${closingStock},${item.costPrice || 0},${stockValue},${item.minStock || 5}`;
    }).join('\n');
  
  download(`inventory-${todayStr()}.csv`, new Blob([csv], {type: 'text/csv'}));
}

function printHTML(content, title){
  const win = window.open('', '_blank');
  win.document.write(`
    <html>
      <head>
        <title>${title}</title>
        <style>
          body { font-family: Arial, sans-serif; margin: 20px; }
          table { width: 100%; border-collapse: collapse; margin-top: 10px; }
          th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
          th { background-color: #f2f2f2; }
          @media print { button { display: none; } }
        </style>
      </head>
      <body>
        ${content}
        <br><br>
        <button onclick="window.print()">Print</button>
        <button onclick="window.close()">Close</button>
      </body>
    </html>
  `);
  win.document.close();
}

/* ========= Initialize Application ========= */
document.addEventListener('DOMContentLoaded', () => {
  // Set today's date in all date fields
  const today = todayStr();
  const dateInputs = document.querySelectorAll('input[type="date"]');
  dateInputs.forEach(input => {
    if(!input.value) input.value = today;
  });
  
  // Wire up all functionality
  wireTabs();
  wireProducts();
  wirePurchases();
  wireSales();
  wireInventory();
  wireReports();
  wireData();
  wirePrint();
  
  // Initial render
  renderDashboard();
  renderProducts();
  renderPurchases();
  renderSales();
  renderInventory();
  
  console.log('Bar Management System initialized!');
});
</script>
</body>
</html>
