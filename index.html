<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>BAR MANAGEMENT SYSTEM - Complete with Automated Inventory</title>
<meta name="description" content="Bar management system with automated inventory, purchases, and stock balancing">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
<script src="https://cdn.sheetjs.com/xlsx-0.20.2/package/dist/xlsx.full.min.js"></script>
<!-- Google Identity Services -->
<script src="https://accounts.google.com/gsi/client" async defer></script>
<style>
  :root{ --brand:#0ea5e9; --brand-d:#0369a1; --ok:#16a34a; --warn:#f59e0b; --bad:#ef4444; --ink:#0f172a; --muted:#64748b; --line:#e2e8f0; --bg:#f8fafc; }
  *{box-sizing:border-box; margin:0; padding:0;}
  html,body{height:100%}
  body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,sans-serif;background:var(--bg);color:var(--ink);line-height:1.5;}
  header{position:sticky;top:0;z-index:20;background:#fff;border-bottom:1px solid var(--line);padding:0 16px;}
  .nav{display:flex;gap:12px;align-items:center;justify-content:space-between;padding:12px 0;max-width:1400px;margin:0 auto;}
  .brand{display:flex;gap:10px;align-items:center;font-weight:800;font-size:18px;}
  .brand-badge{width:36px;height:36px;border-radius:10px;background:var(--brand);color:#fff;display:grid;place-items:center;font-weight:bold;}
  .tabs{display:flex;flex-wrap:wrap;gap:6px;}
  .tab{border:1px solid var(--line);background:#fff;border-radius:8px;padding:8px 16px;cursor:pointer;font-weight:600;font-size:14px;transition:all 0.2s;}
  .tab:hover{background:#f1f5f9;}
  .tab.active{background:var(--brand);border-color:var(--brand);color:#fff;}
  main{padding:20px 16px;max-width:1400px;margin:0 auto;width:100%;}
  h2{margin:0 0 20px;font-size:24px;}
  h3{margin:0 0 16px;font-size:18px;}
  h4{margin:0 0 12px;font-size:16px;}
  .row{display:grid;grid-template-columns:repeat(12,1fr);gap:16px;}
  .card{background:#fff;border:1px solid var(--line);border-radius:12px;padding:20px;box-shadow:0 2px 4px rgba(0,0,0,0.05);}
  label{font-size:14px;color:var(--muted);display:block;margin-bottom:6px;font-weight:600;}
  input,select,button,textarea{font-family:inherit;font-size:14px;}
  input[type="number"],input[type="date"],input[type="text"],select,textarea{width:100%;padding:10px 12px;border:1px solid var(--line);border-radius:8px;background:#fff;transition:border 0.2s;}
  input:focus,select:focus,textarea:focus{outline:none;border-color:var(--brand);box-shadow:0 0 0 3px rgba(14,165,233,0.1);}
  .btn{padding:10px 16px;border-radius:8px;border:1px solid var(--line);background:#fff;cursor:pointer;font-weight:600;font-size:14px;transition:all 0.2s;display:inline-flex;align-items:center;justify-content:center;gap:6px;}
  .btn:hover{background:#f8fafc;}
  .btn.primary{background:var(--brand);border-color:var(--brand);color:#fff;}
  .btn.primary:hover{background:var(--brand-d);border-color:var(--brand-d);}
  .btn.ok{background:var(--ok);border-color:var(--ok);color:#fff;}
  .btn.ok:hover{background:#15803d;}
  .btn.warn{background:var(--warn);border-color:var(--warn);color:#111827;}
  .btn.bad{background:var(--bad);border-color:var(--bad);color:#fff;}
  .stack{display:flex;flex-wrap:wrap;gap:8px;align-items:center;}
  .muted{color:var(--muted);font-size:14px;}
  .pill{display:inline-block;padding:4px 10px;border-radius:999px;border:1px solid var(--line);background:#f1f5f9;font-size:12px;font-weight:600;}
  .table{width:100%;border-collapse:separate;border-spacing:0;}
  .table th{background:#f8fafc;border-bottom:2px solid var(--line);padding:12px;text-align:left;font-size:13px;font-weight:600;color:var(--muted);}
  .table td{border-bottom:1px solid var(--line);padding:12px;font-size:14px;}
  .table tr:hover td{background:#f8fafc;}
  .help{font-size:12px;color:var(--muted);margin-top:8px;}
  .right{display:flex;justify-content:flex-end;gap:12px;}
  .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:16px;}
  .grid-3{display:grid;grid-template-columns:repeat(3,1fr);gap:16px;}
  .grid-4{display:grid;grid-template-columns:repeat(4,1fr);gap:16px;}
  .stat{padding:16px;border:1px solid var(--line);border-radius:10px;background:#fff;}
  .stat b{display:block;font-size:24px;margin-top:4px;color:var(--ink);}
  .hr{height:1px;background:var(--line);margin:20px 0;}
  .warnmsg{background:#fff7ed;border:1px solid #fdba74;color:#9a3412;padding:12px;border-radius:10px;margin:12px 0;}
  .goodmsg{background:#ecfdf5;border:1px solid #86efac;color:#065f46;padding:12px;border-radius:10px;margin:12px 0;}
  .badmsg{background:#fee2e2;border:1px solid #fca5a5;color:#991b1b;padding:12px;border-radius:10px;margin:12px 0;}
  .section-tools{display:flex;gap:12px;align-items:center;margin-bottom:16px;flex-wrap:wrap;}
  .compact-table th,.compact-table td{padding:8px 10px;font-size:13px;}
  .loading{display:none;position:fixed;z-index:2000;top:0;left:0;width:100%;height:100%;background:rgba(255,255,255,0.9);justify-content:center;align-items:center;flex-direction:column;gap:16px;}
  .loading-spinner{width:40px;height:40px;border:4px solid #f3f3f3;border-top:4px solid var(--brand);border-radius:50%;animation:spin 1s linear infinite;}
  @keyframes spin{0%{transform:rotate(0deg);}100%{transform:rotate(360deg);}}
  .mono{font-family:ui-monospace, Menlo, Consolas, "Courier New", monospace; white-space: pre-wrap;}
  .positive{color:#16a34a;font-weight:600;}
  .negative{color:#ef4444;font-weight:600;}
  .stock-low{background:#fff7ed !important;}
  .stock-out{background:#fee2e2 !important;}
  .stock-good{background:#ecfdf5 !important;}
  @media (max-width: 1200px){.grid-4{grid-template-columns:repeat(2,1fr);}}
  @media (max-width: 768px){.grid-2,.grid-3,.grid-4{grid-template-columns:1fr;}.row{grid-template-columns:1fr;}.card{padding:16px;}.nav{flex-direction:column;gap:16px;}.tabs{width:100%;justify-content:center;}}
</style>
</head>
<body>
  <header>
    <div class="nav">
      <div class="brand"><div class="brand-badge">B</div>BAR MANAGEMENT SYSTEM</div>
      <div class="tabs" id="tabs">
        <button class="tab active" data-tab="dashboard">Dashboard</button>
        <button class="tab" data-tab="inventory">Inventory</button>
        <button class="tab" data-tab="purchases">Purchases</button>
        <button class="tab" data-tab="sales">Daily Sales</button>
        <button class="tab" data-tab="expenses">Expenses</button>
        <button class="tab" data-tab="reports">Reports</button>
        <button class="tab" data-tab="products">Products</button>
        <button class="tab" data-tab="data">Data</button>
      </div>
    </div>
  </header>

  <main>
    <!-- Dashboard -->
    <section id="dashboard" class="tabpanel">
      <h2>Dashboard Overview</h2>
      <div class="grid-4">
        <div class="stat"><span class="muted">Total Products</span><b id="statProducts">0</b></div>
        <div class="stat"><span class="muted">Stock Value</span><b id="statStockValue">UGX 0</b></div>
        <div class="stat"><span class="muted">Monthly Purchases</span><b id="statMonthPurchases">UGX 0</b></div>
        <div class="stat"><span class="muted">Most Moving Category</span><b id="statMostMoving">-</b></div>
      </div>
      
      <div class="hr"></div>
      
      <div class="grid-3">
        <div class="stat">
          <span class="muted">Gross Profit (Period)</span>
          <b id="statGrossProfit">UGX 0</b>
        </div>
        <div class="stat">
          <span class="muted">Total Expenses</span>
          <b id="statTotalExpenses">UGX 0</b>
        </div>
        <div class="stat">
          <span class="muted">Net Profit/Loss</span>
          <b id="statNetProfit">UGX 0</b>
        </div>
      </div>
      
      <div class="hr"></div>
      
      <div class="grid-3">
        <div class="stat">
          <span class="muted">Inventory Investment</span>
          <b id="statInventoryInvestment">UGX 0</b>
        </div>
        <div class="stat">
          <span class="muted">COGS (Cost of Goods Sold)</span>
          <b id="statCOGS">UGX 0</b>
        </div>
        <div class="stat">
          <span class="muted">Return on Investment</span>
          <b id="statROI">0%</b>
        </div>
      </div>
      
      <div class="hr"></div>
      
      <div class="card" id="profitStatusCard">
        <h3>Profitability Status</h3>
        <div id="profitStatus" class="goodmsg">
          <strong>Status:</strong> Calculating profitability...
        </div>
        <div id="inventoryStatus" class="warnmsg" style="margin-top:12px;">
          <strong>Inventory Status:</strong> Calculating stock levels...
        </div>
      </div>
    </section>

    <!-- Inventory -->
    <section id="inventory" class="tabpanel" style="display:none;">
      <div class="card">
        <div class="section-tools">
          <h3 style="margin-right:auto">Real-Time Inventory Management</h3>
          <button class="btn" id="btnPrintInventory">Print</button>
          <button class="btn" id="btnExportInventory">Export CSV</button>
          <button class="btn primary" id="btnAutoUpdateInventory">Auto-Update</button>
        </div>
        
        <div class="grid-4">
          <div>
            <label>As of Date</label>
            <input type="date" id="inventoryDate" value="">
          </div>
          <div>
            <label>Filter Category</label>
            <select id="filterCategory">
              <option value="">All Categories</option>
              <option value="beer">Beer</option>
              <option value="Soft Drink">Soft Drink</option>
              <option value="Energy Drink">Energy Drink</option>
              <option value="Spirit">Spirit</option>
              <option value="wine">Wine</option>
            </select>
          </div>
          <div>
            <label>Stock Status</label>
            <select id="filterStockStatus">
              <option value="">All</option>
              <option value="low">Low Stock</option>
              <option value="out">Out of Stock</option>
              <option value="good">Good Stock</option>
            </select>
          </div>
          <div class="right">
            <button class="btn ok" id="btnUpdateInventory">Update View</button>
          </div>
        </div>
        
        <div class="hr"></div>
        
        <table class="table" id="inventoryTable">
          <thead>
            <tr>
              <th>Product</th>
              <th>Category</th>
              <th>Opening Stock</th>
              <th>Purchased</th>
              <th>Sold</th>
              <th>Current Stock</th>
              <th>Min Level</th>
              <th>Cost Price</th>
              <th>Sale Price</th>
              <th>Stock Value</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      
      <div class="hr"></div>
      
      <div class="grid-2">
        <div class="card">
          <h3>Stock Replenishment Suggestions</h3>
          <table class="table compact-table" id="replenishmentTable">
            <thead>
              <tr>
                <th>Product</th>
                <th>Current</th>
                <th>Min</th>
                <th>Suggested Qty</th>
                <th>Cost</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
        
        <div class="card">
          <h3>Inventory Value Summary</h3>
          <div id="inventorySummary">
            <div class="stat" style="margin-bottom:12px;">
              <span class="muted">Total Inventory Value</span>
              <b id="totalInventoryValue">UGX 0</b>
            </div>
            <div class="stat" style="margin-bottom:12px;">
              <span class="muted">Items Needing Reorder</span>
              <b id="itemsNeedingReorder">0</b>
            </div>
            <div class="stat">
              <span class="muted">Average Stock Days</span>
              <b id="avgStockDays">0</b>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Purchases -->
    <section id="purchases" class="tabpanel" style="display:none;">
      <div class="grid-2">
        <div class="card">
          <h3>Record New Purchase</h3>
          <div class="grid-3">
            <div>
              <label>Purchase Date</label>
              <input type="date" id="purchaseDate" value="">
            </div>
            <div>
              <label>Supplier</label>
              <input type="text" id="purchaseSupplier" placeholder="Supplier name">
            </div>
            <div>
              <label>Invoice No.</label>
              <input type="text" id="purchaseInvoice" placeholder="Invoice number">
            </div>
          </div>
          
          <div class="grid-3">
            <div>
              <label>Payment Method</label>
              <select id="purchasePaymentMethod">
                <option value="cash">Cash</option>
                <option value="mobile">Mobile Money</option>
                <option value="bank">Bank Transfer</option>
                <option value="credit">Credit</option>
              </select>
            </div>
            <div>
              <label>Delivery Date</label>
              <input type="date" id="purchaseDeliveryDate">
            </div>
            <div>
              <label>Status</label>
              <select id="purchaseStatus">
                <option value="pending">Pending</option>
                <option value="received">Received</option>
                <option value="partially">Partially Received</option>
                <option value="cancelled">Cancelled</option>
              </select>
            </div>
          </div>
          
          <div class="hr"></div>
          
          <h4>Purchase Items</h4>
          <div class="grid-4" style="margin-bottom:12px;">
            <div>
              <label>Product</label>
              <select id="purchaseProduct"></select>
            </div>
            <div>
              <label>Quantity</label>
              <input type="number" id="purchaseQty" min="1" value="1">
            </div>
            <div>
              <label>Unit Cost (UGX)</label>
              <input type="number" id="purchaseCost" min="0" value="0">
            </div>
            <div style="align-self:flex-end;">
              <button class="btn" id="btnAddPurchaseItem">Add Item</button>
            </div>
          </div>
          
          <table class="table compact-table" id="purchaseItemsTable">
            <thead>
              <tr>
                <th>Product</th>
                <th>Qty</th>
                <th>Unit Cost</th>
                <th>Total</th>
                <th></th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
          
          <div class="right" style="margin-top:16px;">
            <div class="stat">
              <span class="muted">Subtotal</span>
              <b id="purchaseSubtotal">UGX 0</b>
            </div>
            <div class="grid-2" style="gap:8px; margin-right:16px;">
              <div>
                <label>Tax/VAT (%)</label>
                <input type="number" id="purchaseTax" min="0" max="100" value="0" style="width:100px;">
              </div>
              <div>
                <label>Other Charges</label>
                <input type="number" id="purchaseOtherCharges" min="0" value="0" style="width:100px;">
              </div>
            </div>
            <div class="stat">
              <span class="muted">Total Purchase</span>
              <b id="purchaseTotal">UGX 0</b>
            </div>
            <button class="btn ok" id="btnSavePurchase">Save Purchase</button>
          </div>
        </div>
        
        <div class="card">
          <h3>Recent Purchases</h3>
          <div class="grid-3" style="margin-bottom:16px;">
            <div>
              <label>From Date</label>
              <input type="date" id="purchaseFrom">
            </div>
            <div>
              <label>To Date</label>
              <input type="date" id="purchaseTo">
            </div>
            <div style="align-self:flex-end;">
              <button class="btn" id="btnFilterPurchases">Filter</button>
            </div>
          </div>
          
          <table class="table compact-table" id="purchasesTable">
            <thead>
              <tr>
                <th>Date</th>
                <th>Supplier</th>
                <th>Items</th>
                <th>Total</th>
                <th>Status</th>
                <th></th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
          
          <div class="hr"></div>
          
          <h4>Purchase Analysis</h4>
          <div class="grid-3">
            <div class="stat">
              <span class="muted">Total This Month</span>
              <b id="purchasesThisMonth">UGX 0</b>
            </div>
            <div class="stat">
              <span class="muted">Avg. Purchase</span>
              <b id="avgPurchase">UGX 0</b>
            </div>
            <div class="stat">
              <span class="muted">Top Supplier</span>
              <b id="topSupplier">-</b>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Daily Sales -->
    <section id="sales" class="tabpanel" style="display:none;">
      <div class="grid-2">
        <div class="card">
          <h3>Record Daily Sales</h3>
          <div class="grid-3">
            <div>
              <label>Date (Unique Day)</label>
              <input type="date" id="saleDate" value="">
            </div>
            <div>
              <label>Shift</label>
              <select id="saleShift">
                <option value="morning">Morning</option>
                <option value="afternoon">Afternoon</option>
                <option value="evening">Evening</option>
                <option value="night">Night</option>
                <option value="full">Full Day</option>
              </select>
            </div>
            <div>
              <label>Record Type</label>
              <select id="recordType">
                <option value="manual">Manual Entry</option>
                <option value="excel">From Excel Sheet</option>
              </select>
            </div>
          </div>
          
          <div class="hr"></div>
          
          <h4>Daily Sales Items</h4>
          <div class="grid-4" style="margin-bottom:12px;">
            <div>
              <label>Product</label>
              <select id="saleProduct"></select>
            </div>
            <div>
              <label>Quantity Sold</label>
              <input type="number" id="saleQty" min="1" value="1">
            </div>
            <div>
              <label>Unit Price (UGX)</label>
              <input type="number" id="salePrice" min="0" value="0">
            </div>
            <div style="align-self:flex-end;">
              <button class="btn" id="btnAddSaleItem">Add Item</button>
            </div>
          </div>
          
          <table class="table compact-table" id="saleItemsTable">
            <thead>
              <tr>
                <th>Product</th>
                <th>Qty</th>
                <th>Unit Price</th>
                <th>Total</th>
                <th>Cost</th>
                <th>Profit</th>
                <th></th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
          
          <div class="right" style="margin-top:16px;">
            <div class="stat">
              <span class="muted">Total Sales</span>
              <b id="saleTotal">UGX 0</b>
            </div>
            <div class="stat">
              <span class="muted">Total Cost</span>
              <b id="saleCost">UGX 0</b>
            </div>
            <div class="stat">
              <span class="muted">Total Profit</span>
              <b id="saleProfit">UGX 0</b>
            </div>
            <button class="btn ok" id="btnSaveDailySales">Save Daily Sales</button>
          </div>
        </div>
        
        <div class="card">
          <h3>Recent Daily Sales</h3>
          <div class="grid-3" style="margin-bottom:16px;">
            <div>
              <label>From Date</label>
              <input type="date" id="saleFrom">
            </div>
            <div>
              <label>To Date</label>
              <input type="date" id="saleTo">
            </div>
            <div style="align-self:flex-end;">
              <button class="btn" id="btnFilterSales">Filter</button>
            </div>
          </div>
          
          <table class="table compact-table" id="salesHistoryTable">
            <thead>
              <tr>
                <th>Date</th>
                <th>Shift</th>
                <th>Items Sold</th>
                <th>Total Sales</th>
                <th>Total Profit</th>
                <th>Margin</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
      
      <div class="hr"></div>
      
      <div class="card">
        <h3>Product Sales Analysis</h3>
        <div class="grid-4" style="margin-bottom:16px;">
          <div>
            <label>Product</label>
            <select id="productHistorySelect"></select>
          </div>
          <div>
            <label>From Date</label>
            <input type="date" id="productHistoryFrom">
          </div>
          <div>
            <label>To Date</label>
            <input type="date" id="productHistoryTo">
          </div>
          <div>
            <label>Analysis Type</label>
            <select id="analysisType">
              <option value="daily">Daily Sales</option>
              <option value="weekly">Weekly Summary</option>
              <option value="monthly">Monthly Summary</option>
            </select>
          </div>
        </div>
        
        <table class="table compact-table" id="productHistoryTable">
          <thead>
            <tr>
              <th>Period</th>
              <th>Quantity Sold</th>
              <th>Avg Price</th>
              <th>Total Sales</th>
              <th>Total Cost</th>
              <th>Total Profit</th>
              <th>Profit Margin</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- Expenses -->
    <section id="expenses" class="tabpanel" style="display:none;">
      <div class="grid-2">
        <div class="card">
          <h3>Record Expense</h3>
          <div class="grid-3">
            <div>
              <label>Date</label>
              <input type="date" id="expenseDate" value="">
            </div>
            <div>
              <label>Expense Type</label>
              <select id="expenseType">
                <option value="rent">Rent</option>
                <option value="utilities">Utilities (Water, Electricity)</option>
                <option value="salaries">Salaries & Wages</option>
                <option value="supplies">Bar Supplies</option>
                <option value="maintenance">Maintenance & Repairs</option>
                <option value="marketing">Marketing & Advertising</option>
                <option value="transport">Transport & Delivery</option>
                <option value="insurance">Insurance</option>
                <option value="taxes">Taxes & Licenses</option>
                <option value="other">Other</option>
              </select>
            </div>
            <div>
              <label>Amount (UGX)</label>
              <input type="number" id="expenseAmount" min="0" value="0">
            </div>
          </div>
          
          <div class="grid-2">
            <div>
              <label>Payment Method</label>
              <select id="expensePaymentMethod">
                <option value="cash">Cash</option>
                <option value="mobile">Mobile Money</option>
                <option value="bank">Bank Transfer</option>
                <option value="credit">Credit Card</option>
              </select>
            </div>
            <div>
              <label>Recurring</label>
              <select id="expenseRecurring">
                <option value="no">One-time</option>
                <option value="daily">Daily</option>
                <option value="weekly">Weekly</option>
                <option value="monthly">Monthly</option>
              </select>
            </div>
          </div>
          
          <div>
            <label>Description</label>
            <textarea id="expenseDescription" rows="3" placeholder="Enter expense details..."></textarea>
          </div>
          
          <div class="right" style="margin-top:16px;">
            <button class="btn primary" id="btnSaveExpense">Save Expense</button>
          </div>
        </div>
        
        <div class="card">
          <h3>Recent Expenses</h3>
          <div class="grid-3" style="margin-bottom:16px;">
            <div>
              <label>From Date</label>
              <input type="date" id="expenseFrom">
            </div>
            <div>
              <label>To Date</label>
              <input type="date" id="expenseTo">
            </div>
            <div style="align-self:flex-end;">
              <button class="btn" id="btnFilterExpenses">Filter</button>
            </div>
          </div>
          
          <table class="table compact-table" id="expensesTable">
            <thead>
              <tr>
                <th>Date</th>
                <th>Type</th>
                <th>Description</th>
                <th>Amount</th>
                <th>Method</th>
                <th></th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
          
          <div class="right" style="margin-top:16px;">
            <div class="stat">
              <span class="muted">Total Expenses</span>
              <b id="totalExpenses">UGX 0</b>
            </div>
          </div>
        </div>
      </div>
      
      <div class="hr"></div>
      
      <div class="card">
        <h3>Expense Analysis</h3>
        <div class="grid-4">
          <div class="stat">
            <span class="muted">This Month</span>
            <b id="expensesThisMonth">UGX 0</b>
          </div>
          <div class="stat">
            <span class="muted">Avg Daily</span>
            <b id="avgDailyExpense">UGX 0</b>
          </div>
          <div class="stat">
            <span class="muted">Largest Category</span>
            <b id="largestExpenseCategory">-</b>
          </div>
          <div class="stat">
            <span class="muted">Expense Ratio</span>
            <b id="expenseRatio">0%</b>
          </div>
        </div>
      </div>
    </section>

    <!-- Reports -->
    <section id="reports" class="tabpanel" style="display:none;">
      <div class="card">
        <div class="section-tools">
          <h3 style="margin-right:auto">Comprehensive Profit & Loss Report</h3>
          <button class="btn" id="btnPrintReport">Print</button>
          <button class="btn" id="btnExportReport">Export Excel</button>
        </div>
        
        <div class="grid-4">
          <div>
            <label>Report Period Start</label>
            <input type="date" id="reportStart" value="">
          </div>
          <div>
            <label>Report Period End</label>
            <input type="date" id="reportEnd" value="">
          </div>
          <div>
            <label>Compare With</label>
            <select id="comparePeriod">
              <option value="none">No Comparison</option>
              <option value="previous">Previous Period</option>
              <option value="same_last_month">Same Period Last Month</option>
              <option value="budget">Budget</option>
            </select>
          </div>
          <div class="right">
            <button class="btn primary" id="btnGenerateReport">Generate Report</button>
          </div>
        </div>
        
        <div class="hr"></div>
        
        <div id="reportOutput">
          <!-- Report will be generated here -->
        </div>
      </div>
    </section>

    <!-- Products -->
    <section id="products" class="tabpanel" style="display:none;">
      <div class="row">
        <div class="card" style="grid-column:span 4;">
          <h3>Product Management</h3>
          <div>
            <label>Product Name</label>
            <input id="productName" type="text" placeholder="e.g., NILE Beer">
          </div>
          <div style="margin-top:12px;">
            <label>Category</label>
            <select id="productCategory">
              <option value="beer">Beer</option>
              <option value="Soft Drink">Soft Drink</option>
              <option value="Energy Drink">Energy Drink</option>
              <option value="Spirit">Spirit</option>
              <option value="wine">Wine</option>
            </select>
          </div>
          <div class="grid-2" style="margin-top:12px;gap:12px;">
            <div>
              <label>Purchase Price (UGX)</label>
              <input id="productCost" type="number" min="0" value="0">
            </div>
            <div>
              <label>Sale Price (UGX)</label>
              <input id="productPrice" type="number" min="0" value="0">
            </div>
          </div>
          <div class="grid-2" style="margin-top:12px;gap:12px;">
            <div>
              <label>Current Stock</label>
              <input id="productStock" type="number" min="0" value="0">
              <small class="help">Auto-updates with purchases/sales</small>
            </div>
            <div>
              <label>Reorder Level</label>
              <input id="productMinStock" type="number" min="0" value="10">
            </div>
          </div>
          <div class="grid-2" style="margin-top:12px;gap:12px;">
            <div>
              <label>Target Stock</label>
              <input id="productTargetStock" type="number" min="0" value="30">
            </div>
            <div>
              <label>Unit</label>
              <select id="productUnit">
                <option value="bottle">Bottle</option>
                <option value="can">Can</option>
                <option value="pack">Pack</option>
                <option value="crate">Crate</option>
              </select>
            </div>
          </div>
          <div class="stack" style="margin-top:20px;">
            <button class="btn primary" id="btnSaveProduct">Save Product</button>
            <button class="btn bad" id="btnDeleteProduct" disabled>Delete</button>
          </div>
          <p class="help">Stock automatically updates with purchases and sales</p>
        </div>
        
        <div class="card" style="grid-column:span 8;">
          <h3>Product List with Performance Metrics</h3>
          <div class="section-tools" style="margin-bottom:16px;">
            <input type="text" id="productSearch" placeholder="Search products..." style="flex:1;">
            <select id="productSort">
              <option value="name">Sort by Name</option>
              <option value="category">Sort by Category</option>
              <option value="stock">Sort by Stock</option>
              <option value="profit">Sort by Profit Margin</option>
              <option value="sales">Sort by Sales Volume</option>
            </select>
          </div>
          
          <table class="table" id="productsTable">
            <thead>
              <tr>
                <th>Product</th>
                <th>Category</th>
                <th>Cost Price</th>
                <th>Sale Price</th>
                <th>Profit Margin</th>
                <th>Current Stock</th>
                <th>Sold</th>
                <th>Turnover Rate</th>
                <th>Value</th>
                <th></th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- Data Section -->
    <section id="data" class="tabpanel" style="display:none;">
      <div class="row">
        <!-- Backup / Restore -->
        <div class="card" style="grid-column: span 4;">
          <h3>Backup / Restore (Local JSON)</h3>
          <div class="stack section-tools">
            <button class="btn primary" id="btnBackup">Export JSON</button>
            <label class="btn">
              <input type="file" id="restoreFile" accept="application/json" style="display:none">
              Import JSON
            </label>
            <button class="btn" id="btnSaveNow">Save Now</button>
          </div>
          <div class="stat" style="margin-top:12px;">
            <span class="muted">Last Saved</span>
            <b id="lastSaveTime">Never</b>
          </div>
          <p class="help">Exports all data including purchases, sales, expenses</p>
        </div>

        <!-- Excel Export -->
        <div class="card" style="grid-column: span 4;">
          <h3>Excel Export</h3>
          <div class="stack section-tools">
            <button class="btn" id="btnExportAllData">Export All Data</button>
            <button class="btn" id="btnExportProfitLoss">Export P&L Report</button>
          </div>
          
          <div class="grid-2" style="margin-top:12px; gap:8px;">
            <div>
              <label>Export From</label>
              <input type="date" id="exportFrom">
            </div>
            <div>
              <label>Export To</label>
              <input type="date" id="exportTo">
            </div>
          </div>
          
          <div class="right" style="margin-top:12px;">
            <button class="btn ok" id="btnExportInventoryExcel">Export Inventory</button>
          </div>
        </div>

        <!-- Google Drive Sync -->
        <div class="card" style="grid-column: span 4;">
          <h3>Google Drive Sync</h3>
          <div class="stack section-tools">
            <button class="btn" id="btnGSignIn">Sign in with Google</button>
            <button class="btn primary" id="btnCloudSave" disabled>Save to Drive</button>
            <button class="btn" id="btnCloudLoad" disabled>Load from Drive</button>
          </div>
          
          <div class="stack" style="margin-top:12px;">
            <span id="cloudStatus" class="pill">Signed out</span>
            <span id="cloudFileInfo" class="muted"></span>
          </div>
          
          <div class="stat" style="margin-top:12px;">
            <span class="muted">Last Cloud Backup</span>
            <b id="lastCloudBackup">Never</b>
          </div>
        </div>
      </div>

      <div class="row" style="margin-top:16px;">
        <!-- Data Management -->
        <div class="card" style="grid-column: span 8;">
          <h3>Data Management & Tools</h3>
          <div class="grid-3">
            <button class="btn" id="btnRecalculateInventory">Recalculate All Inventory</button>
            <button class="btn" id="btnFixStockLevels">Fix Stock Discrepancies</button>
            <button class="btn" id="btnGenerateTestData">Generate Test Data</button>
          </div>
          
          <div class="grid-3" style="margin-top:12px;">
            <button class="btn" id="btnImportExcel">Import Excel Data</button>
            <button class="btn" id="btnExportTransactions">Export Transactions</button>
            <button class="btn" id="btnDataAudit">Run Data Audit</button>
          </div>
          
          <div id="dataAuditResults" style="margin-top:12px; padding:12px; border:1px solid var(--line); border-radius:8px; display:none;">
            <h4>Data Audit Results</h4>
            <pre id="auditResultsText" style="font-size:12px; max-height:200px; overflow:auto;"></pre>
          </div>
        </div>

        <!-- Danger Zone -->
        <div class="card" style="grid-column: span 4;">
          <h3 style="color: var(--bad);">Danger Zone</h3>
          <div class="warnmsg">
            <strong>Warning:</strong> These actions are irreversible.
          </div>
          <div class="stack" style="margin-top:16px;">
            <button class="btn bad" id="btnWipe">Reset ALL Data</button>
            <button class="btn bad" id="btnClearPurchases">Clear Purchases</button>
            <button class="btn bad" id="btnClearExpenses">Clear Expenses</button>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- Loading Modal -->
  <div id="loading" class="loading">
    <div class="loading-spinner"></div>
    <p>Processing...</p>
  </div>

<script>
// ================ UTILITY FUNCTIONS ================
const UGX = (v) => new Intl.NumberFormat('en-UG', {
  style: 'currency',
  currency: 'UGX',
  maximumFractionDigits: 0
}).format(v || 0);

const todayStr = () => {
  const now = new Date();
  const year = now.getFullYear();
  const month = String(now.getMonth() + 1).padStart(2, '0');
  const day = String(now.getDate()).padStart(2, '0');
  return `${year}-${month}-${day}`;
};

function download(filename, blob) {
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  setTimeout(() => URL.revokeObjectURL(a.href), 1000);
}

function showLoading(show) {
  document.getElementById('loading').style.display = show ? 'flex' : 'none';
}

// ================ ENHANCED DATA STRUCTURE ================
const STORAGE_KEY = 'bar_management_complete_v3';
let db = {
  // Products with full inventory tracking
  products: [],
  // Purchases with inventory tracking
  purchases: [], // { id, date, supplier, invoiceNo, items: [], total, status, paymentMethod }
  // Daily sales sheets
  dailySheets: {}, // key: date, value: { date, shift, items: [], totalSales, totalCost, totalProfit }
  // Expenses
  expenses: [], // { date, type, description, amount, paymentMethod, recurring }
  // Stock adjustments (for manual corrections)
  adjustments: [], // { date, productId, previousQty, newQty, reason }
  // Settings
  settings: { 
    lastSave: new Date().toISOString(),
    accountingPeriod: 'monthly',
    taxRate: 18,
    defaultProfitMargin: 40,
    autoReorder: true,
    lowStockThreshold: 20 // percentage
  }
};

// Load saved data
try {
  const saved = localStorage.getItem(STORAGE_KEY);
  if (saved) {
    db = JSON.parse(saved);
  }
} catch (e) {
  console.error('Error loading saved data:', e);
}

function saveData() {
  try {
    db.settings.lastSave = new Date().toISOString();
    localStorage.setItem(STORAGE_KEY, JSON.stringify(db));
    updateLastSaveTime();
    return true;
  } catch (e) {
    console.error('Error saving data:', e);
    return false;
  }
}

function updateLastSaveTime() {
  const lastSaveEl = document.getElementById('lastSaveTime');
  if (lastSaveEl && db.settings.lastSave) {
    const lastSave = new Date(db.settings.lastSave);
    lastSaveEl.textContent = lastSave.toLocaleDateString() + ' ' + lastSave.toLocaleTimeString();
  }
}

// ================ INVENTORY MANAGEMENT SYSTEM ================
class InventorySystem {
  static getProductById(id) {
    return db.products.find(p => p.id === id);
  }

  static getProductByName(name) {
    return db.products.find(p => p.name.toLowerCase() === name.toLowerCase());
  }

  // Calculate current stock for a product based on all transactions
  static calculateCurrentStock(productId, upToDate = null) {
    const product = this.getProductById(productId);
    if (!product) return 0;
    
    // Start with opening stock
    let stock = product.openingStock || 0;
    
    // Add purchases up to date
    db.purchases.forEach(purchase => {
      if (upToDate && purchase.date > upToDate) return;
      if (purchase.status !== 'received' && purchase.status !== 'partially') return;
      
      purchase.items.forEach(item => {
        if (item.productId === productId) {
          stock += item.quantity || 0;
        }
      });
    });
    
    // Subtract sales up to date
    Object.values(db.dailySheets).forEach(sheet => {
      if (upToDate && sheet.date > upToDate) return;
      
      sheet.items.forEach(item => {
        if (item.productId === productId) {
          stock -= item.quantity || 0;
        }
      });
    });
    
    // Apply adjustments
    db.adjustments.forEach(adj => {
      if (upToDate && adj.date > upToDate) return;
      if (adj.productId === productId) {
        stock = adj.newQty; // Adjustments set absolute value
      }
    });
    
    return Math.max(0, stock);
  }

  // Update product stock based on all transactions
  static updateProductStock(productId) {
    const product = this.getProductById(productId);
    if (!product) return;
    
    product.currentStock = this.calculateCurrentStock(productId);
    product.lastStockUpdate = new Date().toISOString();
    
    // Update stock status
    const reorderLevel = product.reorderLevel || product.minStockLevel || 10;
    const targetLevel = product.targetStock || 30;
    
    if (product.currentStock === 0) {
      product.stockStatus = 'out';
    } else if (product.currentStock <= reorderLevel) {
      product.stockStatus = 'low';
    } else if (product.currentStock > targetLevel) {
      product.stockStatus = 'excess';
    } else {
      product.stockStatus = 'good';
    }
    
    return product.currentStock;
  }

  // Update all products stock
  static updateAllStocks() {
    db.products.forEach(product => {
      this.updateProductStock(product.id);
    });
    saveData();
  }

  // Get total inventory value
  static getInventoryValue(asOfDate = null) {
    return db.products.reduce((total, product) => {
      const stock = asOfDate ? 
        this.calculateCurrentStock(product.id, asOfDate) : 
        (product.currentStock || 0);
      return total + (stock * (product.purchasePrice || 0));
    }, 0);
  }

  // Get cost of goods sold for period
  static getCOGS(startDate, endDate) {
    let cogs = 0;
    
    Object.values(db.dailySheets).forEach(sheet => {
      if (sheet.date >= startDate && sheet.date <= endDate) {
        cogs += sheet.totalCost || 0;
      }
    });
    
    return cogs;
  }

  // Get items needing reorder
  static getItemsNeedingReorder() {
    return db.products.filter(product => {
      const reorderLevel = product.reorderLevel || product.minStockLevel || 10;
      return (product.currentStock || 0) <= reorderLevel;
    });
  }

  // Get stock turnover rate for product
  static getStockTurnover(productId, periodDays = 30) {
    const product = this.getProductById(productId);
    if (!product) return 0;
    
    const endDate = todayStr();
    const startDate = new Date();
    startDate.setDate(startDate.getDate() - periodDays);
    const startDateStr = startDate.toISOString().split('T')[0];
    
    let totalSold = 0;
    Object.values(db.dailySheets).forEach(sheet => {
      if (sheet.date >= startDateStr && sheet.date <= endDate) {
        sheet.items.forEach(item => {
          if (item.productId === productId) {
            totalSold += item.quantity || 0;
          }
        });
      }
    });
    
    const avgStock = (product.currentStock || 0 + (product.openingStock || 0)) / 2;
    return avgStock > 0 ? totalSold / avgStock : 0;
  }
}

// Initialize products from Excel data if empty
function initializeProductsFromExcel() {
  if (db.products.length > 0) return;
  
  const excelProducts = [
    { name: "NILE", category: "beer", purchasePrice: 3100, salePrice: 5100, openingStock: 10 },
    { name: "LITE", category: "beer", purchasePrice: 3100, salePrice: 5100, openingStock: 10 },
    { name: "MALT", category: "beer", purchasePrice: 3100, salePrice: 5100, openingStock: 10 },
    { name: "CLUB", category: "beer", purchasePrice: 3100, salePrice: 5100, openingStock: 10 },
    { name: "BELL", category: "beer", purchasePrice: 3100, salePrice: 5100, openingStock: 10 },
    { name: "GUINESS SMALL", category: "beer", purchasePrice: 3100, salePrice: 5100, openingStock: 10 },
    { name: "GUINESS BIG", category: "beer", purchasePrice: 3100, salePrice: 5100, openingStock: 10 },
    { name: "SIRMINOFF", category: "beer", purchasePrice: 3100, salePrice: 5100, openingStock: 10 },
    { name: "T.LAGER", category: "beer", purchasePrice: 3100, salePrice: 5100, openingStock: 10 },
    { name: "EAGLE", category: "beer", purchasePrice: 3100, salePrice: 5100, openingStock: 10 },
    { name: "T.CIDER", category: "beer", purchasePrice: 3100, salePrice: 5100, openingStock: 10 },
    { name: "PILSNER", category: "beer", purchasePrice: 3100, salePrice: 5100, openingStock: 10 },
    { name: "SODA", category: "Soft Drink", purchasePrice: 1000, salePrice: 2000, openingStock: 10 },
    { name: "POWER PLAY", category: "Energy Drink", purchasePrice: 1000, salePrice: 2000, openingStock: 10 },
    { name: "PREDATOR", category: "Energy Drink", purchasePrice: 1000, salePrice: 2000, openingStock: 10 },
    { name: "ROCK BOOM", category: "Energy Drink", purchasePrice: 1000, salePrice: 2000, openingStock: 10 },
    { name: "STING", category: "Energy Drink", purchasePrice: 1000, salePrice: 2000, openingStock: 10 },
    { name: "RWENZORI", category: "Soft Drink", purchasePrice: 600, salePrice: 1000, openingStock: 10 },
    { name: "YACKET", category: "Soft Drink", purchasePrice: 416, salePrice: 1000, openingStock: 10 },
    { name: "MINUTE MAID", category: "Soft Drink", purchasePrice: 1000, salePrice: 2000, openingStock: 10 },
    { name: "ONER", category: "Soft Drink", purchasePrice: 1000, salePrice: 2000, openingStock: 10 },
    { name: "UG Big", category: "Spirit", purchasePrice: 2000, salePrice: 3000, openingStock: 10 },
    { name: "ug1/2", category: "Spirit", purchasePrice: 2000, salePrice: 3000, openingStock: 10 },
    { name: "Ug1/4", category: "Spirit", purchasePrice: 2000, salePrice: 3000, openingStock: 10 },
    { name: "Ug Plastic", category: "Spirit", purchasePrice: 2000, salePrice: 3000, openingStock: 10 },
    { name: "V&A BIG", category: "Spirit", purchasePrice: 2000, salePrice: 3000, openingStock: 10 },
    { name: "V&A 1/4", category: "Spirit", purchasePrice: 2000, salePrice: 3000, openingStock: 10 },
    { name: "FOUR COUSINS", category: "wine", purchasePrice: 2000, salePrice: 3000, openingStock: 10 },
    { name: "BLACK & WHITE", category: "wine", purchasePrice: 2000, salePrice: 3000, openingStock: 10 },
    { name: "Bond 7 ( 1/4)", category: "Spirit", purchasePrice: 2000, salePrice: 3000, openingStock: 10 },
    { name: "Bond 7 Big", category: "Spirit", purchasePrice: 2000, salePrice: 3000, openingStock: 10 },
    { name: "Gilbeys 1/4", category: "Spirit", purchasePrice: 2000, salePrice: 3000, openingStock: 10 },
    { name: "Red Bull", category: "Energy Drink", purchasePrice: 2000, salePrice: 3000, openingStock: 10 },
    { name: "Guiness Smooth", category: "beer", purchasePrice: 2000, salePrice: 3000, openingStock: 10 },
    { name: "Amalula", category: "wine", purchasePrice: 2000, salePrice: 3000, openingStock: 10 },
    { name: "Grands", category: "wine", purchasePrice: 2000, salePrice: 3000, openingStock: 10 },
    { name: "Ondavit", category: "wine", purchasePrice: 2000, salePrice: 3000, openingStock: 10 },
    { name: "C.Morgan", category: "wine", purchasePrice: 2000, salePrice: 3000, openingStock: 10 },
    { name: "Scount", category: "wine", purchasePrice: 2000, salePrice: 3000, openingStock: 10 },
    { name: "Antonious", category: "wine", purchasePrice: 2000, salePrice: 3000, openingStock: 10 },
    { name: "Robertson", category: "wine", purchasePrice: 2000, salePrice: 3000, openingStock: 10 },
    { name: "Ballanties", category: "wine", purchasePrice: 2000, salePrice: 3000, openingStock: 10 },
    { name: "Singleton", category: "wine", purchasePrice: 2000, salePrice: 3000, openingStock: 10 },
    { name: "Jameson", category: "wine", purchasePrice: 2000, salePrice: 3000, openingStock: 10 },
    { name: "Famous Grouse", category: "wine", purchasePrice: 2000, salePrice: 3000, openingStock: 10 },
    { name: "J.P Chente", category: "wine", purchasePrice: 2000, salePrice: 3000, openingStock: 10 },
    { name: "Baileys", category: "wine", purchasePrice: 2000, salePrice: 3000, openingStock: 10 },
    { name: "8PM", category: "wine", purchasePrice: 2000, salePrice: 3000, openingStock: 10 },
    { name: "GIlbeys BIG", category: "Spirit", purchasePrice: 2000, salePrice: 3000, openingStock: 10 },
    { name: "Castle Lite", category: "beer", purchasePrice: 2000, salePrice: 3000, openingStock: 10 },
    { name: "Can of Guinness", category: "beer", purchasePrice: 2000, salePrice: 3000, openingStock: 10 },
    { name: "Doprick", category: "wine", purchasePrice: 2000, salePrice: 3000, openingStock: 10 },
    { name: "High 5", category: "Spirit", purchasePrice: 2000, salePrice: 3000, openingStock: 10 }
  ];
  
  db.products = excelProducts.map((p, index) => ({
    id: 'prod_' + (index + 1),
    name: p.name,
    category: p.category,
    purchasePrice: p.purchasePrice,
    salePrice: p.salePrice,
    openingStock: p.openingStock,
    currentStock: p.openingStock,
    reorderLevel: 5,
    targetStock: 20,
    minStockLevel: 5,
    unit: 'bottle',
    stockStatus: 'good',
    soldCount: 0,
    totalProfit: 0,
    totalSales: 0
  }));
  
  saveData();
}

// ================ DASHBOARD FUNCTIONS ================
function updateDashboardStats() {
  // Total products
  document.getElementById('statProducts').textContent = db.products.length;
  
  // Stock value
  const stockValue = InventorySystem.getInventoryValue();
  document.getElementById('statStockValue').textContent = UGX(stockValue);
  
  // Monthly purchases
  const currentMonth = todayStr().substring(0, 7);
  const monthlyPurchases = db.purchases
    .filter(p => p.date && p.date.startsWith(currentMonth) && p.status !== 'cancelled')
    .reduce((sum, p) => sum + (p.total || 0), 0);
  document.getElementById('statMonthPurchases').textContent = UGX(monthlyPurchases);
  
  // Most moving category
  const categorySales = {};
  Object.values(db.dailySheets).forEach(sheet => {
    sheet.items.forEach(item => {
      const product = InventorySystem.getProductById(item.productId);
      if (product) {
        const cat = product.category || 'other';
        categorySales[cat] = (categorySales[cat] || 0) + item.quantity;
      }
    });
  });
  
  let mostMovingCategory = '-';
  let maxSales = 0;
  for (const [category, sales] of Object.entries(categorySales)) {
    if (sales > maxSales) {
      maxSales = sales;
      mostMovingCategory = category;
    }
  }
  document.getElementById('statMostMoving').textContent = mostMovingCategory;
  
  // Calculate profits for accounting period
  const periodStart = db.settings.periodStart || todayStr().substring(0, 7) + '-01';
  const periodEnd = db.settings.periodEnd || todayStr();
  
  let grossProfit = 0;
  let totalExpenses = 0;
  let totalSales = 0;
  
  // Calculate gross profit and total sales from daily sheets
  Object.values(db.dailySheets).forEach(sheet => {
    if (sheet.date >= periodStart && sheet.date <= periodEnd) {
      grossProfit += sheet.totalProfit || 0;
      totalSales += sheet.totalSales || 0;
    }
  });
  
  // Calculate total expenses for period
  db.expenses.forEach(expense => {
    if (expense.date >= periodStart && expense.date <= periodEnd) {
      totalExpenses += expense.amount || 0;
    }
  });
  
  const netProfit = grossProfit - totalExpenses;
  const cogs = InventorySystem.getCOGS(periodStart, periodEnd);
  const inventoryValue = InventorySystem.getInventoryValue();
  
  // Calculate ROI (Return on Investment)
  const totalInvestment = inventoryValue + cogs;
  const roi = totalInvestment > 0 ? (netProfit / totalInvestment * 100).toFixed(1) : 0;
  
  document.getElementById('statGrossProfit').textContent = UGX(grossProfit);
  document.getElementById('statTotalExpenses').textContent = UGX(totalExpenses);
  document.getElementById('statNetProfit').textContent = UGX(netProfit);
  document.getElementById('statInventoryInvestment').textContent = UGX(inventoryValue);
  document.getElementById('statCOGS').textContent = UGX(cogs);
  document.getElementById('statROI').textContent = roi + '%';
  
  // Update profitability status
  const profitStatusEl = document.getElementById('profitStatus');
  const profitStatusCard = document.getElementById('profitStatusCard');
  const inventoryStatusEl = document.getElementById('inventoryStatus');
  
  if (netProfit > 0) {
    profitStatusEl.innerHTML = `<strong> PROFITABLE:</strong> Net profit of ${UGX(netProfit)} (ROI: ${roi}%)`;
    profitStatusEl.className = 'goodmsg';
  } else if (netProfit < 0) {
    profitStatusEl.innerHTML = `<strong> LOSS MAKING:</strong> Net loss of ${UGX(Math.abs(netProfit))}`;
    profitStatusEl.className = 'badmsg';
  } else {
    profitStatusEl.innerHTML = `<strong> BREAK EVEN:</strong> Business is breaking even`;
    profitStatusEl.className = 'warnmsg';
  }
  
  // Update inventory status
  const lowStockItems = InventorySystem.getItemsNeedingReorder();
  const outOfStockItems = db.products.filter(p => (p.currentStock || 0) === 0);
  
  if (outOfStockItems.length > 0) {
    inventoryStatusEl.innerHTML = `<strong> CRITICAL:</strong> ${outOfStockItems.length} products out of stock`;
    inventoryStatusEl.className = 'badmsg';
  } else if (lowStockItems.length > 0) {
    inventoryStatusEl.innerHTML = `<strong> WARNING:</strong> ${lowStockItems.length} products need reorder`;
    inventoryStatusEl.className = 'warnmsg';
  } else {
    inventoryStatusEl.innerHTML = `<strong> GOOD:</strong> All products have sufficient stock`;
    inventoryStatusEl.className = 'goodmsg';
  }
}

// ================ TAB MANAGEMENT ================
function setupTabs() {
  const tabs = document.querySelectorAll('.tab');
  const panels = document.querySelectorAll('.tabpanel');
  
  tabs.forEach(tab => {
    tab.addEventListener('click', () => {
      tabs.forEach(t => t.classList.remove('active'));
      panels.forEach(p => p.style.display = 'none');
      
      tab.classList.add('active');
      const tabId = tab.getAttribute('data-tab');
      const panel = document.getElementById(tabId);
      if (panel) {
        panel.style.display = 'block';
        
        if (tabId === 'products') renderProducts();
        if (tabId === 'purchases') renderPurchases();
        if (tabId === 'sales') renderSales();
        if (tabId === 'inventory') renderInventory();
        if (tabId === 'expenses') renderExpenses();
        if (tabId === 'reports') initReports();
        if (tabId === 'data') renderDataSection();
      }
    });
  });
}

// ================ PRODUCTS MANAGEMENT ================
let editingProductId = null;

function renderProducts() {
  const searchTerm = document.getElementById('productSearch').value.toLowerCase();
  const sortBy = document.getElementById('productSort').value;
  
  let filtered = [...db.products];
  
  if (searchTerm) {
    filtered = filtered.filter(p => 
      p.name.toLowerCase().includes(searchTerm) || 
      (p.category || '').toLowerCase().includes(searchTerm)
    );
  }
  
  // Sort products
  filtered.sort((a, b) => {
    if (sortBy === 'name') return a.name.localeCompare(b.name);
    if (sortBy === 'category') return (a.category || '').localeCompare(b.category || '');
    if (sortBy === 'stock') return (b.currentStock || 0) - (a.currentStock || 0);
    if (sortBy === 'profit') {
      const marginA = a.purchasePrice > 0 ? ((a.salePrice - a.purchasePrice) / a.purchasePrice * 100) : 0;
      const marginB = b.purchasePrice > 0 ? ((b.salePrice - b.purchasePrice) / b.purchasePrice * 100) : 0;
      return marginB - marginA;
    }
    if (sortBy === 'sales') return (b.soldCount || 0) - (a.soldCount || 0);
    return 0;
  });
  
  const tbody = document.querySelector('#productsTable tbody');
  if (tbody) {
    tbody.innerHTML = filtered.map(p => {
      const profitMargin = p.purchasePrice > 0 ? 
        ((p.salePrice - p.purchasePrice) / p.purchasePrice * 100).toFixed(1) : 0;
      const stockValue = (p.currentStock || 0) * (p.purchasePrice || 0);
      const turnover = InventorySystem.getStockTurnover(p.id, 30).toFixed(2);
      
      let stockClass = '';
      if (p.currentStock === 0) stockClass = 'stock-out';
      else if (p.currentStock <= (p.reorderLevel || p.minStockLevel || 5)) stockClass = 'stock-low';
      else if (p.currentStock > (p.targetStock || 30)) stockClass = 'stock-good';
      
      return `
      <tr class="${stockClass}">
        <td><strong>${p.name}</strong></td>
        <td><span class="pill">${p.category || 'other'}</span></td>
        <td>${UGX(p.purchasePrice || 0)}</td>
        <td>${UGX(p.salePrice || 0)}</td>
        <td><span class="${profitMargin >= 0 ? 'positive' : 'negative'}">${profitMargin}%</span></td>
        <td><strong>${p.currentStock || 0}</strong></td>
        <td>${p.soldCount || 0}</td>
        <td>${turnover}</td>
        <td>${UGX(stockValue)}</td>
        <td><button class="btn" data-edit="${p.id}">Edit</button></td>
      </tr>
      `;
    }).join('');
  }
  
  // Populate product selects
  populateProductSelects();
}

function populateProductSelects() {
  const purchaseSelect = document.getElementById('purchaseProduct');
  const saleSelect = document.getElementById('saleProduct');
  const historySelect = document.getElementById('productHistorySelect');
  
  if (purchaseSelect) {
    purchaseSelect.innerHTML = '<option value="">Select Product</option>' +
      db.products.map(p => 
        `<option value="${p.id}" data-cost="${p.purchasePrice}">${p.name} (Stock: ${p.currentStock || 0})</option>`
      ).join('');
  }
  
  if (saleSelect) {
    saleSelect.innerHTML = '<option value="">Select Product</option>' +
      db.products.map(p => 
        `<option value="${p.id}" data-price="${p.salePrice}">${p.name} (Stock: ${p.currentStock || 0})</option>`
      ).join('');
  }
  
  if (historySelect) {
    historySelect.innerHTML = '<option value="">Select Product</option>' +
      db.products.map(p => 
        `<option value="${p.id}">${p.name}</option>`
      ).join('');
  }
}

function setupProducts() {
  // Edit product
  document.getElementById('productsTable').addEventListener('click', (e) => {
    const editBtn = e.target.closest('[data-edit]');
    if (!editBtn) return;
    
    const productId = editBtn.getAttribute('data-edit');
    const product = InventorySystem.getProductById(productId);
    if (!product) return;
    
    editingProductId = productId;
    document.getElementById('productName').value = product.name;
    document.getElementById('productCategory').value = product.category || 'beer';
    document.getElementById('productCost').value = product.purchasePrice || 0;
    document.getElementById('productPrice').value = product.salePrice || 0;
    document.getElementById('productStock').value = product.currentStock || 0;
    document.getElementById('productMinStock').value = product.reorderLevel || product.minStockLevel || 5;
    document.getElementById('productTargetStock').value = product.targetStock || 30;
    document.getElementById('productUnit').value = product.unit || 'bottle';
    document.getElementById('btnDeleteProduct').disabled = false;
  });
  
  // Save product
  document.getElementById('btnSaveProduct').addEventListener('click', () => {
    const name = document.getElementById('productName').value.trim();
    if (!name) {
      alert('Please enter product name');
      return;
    }
    
    const category = document.getElementById('productCategory').value;
    const purchasePrice = parseInt(document.getElementById('productCost').value) || 0;
    const salePrice = parseInt(document.getElementById('productPrice').value) || 0;
    const currentStock = parseInt(document.getElementById('productStock').value) || 0;
    const reorderLevel = parseInt(document.getElementById('productMinStock').value) || 5;
    const targetStock = parseInt(document.getElementById('productTargetStock').value) || 30;
    const unit = document.getElementById('productUnit').value;
    
    if (editingProductId) {
      // Update existing product
      const product = InventorySystem.getProductById(editingProductId);
      if (product) {
        product.name = name;
        product.category = category;
        product.purchasePrice = purchasePrice;
        product.salePrice = salePrice;
        product.reorderLevel = reorderLevel;
        product.targetStock = targetStock;
        product.unit = unit;
        
        // Record stock adjustment if changed
        if (currentStock !== product.currentStock) {
          const adjustment = {
            id: 'adj_' + Date.now(),
            date: todayStr(),
            productId: product.id,
            previousQty: product.currentStock,
            newQty: currentStock,
            reason: 'Manual adjustment',
            recordedAt: new Date().toISOString()
          };
          db.adjustments.push(adjustment);
          product.currentStock = currentStock;
        }
      }
    } else {
      // Create new product
      const newProduct = {
        id: 'prod_' + Date.now(),
        name,
        category,
        purchasePrice,
        salePrice,
        openingStock: currentStock,
        currentStock,
        reorderLevel,
        targetStock,
        unit,
        minStockLevel: reorderLevel,
        stockStatus: 'good',
        soldCount: 0,
        totalProfit: 0,
        totalSales: 0
      };
      db.products.push(newProduct);
    }
    
    saveData();
    renderProducts();
    updateDashboardStats();
    populateProductSelects();
    
    // Reset form
    document.getElementById('productName').value = '';
    document.getElementById('productCost').value = '0';
    document.getElementById('productPrice').value = '0';
    document.getElementById('productStock').value = '0';
    document.getElementById('productMinStock').value = '5';
    document.getElementById('productTargetStock').value = '30';
    document.getElementById('btnDeleteProduct').disabled = true;
    editingProductId = null;
    
    alert('Product saved successfully!');
  });
  
  // Delete product
  document.getElementById('btnDeleteProduct').addEventListener('click', () => {
    if (!editingProductId || !confirm('Are you sure you want to delete this product?')) {
      return;
    }
    
    db.products = db.products.filter(p => p.id !== editingProductId);
    saveData();
    renderProducts();
    updateDashboardStats();
    populateProductSelects();
    
    // Reset form
    document.getElementById('productName').value = '';
    document.getElementById('productCost').value = '0';
    document.getElementById('productPrice').value = '0';
    document.getElementById('productStock').value = '0';
    document.getElementById('productMinStock').value = '5';
    document.getElementById('productTargetStock').value = '30';
    document.getElementById('btnDeleteProduct').disabled = true;
    editingProductId = null;
    
    alert('Product deleted successfully!');
  });
  
  // Search and sort
  document.getElementById('productSearch').addEventListener('input', renderProducts);
  document.getElementById('productSort').addEventListener('change', renderProducts);
}

// ================ PURCHASES MANAGEMENT ================
let purchaseItems = [];

function renderPurchases() {
  const today = todayStr();
  document.getElementById('purchaseDate').value = today;
  document.getElementById('purchaseFrom').value = today;
  document.getElementById('purchaseTo').value = today;
  document.getElementById('purchaseDeliveryDate').value = today;
  
  // Reset form
  purchaseItems = [];
  document.getElementById('purchaseSupplier').value = '';
  document.getElementById('purchaseInvoice').value = '';
  document.getElementById('purchaseQty').value = '1';
  document.getElementById('purchaseCost').value = '';
  document.getElementById('purchaseTax').value = '0';
  document.getElementById('purchaseOtherCharges').value = '0';
  updatePurchaseTotal();
  
  // Load recent purchases
  loadRecentPurchases();
  updatePurchaseAnalysis();
}

function updatePurchaseTotal() {
  const subtotal = purchaseItems.reduce((sum, item) => sum + (item.total || 0), 0);
  const taxRate = parseFloat(document.getElementById('purchaseTax').value) || 0;
  const otherCharges = parseFloat(document.getElementById('purchaseOtherCharges').value) || 0;
  const taxAmount = subtotal * (taxRate / 100);
  const total = subtotal + taxAmount + otherCharges;
  
  document.getElementById('purchaseSubtotal').textContent = UGX(subtotal);
  document.getElementById('purchaseTotal').textContent = UGX(total);
  
  const tbody = document.querySelector('#purchaseItemsTable tbody');
  if (tbody) {
    tbody.innerHTML = purchaseItems.map((item, index) => {
      const product = InventorySystem.getProductById(item.productId);
      return `
      <tr>
        <td>${product?.name || 'Unknown'}</td>
        <td>${item.quantity}</td>
        <td>${UGX(item.unitCost)}</td>
        <td>${UGX(item.total)}</td>
        <td><button class="btn bad" data-remove-purchase="${index}"></button></td>
      </tr>
      `;
    }).join('');
  }
}

function loadRecentPurchases() {
  const from = document.getElementById('purchaseFrom').value || todayStr();
  const to = document.getElementById('purchaseTo').value || todayStr();
  
  const filtered = db.purchases
    .filter(p => p.date >= from && p.date <= to)
    .sort((a, b) => new Date(b.date) - new Date(a.date));
  
  const tbody = document.querySelector('#purchasesTable tbody');
  if (tbody) {
    tbody.innerHTML = filtered.map((purchase, index) => {
      const itemCount = purchase.items?.length || 0;
      const statusColors = {
        'pending': '#f59e0b',
        'received': '#16a34a',
        'partially': '#0ea5e9',
        'cancelled': '#ef4444'
      };
      
      return `
      <tr>
        <td>${purchase.date}</td>
        <td>${purchase.supplier || '-'}</td>
        <td>${itemCount} items</td>
        <td>${UGX(purchase.total || 0)}</td>
        <td>
          <span class="pill" style="background:${statusColors[purchase.status || 'pending']}; color:white;">
            ${purchase.status || 'pending'}
          </span>
        </td>
        <td>
          <button class="btn" data-view-purchase="${index}">View</button>
          <button class="btn bad" data-delete-purchase="${index}"></button>
        </td>
      </tr>
      `;
    }).join('');
  }
}

function updatePurchaseAnalysis() {
  const currentMonth = todayStr().substring(0, 7);
  const monthPurchases = db.purchases.filter(p => 
    p.date && p.date.startsWith(currentMonth) && p.status !== 'cancelled'
  );
  
  const totalMonth = monthPurchases.reduce((sum, p) => sum + (p.total || 0), 0);
  const avgPurchase = monthPurchases.length > 0 ? totalMonth / monthPurchases.length : 0;
  
  // Find top supplier
  const supplierTotals = {};
  monthPurchases.forEach(p => {
    const supplier = p.supplier || 'Unknown';
    supplierTotals[supplier] = (supplierTotals[supplier] || 0) + (p.total || 0);
  });
  
  let topSupplier = '-';
  let maxSupplierTotal = 0;
  for (const [supplier, total] of Object.entries(supplierTotals)) {
    if (total > maxSupplierTotal) {
      maxSupplierTotal = total;
      topSupplier = supplier;
    }
  }
  
  document.getElementById('purchasesThisMonth').textContent = UGX(totalMonth);
  document.getElementById('avgPurchase').textContent = UGX(avgPurchase);
  document.getElementById('topSupplier').textContent = topSupplier;
}

function setupPurchases() {
  // Auto-fill cost when product selected
  document.getElementById('purchaseProduct').addEventListener('change', function() {
    const selectedOption = this.options[this.selectedIndex];
    if (selectedOption && selectedOption.value) {
      const costPrice = selectedOption.getAttribute('data-cost');
      document.getElementById('purchaseCost').value = costPrice || '';
    }
  });
  
  // Add purchase item
  document.getElementById('btnAddPurchaseItem').addEventListener('click', () => {
    const productId = document.getElementById('purchaseProduct').value;
    const quantity = parseInt(document.getElementById('purchaseQty').value) || 1;
    const unitCost = parseInt(document.getElementById('purchaseCost').value) || 0;
    
    if (!productId) {
      alert('Please select a product');
      return;
    }
    if (quantity <= 0) {
      alert('Please enter a valid quantity');
      return;
    }
    if (unitCost <= 0) {
      alert('Please enter a valid cost');
      return;
    }
    
    const product = InventorySystem.getProductById(productId);
    if (!product) {
      alert('Product not found');
      return;
    }
    
    purchaseItems.push({
      productId,
      productName: product.name,
      quantity,
      unitCost,
      total: quantity * unitCost
    });
    
    updatePurchaseTotal();
    
    // Reset form
    document.getElementById('purchaseQty').value = '1';
    document.getElementById('purchaseCost').value = '';
  });
  
  // Remove purchase item
  document.getElementById('purchaseItemsTable').addEventListener('click', (e) => {
    const removeBtn = e.target.closest('[data-remove-purchase]');
    if (!removeBtn) return;
    
    const index = parseInt(removeBtn.getAttribute('data-remove-purchase'));
    purchaseItems.splice(index, 1);
    updatePurchaseTotal();
  });
  
  // Save purchase
  document.getElementById('btnSavePurchase').addEventListener('click', () => {
    if (purchaseItems.length === 0) {
      alert('Please add items to the purchase');
      return;
    }
    
    const date = document.getElementById('purchaseDate').value || todayStr();
    const supplier = document.getElementById('purchaseSupplier').value.trim() || 'Unknown Supplier';
    const invoiceNo = document.getElementById('purchaseInvoice').value.trim() || '';
    const paymentMethod = document.getElementById('purchasePaymentMethod').value;
    const deliveryDate = document.getElementById('purchaseDeliveryDate').value || date;
    const status = document.getElementById('purchaseStatus').value;
    const taxRate = parseFloat(document.getElementById('purchaseTax').value) || 0;
    const otherCharges = parseFloat(document.getElementById('purchaseOtherCharges').value) || 0;
    
    const subtotal = purchaseItems.reduce((sum, item) => sum + item.total, 0);
    const taxAmount = subtotal * (taxRate / 100);
    const total = subtotal + taxAmount + otherCharges;
    
    // Update inventory if purchase is received
    if (status === 'received' || status === 'partially') {
      purchaseItems.forEach(item => {
        const product = InventorySystem.getProductById(item.productId);
        if (product) {
          // Update purchase price if different (optional)
          // product.purchasePrice = item.unitCost;
          
          // Stock will be updated by inventory system when we call updateAllStocks
        }
      });
    }
    
    const newPurchase = {
      id: 'pur_' + Date.now(),
      date,
      supplier,
      invoiceNo,
      paymentMethod,
      deliveryDate,
      status,
      items: [...purchaseItems],
      subtotal,
      taxRate,
      taxAmount,
      otherCharges,
      total,
      recordedAt: new Date().toISOString()
    };
    
    db.purchases.push(newPurchase);
    
    // Update inventory
    InventorySystem.updateAllStocks();
    saveData();
    
    // Refresh display
    renderPurchases();
    renderProducts();
    renderInventory();
    updateDashboardStats();
    
    alert(`Purchase saved successfully! Total: ${UGX(total)}`);
  });
  
  // Filter purchases
  document.getElementById('btnFilterPurchases').addEventListener('click', () => {
    loadRecentPurchases();
    updatePurchaseAnalysis();
  });
  
  // Delete purchase
  document.getElementById('purchasesTable').addEventListener('click', (e) => {
    const deleteBtn = e.target.closest('[data-delete-purchase]');
    if (!deleteBtn) return;
    
    const index = parseInt(deleteBtn.getAttribute('data-delete-purchase'));
    if (confirm('Delete this purchase? This will also reverse inventory updates.')) {
      const purchase = db.purchases[index];
      
      // Remove purchase
      db.purchases.splice(index, 1);
      
      // Update inventory
      InventorySystem.updateAllStocks();
      saveData();
      
      // Refresh display
      renderPurchases();
      renderProducts();
      renderInventory();
      updateDashboardStats();
      
      alert('Purchase deleted successfully!');
    }
  });
}

// ================ SALES MANAGEMENT ================
let dailySaleItems = [];

function renderSales() {
  const today = todayStr();
  document.getElementById('saleDate').value = today;
  document.getElementById('saleFrom').value = today;
  document.getElementById('saleTo').value = today;
  document.getElementById('productHistoryFrom').value = today;
  document.getElementById('productHistoryTo').value = today;
  
  // Reset form
  dailySaleItems = [];
  document.getElementById('saleQty').value = '1';
  document.getElementById('salePrice').value = '';
  updateDailySaleTotal();
  
  // Load recent sales
  loadRecentSales();
}

function updateDailySaleTotal() {
  const totalSales = dailySaleItems.reduce((sum, item) => sum + (item.total || 0), 0);
  const totalCost = dailySaleItems.reduce((sum, item) => sum + (item.cost || 0), 0);
  const totalProfit = dailySaleItems.reduce((sum, item) => sum + (item.profit || 0), 0);
  
  document.getElementById('saleTotal').textContent = UGX(totalSales);
  document.getElementById('saleCost').textContent = UGX(totalCost);
  document.getElementById('saleProfit').textContent = UGX(totalProfit);
  
  const tbody = document.querySelector('#saleItemsTable tbody');
  if (tbody) {
    tbody.innerHTML = dailySaleItems.map((item, index) => {
      return `
      <tr>
        <td>${item.productName}</td>
        <td>${item.quantity}</td>
        <td>${UGX(item.unitPrice)}</td>
        <td>${UGX(item.total)}</td>
        <td>${UGX(item.cost)}</td>
        <td class="${item.profit >= 0 ? 'positive' : 'negative'}">${UGX(item.profit)}</td>
        <td><button class="btn bad" data-remove-sale="${index}"></button></td>
      </tr>
      `;
    }).join('');
  }
}

function loadRecentSales() {
  const from = document.getElementById('saleFrom').value || todayStr();
  const to = document.getElementById('saleTo').value || todayStr();
  
  // Filter sheets by date range
  const filteredSheets = [];
  for (const [date, sheet] of Object.entries(db.dailySheets)) {
    if (date >= from && date <= to) {
      filteredSheets.push({ date, ...sheet });
    }
  }
  
  // Sort by date descending
  filteredSheets.sort((a, b) => new Date(b.date) - new Date(a.date));
  
  const tbody = document.querySelector('#salesHistoryTable tbody');
  if (tbody) {
    tbody.innerHTML = filteredSheets.map(sheet => {
      const itemCount = sheet.items?.length || 0;
      const margin = sheet.totalSales > 0 ? ((sheet.totalProfit || 0) / sheet.totalSales * 100).toFixed(1) : 0;
      
      return `
      <tr>
        <td>${sheet.date}</td>
        <td><span class="pill">${sheet.shift || 'full'}</span></td>
        <td>${itemCount} items</td>
        <td>${UGX(sheet.totalSales || 0)}</td>
        <td>${UGX(sheet.totalProfit || 0)}</td>
        <td>${margin}%</td>
      </tr>
      `;
    }).join('');
  }
}

function setupSales() {
  // Auto-fill price when product selected
  document.getElementById('saleProduct').addEventListener('change', function() {
    const selectedOption = this.options[this.selectedIndex];
    if (selectedOption && selectedOption.value) {
      const salePrice = selectedOption.getAttribute('data-price');
      document.getElementById('salePrice').value = salePrice || '';
    }
  });
  
  // Add sale item
  document.getElementById('btnAddSaleItem').addEventListener('click', () => {
    const productId = document.getElementById('saleProduct').value;
    const quantity = parseInt(document.getElementById('saleQty').value) || 1;
    let unitPrice = parseInt(document.getElementById('salePrice').value) || 0;
    
    if (!productId) {
      alert('Please select a product');
      return;
    }
    if (quantity <= 0) {
      alert('Please enter a valid quantity');
      return;
    }
    
    const product = InventorySystem.getProductById(productId);
    if (!product) {
      alert('Product not found');
      return;
    }
    
    // Use product selling price if not specified
    if (unitPrice <= 0) {
      unitPrice = product.salePrice || 0;
    }
    
    if (unitPrice <= 0) {
      alert('Please enter a valid price');
      return;
    }
    
    // Check stock
    const currentStock = product.currentStock || 0;
    if (currentStock < quantity) {
      if (!confirm(`Only ${currentStock} items in stock. Continue anyway?`)) {
        return;
      }
    }
    
    const total = quantity * unitPrice;
    const cost = quantity * (product.purchasePrice || 0);
    const profit = total - cost;
    
    dailySaleItems.push({
      productId,
      productName: product.name,
      quantity,
      unitPrice,
      total,
      cost,
      profit
    });
    
    updateDailySaleTotal();
    
    // Reset form
    document.getElementById('saleQty').value = '1';
    document.getElementById('salePrice').value = '';
  });
  
  // Remove sale item
  document.getElementById('saleItemsTable').addEventListener('click', (e) => {
    const removeBtn = e.target.closest('[data-remove-sale]');
    if (!removeBtn) return;
    
    const index = parseInt(removeBtn.getAttribute('data-remove-sale'));
    dailySaleItems.splice(index, 1);
    updateDailySaleTotal();
  });
  
  // Save daily sales
  document.getElementById('btnSaveDailySales').addEventListener('click', () => {
    if (dailySaleItems.length === 0) {
      alert('Please add items to the daily sales');
      return;
    }
    
    const date = document.getElementById('saleDate').value || todayStr();
    const shift = document.getElementById('saleShift').value;
    const recordType = document.getElementById('recordType').value;
    
    // Check if sheet for this date already exists
    if (db.dailySheets[date]) {
      if (!confirm(`Sheet already exists for ${date}. Overwrite?`)) {
        return;
      }
    }
    
    // Calculate totals
    const totalSales = dailySaleItems.reduce((sum, item) => sum + item.total, 0);
    const totalCost = dailySaleItems.reduce((sum, item) => sum + item.cost, 0);
    const totalProfit = dailySaleItems.reduce((sum, item) => sum + item.profit, 0);
    
    // Update product sales counts
    dailySaleItems.forEach(item => {
      const product = InventorySystem.getProductById(item.productId);
      if (product) {
        product.soldCount = (product.soldCount || 0) + item.quantity;
        product.totalSales = (product.totalSales || 0) + item.total;
        product.totalProfit = (product.totalProfit || 0) + item.profit;
      }
    });
    
    // Save daily sheet
    db.dailySheets[date] = {
      date,
      shift,
      items: [...dailySaleItems],
      totalSales,
      totalCost,
      totalProfit,
      source: recordType === 'excel' ? 'excel' : 'manual',
      recordedAt: new Date().toISOString()
    };
    
    // Update inventory
    InventorySystem.updateAllStocks();
    saveData();
    
    // Refresh display
    renderSales();
    renderProducts();
    renderInventory();
    updateDashboardStats();
    
    alert(`Daily sales saved for ${date}! Sales: ${UGX(totalSales)}, Profit: ${UGX(totalProfit)}`);
  });
  
  // Filter sales
  document.getElementById('btnFilterSales').addEventListener('click', loadRecentSales);
  
  // Product history
  document.getElementById('productHistorySelect').addEventListener('change', loadProductHistory);
  document.getElementById('productHistoryFrom').addEventListener('change', loadProductHistory);
  document.getElementById('productHistoryTo').addEventListener('change', loadProductHistory);
  document.getElementById('analysisType').addEventListener('change', loadProductHistory);
}

function loadProductHistory() {
  const productId = document.getElementById('productHistorySelect').value;
  const from = document.getElementById('productHistoryFrom').value;
  const to = document.getElementById('productHistoryTo').value;
  const analysisType = document.getElementById('analysisType').value;
  
  if (!productId) return;
  
  const product = InventorySystem.getProductById(productId);
  if (!product) return;
  
  // Group sales by period
  const salesByPeriod = {};
  
  for (const [date, sheet] of Object.entries(db.dailySheets)) {
    if (date >= from && date <= to) {
      const productItems = sheet.items.filter(item => item.productId === productId);
      if (productItems.length > 0) {
        let periodKey;
        
        if (analysisType === 'daily') {
          periodKey = date;
        } else if (analysisType === 'weekly') {
          const dateObj = new Date(date);
          const weekStart = new Date(dateObj);
          weekStart.setDate(dateObj.getDate() - dateObj.getDay());
          periodKey = weekStart.toISOString().split('T')[0] + ' (Week)';
        } else if (analysisType === 'monthly') {
          periodKey = date.substring(0, 7) + ' (Month)';
        }
        
        if (!salesByPeriod[periodKey]) {
          salesByPeriod[periodKey] = {
            qty: 0,
            sales: 0,
            cost: 0,
            profit: 0
          };
        }
        
        productItems.forEach(item => {
          salesByPeriod[periodKey].qty += item.quantity;
          salesByPeriod[periodKey].sales += item.total;
          salesByPeriod[periodKey].cost += item.cost || (item.quantity * product.purchasePrice);
          salesByPeriod[periodKey].profit += item.profit || (item.total - (item.quantity * product.purchasePrice));
        });
      }
    }
  }
  
  // Convert to array and sort
  const periodSales = Object.entries(salesByPeriod).map(([period, data]) => ({
    period,
    ...data,
    avgPrice: data.qty > 0 ? data.sales / data.qty : 0,
    margin: data.sales > 0 ? (data.profit / data.sales * 100) : 0
  }));
  
  // Sort by period
  periodSales.sort((a, b) => a.period.localeCompare(b.period));
  
  const tbody = document.querySelector('#productHistoryTable tbody');
  if (tbody) {
    tbody.innerHTML = periodSales.map(sale => `
      <tr>
        <td>${sale.period}</td>
        <td>${sale.qty}</td>
        <td>${UGX(sale.avgPrice)}</td>
        <td>${UGX(sale.sales)}</td>
        <td>${UGX(sale.cost)}</td>
        <td class="${sale.profit >= 0 ? 'positive' : 'negative'}">${UGX(sale.profit)}</td>
        <td>${sale.margin.toFixed(1)}%</td>
      </tr>
    `).join('');
  }
}

// ================ INVENTORY MANAGEMENT ================
function renderInventory() {
  const date = document.getElementById('inventoryDate').value || todayStr();
  const category = document.getElementById('filterCategory').value;
  const stockStatus = document.getElementById('filterStockStatus').value;
  
  // Update inventory first
  InventorySystem.updateAllStocks();
  
  let filtered = db.products;
  
  if (category) {
    filtered = filtered.filter(p => p.category === category);
  }
  
  if (stockStatus) {
    filtered = filtered.filter(p => p.stockStatus === stockStatus);
  }
  
  const tbody = document.querySelector('#inventoryTable tbody');
  if (tbody) {
    tbody.innerHTML = filtered.map(product => {
      // Calculate historical data
      const openingStock = product.openingStock || 0;
      const currentStock = product.currentStock || 0;
      
      // Calculate purchased up to date
      let totalPurchased = 0;
      db.purchases.forEach(purchase => {
        if (purchase.date <= date && (purchase.status === 'received' || purchase.status === 'partially')) {
          purchase.items.forEach(item => {
            if (item.productId === product.id) {
              totalPurchased += item.quantity || 0;
            }
          });
        }
      });
      
      // Calculate sold up to date
      let totalSold = 0;
      Object.values(db.dailySheets).forEach(sheet => {
        if (sheet.date <= date) {
          sheet.items.forEach(item => {
            if (item.productId === product.id) {
              totalSold += item.quantity || 0;
            }
          });
        }
      });
      
      const stockValue = currentStock * (product.purchasePrice || 0);
      const reorderLevel = product.reorderLevel || product.minStockLevel || 5;
      const targetStock = product.targetStock || 30;
      
      let statusHtml = '';
      let rowClass = '';
      
      if (currentStock === 0) {
        statusHtml = '<span class="pill" style="background:#ef4444; color:white;">Out of Stock</span>';
        rowClass = 'stock-out';
      } else if (currentStock <= reorderLevel) {
        statusHtml = '<span class="pill" style="background:#f59e0b; color:white;">Low Stock</span>';
        rowClass = 'stock-low';
      } else if (currentStock > targetStock * 1.5) {
        statusHtml = '<span class="pill" style="background:#0ea5e9; color:white;">Excess Stock</span>';
        rowClass = 'stock-good';
      } else {
        statusHtml = '<span class="pill" style="background:#16a34a; color:white;">Good</span>';
      }
      
      return `
      <tr class="${rowClass}">
        <td><strong>${product.name}</strong></td>
        <td><span class="pill">${product.category || 'other'}</span></td>
        <td>${openingStock}</td>
        <td>${totalPurchased}</td>
        <td>${totalSold}</td>
        <td><strong>${currentStock}</strong></td>
        <td>${reorderLevel}</td>
        <td>${UGX(product.purchasePrice || 0)}</td>
        <td>${UGX(product.salePrice || 0)}</td>
        <td>${UGX(stockValue)}</td>
        <td>${statusHtml}</td>
      </tr>
      `;
    }).join('');
  }
  
  // Update replenishment suggestions
  updateReplenishmentSuggestions();
  
  // Update inventory summary
  updateInventorySummary();
}

function updateReplenishmentSuggestions() {
  const itemsNeedingReorder = InventorySystem.getItemsNeedingReorder();
  
  const tbody = document.querySelector('#replenishmentTable tbody');
  if (tbody) {
    tbody.innerHTML = itemsNeedingReorder.map(product => {
      const reorderLevel = product.reorderLevel || product.minStockLevel || 5;
      const targetStock = product.targetStock || 30;
      const currentStock = product.currentStock || 0;
      const suggestedQty = Math.max(targetStock - currentStock, reorderLevel);
      const cost = suggestedQty * (product.purchasePrice || 0);
      
      return `
      <tr>
        <td><strong>${product.name}</strong></td>
        <td>${currentStock}</td>
        <td>${reorderLevel}</td>
        <td><strong>${suggestedQty}</strong></td>
        <td>${UGX(cost)}</td>
      </tr>
      `;
    }).join('');
  }
}

function updateInventorySummary() {
  const totalValue = InventorySystem.getInventoryValue();
  const lowStockItems = InventorySystem.getItemsNeedingReorder();
  const outOfStockItems = db.products.filter(p => (p.currentStock || 0) === 0);
  
  // Calculate average stock days
  let totalTurnover = 0;
  let productsWithTurnover = 0;
  
  db.products.forEach(product => {
    const turnover = InventorySystem.getStockTurnover(product.id, 30);
    if (turnover > 0) {
      totalTurnover += turnover;
      productsWithTurnover++;
    }
  });
  
  const avgTurnover = productsWithTurnover > 0 ? totalTurnover / productsWithTurnover : 0;
  const avgStockDays = avgTurnover > 0 ? (30 / avgTurnover).toFixed(1) : 0;
  
  document.getElementById('totalInventoryValue').textContent = UGX(totalValue);
  document.getElementById('itemsNeedingReorder').textContent = lowStockItems.length;
  document.getElementById('avgStockDays').textContent = avgStockDays;
}

function setupInventory() {
  document.getElementById('inventoryDate').addEventListener('change', renderInventory);
  document.getElementById('filterCategory').addEventListener('change', renderInventory);
  document.getElementById('filterStockStatus').addEventListener('change', renderInventory);
  document.getElementById('btnUpdateInventory').addEventListener('click', renderInventory);
  document.getElementById('btnAutoUpdateInventory').addEventListener('click', () => {
    InventorySystem.updateAllStocks();
    renderInventory();
    updateDashboardStats();
    alert('Inventory auto-updated successfully!');
  });
}

// ================ EXPENSES MANAGEMENT ================
function renderExpenses() {
  const today = todayStr();
  document.getElementById('expenseDate').value = today;
  document.getElementById('expenseFrom').value = today;
  document.getElementById('expenseTo').value = today;
  
  // Reset form
  document.getElementById('expenseDescription').value = '';
  document.getElementById('expenseAmount').value = '0';
  
  // Load expenses
  loadExpenses();
  updateExpenseAnalysis();
}

function loadExpenses() {
  const from = document.getElementById('expenseFrom').value || todayStr();
  const to = document.getElementById('expenseTo').value || todayStr();
  
  const filtered = db.expenses.filter(e => e.date >= from && e.date <= to)
    .sort((a, b) => new Date(b.date) - new Date(a.date));
  
  const tbody = document.querySelector('#expensesTable tbody');
  if (tbody) {
    tbody.innerHTML = filtered.map((expense, index) => {
      return `
      <tr>
        <td>${expense.date}</td>
        <td><span class="pill">${expense.type}</span></td>
        <td>${expense.description || ''}</td>
        <td>${UGX(expense.amount)}</td>
        <td>${expense.paymentMethod || 'cash'}</td>
        <td><button class="btn bad" data-remove-expense="${index}"></button></td>
      </tr>
      `;
    }).join('');
  }
  
  // Update total expenses
  const totalExpenses = filtered.reduce((sum, e) => sum + (e.amount || 0), 0);
  document.getElementById('totalExpenses').textContent = UGX(totalExpenses);
}

function updateExpenseAnalysis() {
  const currentMonth = todayStr().substring(0, 7);
  const monthExpenses = db.expenses.filter(e => e.date && e.date.startsWith(currentMonth));
  
  const totalMonth = monthExpenses.reduce((sum, e) => sum + (e.amount || 0), 0);
  const avgDaily = totalMonth / new Date().getDate();
  
  // Find largest expense category
  const categoryTotals = {};
  monthExpenses.forEach(e => {
    categoryTotals[e.type] = (categoryTotals[e.type] || 0) + (e.amount || 0);
  });
  
  let largestCategory = '-';
  let largestAmount = 0;
  for (const [category, amount] of Object.entries(categoryTotals)) {
    if (amount > largestAmount) {
      largestAmount = amount;
      largestCategory = category;
    }
  }
  
  // Calculate expense ratio (expenses vs sales)
  let monthSales = 0;
  Object.values(db.dailySheets).forEach(sheet => {
    if (sheet.date && sheet.date.startsWith(currentMonth)) {
      monthSales += sheet.totalSales || 0;
    }
  });
  
  const expenseRatio = monthSales > 0 ? (totalMonth / monthSales * 100).toFixed(1) : 0;
  
  document.getElementById('expensesThisMonth').textContent = UGX(totalMonth);
  document.getElementById('avgDailyExpense').textContent = UGX(avgDaily);
  document.getElementById('largestExpenseCategory').textContent = largestCategory;
  document.getElementById('expenseRatio').textContent = expenseRatio + '%';
}

function setupExpenses() {
  // Save expense
  document.getElementById('btnSaveExpense').addEventListener('click', () => {
    const date = document.getElementById('expenseDate').value || todayStr();
    const type = document.getElementById('expenseType').value;
    const description = document.getElementById('expenseDescription').value.trim();
    const amount = parseInt(document.getElementById('expenseAmount').value) || 0;
    const paymentMethod = document.getElementById('expensePaymentMethod').value;
    const recurring = document.getElementById('expenseRecurring').value;
    
    if (!description) {
      alert('Please enter expense description');
      return;
    }
    
    if (amount <= 0) {
      alert('Please enter a valid amount');
      return;
    }
    
    const newExpense = {
      id: 'exp_' + Date.now(),
      date,
      type,
      description,
      amount,
      paymentMethod,
      recurring,
      recordedAt: new Date().toISOString()
    };
    
    db.expenses.push(newExpense);
    saveData();
    
    // Refresh display
    renderExpenses();
    updateDashboardStats();
    
    alert('Expense saved successfully!');
  });
  
  // Remove expense
  document.getElementById('expensesTable').addEventListener('click', (e) => {
    const removeBtn = e.target.closest('[data-remove-expense]');
    if (!removeBtn) return;
    
    const index = parseInt(removeBtn.getAttribute('data-remove-expense'));
    if (confirm('Delete this expense?')) {
      db.expenses.splice(index, 1);
      saveData();
      renderExpenses();
      updateDashboardStats();
    }
  });
  
  // Filter expenses
  document.getElementById('btnFilterExpenses').addEventListener('click', () => {
    loadExpenses();
    updateExpenseAnalysis();
  });
}

// ================ REPORTS ================
function initReports() {
  const today = todayStr();
  const firstDay = today.substring(0, 7) + '-01';
  
  document.getElementById('reportStart').value = firstDay;
  document.getElementById('reportEnd').value = today;
}

function generateReport() {
  const startDate = document.getElementById('reportStart').value;
  const endDate = document.getElementById('reportEnd').value;
  const comparePeriod = document.getElementById('comparePeriod').value;
  
  if (!startDate || !endDate) {
    alert('Please select report period');
    return;
  }
  
  // Calculate report data
  let totalSales = 0;
  let totalCost = 0;
  let totalProfit = 0;
  let totalExpenses = 0;
  const categoryBreakdown = {};
  const dailyBreakdown = [];
  
  // Get sales for period
  for (const [date, sheet] of Object.entries(db.dailySheets)) {
    if (date >= startDate && date <= endDate) {
      totalSales += sheet.totalSales || 0;
      totalCost += sheet.totalCost || 0;
      totalProfit += sheet.totalProfit || 0;
      
      // Daily breakdown
      dailyBreakdown.push({
        date,
        sales: sheet.totalSales || 0,
        cost: sheet.totalCost || 0,
        profit: sheet.totalProfit || 0,
        expenses: db.expenses.filter(e => e.date === date).reduce((sum, e) => sum + (e.amount || 0), 0)
      });
      
      // Category breakdown
      sheet.items.forEach(item => {
        const product = InventorySystem.getProductById(item.productId);
        if (product) {
          const category = product.category || 'other';
          if (!categoryBreakdown[category]) {
            categoryBreakdown[category] = {
              sales: 0,
              cost: 0,
              profit: 0,
              items: 0
            };
          }
          categoryBreakdown[category].sales += item.total;
          categoryBreakdown[category].cost += item.cost || 0;
          categoryBreakdown[category].profit += item.profit || 0;
          categoryBreakdown[category].items += item.quantity;
        }
      });
    }
  }
  
  // Get expenses for period
  db.expenses.forEach(expense => {
    if (expense.date >= startDate && expense.date <= endDate) {
      totalExpenses += expense.amount || 0;
    }
  });
  
  const netProfit = totalProfit - totalExpenses;
  const profitMargin = totalSales > 0 ? (totalProfit / totalSales * 100).toFixed(1) : 0;
  const netMargin = totalSales > 0 ? (netProfit / totalSales * 100).toFixed(1) : 0;
  
  // Generate report HTML
  let html = `
    <div class="grid-4">
      <div class="stat">
        <span class="muted">Report Period</span>
        <b>${startDate} to ${endDate}</b>
      </div>
      <div class="stat">
        <span class="muted">Total Sales</span>
        <b>${UGX(totalSales)}</b>
      </div>
      <div class="stat">
        <span class="muted">Gross Profit</span>
        <b>${UGX(totalProfit)}</b>
      </div>
      <div class="stat">
        <span class="muted">Gross Margin</span>
        <b>${profitMargin}%</b>
      </div>
    </div>
    
    <div class="grid-4" style="margin-top:16px;">
      <div class="stat">
        <span class="muted">COGS</span>
        <b>${UGX(totalCost)}</b>
      </div>
      <div class="stat">
        <span class="muted">Total Expenses</span>
        <b>${UGX(totalExpenses)}</b>
      </div>
      <div class="stat ${netProfit >= 0 ? 'goodmsg' : 'badmsg'}">
        <span class="muted">Net Profit/Loss</span>
        <b>${UGX(netProfit)}</b>
      </div>
      <div class="stat">
        <span class="muted">Net Margin</span>
        <b>${netMargin}%</b>
      </div>
    </div>
    
    <div class="hr"></div>
    
    <h4>Category Performance</h4>
    <table class="table" style="margin-bottom:20px;">
      <thead>
        <tr>
          <th>Category</th>
          <th>Items Sold</th>
          <th>Sales Revenue</th>
          <th>COGS</th>
          <th>Gross Profit</th>
          <th>Profit Margin</th>
        </tr>
      </thead>
      <tbody>
  `;
  
  for (const [category, data] of Object.entries(categoryBreakdown)) {
    const categoryMargin = data.sales > 0 ? (data.profit / data.sales * 100).toFixed(1) : 0;
    html += `
      <tr>
        <td><strong>${category}</strong></td>
        <td>${data.items}</td>
        <td>${UGX(data.sales)}</td>
        <td>${UGX(data.cost)}</td>
        <td>${UGX(data.profit)}</td>
        <td>${categoryMargin}%</td>
      </tr>
    `;
  }
  
  html += `
      </tbody>
    </table>
    
    <div class="grid-2">
      <div>
        <h4>Daily Performance</h4>
        <table class="table compact-table">
          <thead>
            <tr>
              <th>Date</th>
              <th>Sales</th>
              <th>Profit</th>
              <th>Expenses</th>
              <th>Net</th>
            </tr>
          </thead>
          <tbody>
  `;
  
  dailyBreakdown.forEach(day => {
    const dailyNet = day.profit - day.expenses;
    html += `
      <tr>
        <td>${day.date}</td>
        <td>${UGX(day.sales)}</td>
        <td>${UGX(day.profit)}</td>
        <td>${UGX(day.expenses)}</td>
        <td class="${dailyNet >= 0 ? 'positive' : 'negative'}">${UGX(dailyNet)}</td>
      </tr>
    `;
  });
  
  html += `
          </tbody>
        </table>
      </div>
      
      <div>
        <h4>Expense Breakdown</h4>
        <table class="table compact-table">
          <thead>
            <tr>
              <th>Expense Type</th>
              <th>Amount</th>
              <th>% of Total</th>
            </tr>
          </thead>
          <tbody>
  `;
  
  const expenseTypes = {};
  db.expenses.forEach(expense => {
    if (expense.date >= startDate && expense.date <= endDate) {
      expenseTypes[expense.type] = (expenseTypes[expense.type] || 0) + (expense.amount || 0);
    }
  });
  
  for (const [type, amount] of Object.entries(expenseTypes)) {
    const percentage = totalExpenses > 0 ? ((amount / totalExpenses) * 100).toFixed(1) : 0;
    html += `
      <tr>
        <td><span class="pill">${type}</span></td>
        <td>${UGX(amount)}</td>
        <td>${percentage}%</td>
      </tr>
    `;
  }
  
  html += `
          </tbody>
        </table>
      </div>
    </div>
  `;
  
  document.getElementById('reportOutput').innerHTML = html;
}

function setupReports() {
  document.getElementById('btnGenerateReport').addEventListener('click', generateReport);
  
  // Export report to Excel
  document.getElementById('btnExportReport').addEventListener('click', () => {
    const startDate = document.getElementById('reportStart').value;
    const endDate = document.getElementById('reportEnd').value;
    
    if (!startDate || !endDate) {
      alert('Please select report period first');
      return;
    }
    
    try {
      const wb = XLSX.utils.book_new();
      
      // Summary sheet
      const summaryData = [
        ["BAR MANAGEMENT SYSTEM - PROFIT & LOSS REPORT"],
        ["Period:", `${startDate} to ${endDate}`],
        ["Generated:", new Date().toLocaleString()],
        [],
        ["SUMMARY"],
        ["Total Sales", "COGS", "Gross Profit", "Total Expenses", "Net Profit", "Gross Margin", "Net Margin"],
        // Data will be added below
      ];
      
      // Calculate totals
      let totalSales = 0;
      let totalCost = 0;
      let totalProfit = 0;
      let totalExpenses = 0;
      
      Object.values(db.dailySheets).forEach(sheet => {
        if (sheet.date >= startDate && sheet.date <= endDate) {
          totalSales += sheet.totalSales || 0;
          totalCost += sheet.totalCost || 0;
          totalProfit += sheet.totalProfit || 0;
        }
      });
      
      db.expenses.forEach(expense => {
        if (expense.date >= startDate && expense.date <= endDate) {
          totalExpenses += expense.amount || 0;
        }
      });
      
      const netProfit = totalProfit - totalExpenses;
      const grossMargin = totalSales > 0 ? (totalProfit / totalSales * 100).toFixed(2) : 0;
      const netMargin = totalSales > 0 ? (netProfit / totalSales * 100).toFixed(2) : 0;
      
      summaryData.push([
        totalSales,
        totalCost,
        totalProfit,
        totalExpenses,
        netProfit,
        `${grossMargin}%`,
        `${netMargin}%`
      ]);
      
      const wsSummary = XLSX.utils.aoa_to_sheet(summaryData);
      XLSX.utils.book_append_sheet(wb, wsSummary, "Summary");
      
      // Daily breakdown sheet
      const dailyData = [
        ["DAILY BREAKDOWN"],
        ["Date", "Sales", "COGS", "Gross Profit", "Expenses", "Net Profit", "Margin"]
      ];
      
      for (const [date, sheet] of Object.entries(db.dailySheets)) {
        if (date >= startDate && date <= endDate) {
          const dailyExpenses = db.expenses
            .filter(e => e.date === date)
            .reduce((sum, e) => sum + (e.amount || 0), 0);
          const dailyNet = (sheet.totalProfit || 0) - dailyExpenses;
          const dailyMargin = (sheet.totalSales || 0) > 0 ? 
            ((sheet.totalProfit || 0) / (sheet.totalSales || 0) * 100).toFixed(2) : 0;
          
          dailyData.push([
            date,
            sheet.totalSales || 0,
            sheet.totalCost || 0,
            sheet.totalProfit || 0,
            dailyExpenses,
            dailyNet,
            `${dailyMargin}%`
          ]);
        }
      }
      
      const wsDaily = XLSX.utils.aoa_to_sheet(dailyData);
      XLSX.utils.book_append_sheet(wb, wsDaily, "Daily");
      
      // Download
      const wbout = XLSX.write(wb, { bookType: 'xlsx', type: 'binary' });
      
      function s2ab(s) {
        const buf = new ArrayBuffer(s.length);
        const view = new Uint8Array(buf);
        for (let i = 0; i < s.length; i++) view[i] = s.charCodeAt(i) & 0xFF;
        return buf;
      }
      
      download(`profit-loss-report-${startDate}-to-${endDate}.xlsx`, new Blob([s2ab(wbout)], { type: "application/octet-stream" }));
      
      alert('Report exported to Excel successfully!');
    } catch (error) {
      console.error('Export error:', error);
      alert('Error exporting report: ' + error.message);
    }
  });
}

// ================ DATA MANAGEMENT ================
function renderDataSection() {
  updateLastSaveTime();
}

function setupDataManagement() {
  // Backup data
  document.getElementById('btnBackup').addEventListener('click', () => {
    const dataStr = JSON.stringify(db, null, 2);
    const blob = new Blob([dataStr], { type: 'application/json' });
    download(`bar-backup-${todayStr()}.json`, blob);
  });
  
  // Save data
  document.getElementById('btnSaveNow').addEventListener('click', () => {
    if (saveData()) {
      const btn = document.getElementById('btnSaveNow');
      const originalText = btn.textContent;
      btn.textContent = " Saved!";
      btn.style.background = '#16a34a';
      setTimeout(() => {
        btn.textContent = originalText;
        btn.style.background = '';
      }, 1500);
    }
  });
  
  // Restore data
  document.getElementById('restoreFile').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = function(event) {
      try {
        const newData = JSON.parse(event.target.result);
        if (confirm('Restore this data? Current data will be replaced.')) {
          db = newData;
          saveData();
          location.reload();
        }
      } catch (err) {
        alert('Error restoring data: ' + err.message);
      }
    };
    reader.readAsText(file);
    this.value = '';
  });
  
  // Export all data
  document.getElementById('btnExportAllData').addEventListener('click', exportAllData);
  
  // Export inventory
  document.getElementById('btnExportInventoryExcel').addEventListener('click', exportInventoryExcel);
  
  // Data tools
  document.getElementById('btnRecalculateInventory').addEventListener('click', () => {
    InventorySystem.updateAllStocks();
    renderInventory();
    updateDashboardStats();
    alert('Inventory recalculated successfully!');
  });
  
  document.getElementById('btnFixStockLevels').addEventListener('click', () => {
    // Find and fix negative stocks
    let fixedCount = 0;
    db.products.forEach(product => {
      if (product.currentStock < 0) {
        const adjustment = {
          id: 'adj_fix_' + Date.now(),
          date: todayStr(),
          productId: product.id,
          previousQty: product.currentStock,
          newQty: 0,
          reason: 'Fixed negative stock',
          recordedAt: new Date().toISOString()
        };
        db.adjustments.push(adjustment);
        product.currentStock = 0;
        fixedCount++;
      }
    });
    
    saveData();
    renderProducts();
    renderInventory();
    alert(`Fixed ${fixedCount} negative stock items!`);
  });
  
  document.getElementById('btnDataAudit').addEventListener('click', runDataAudit);
  
  // Danger zone
  document.getElementById('btnWipe').addEventListener('click', () => {
    if (confirm('ARE YOU SURE? This will delete ALL data and cannot be undone!')) {
      localStorage.removeItem(STORAGE_KEY);
      location.reload();
    }
  });
  
  document.getElementById('btnClearPurchases').addEventListener('click', () => {
    if (confirm('Clear all purchases? This cannot be undone!')) {
      db.purchases = [];
      InventorySystem.updateAllStocks();
      saveData();
      renderPurchases();
      renderProducts();
      renderInventory();
      updateDashboardStats();
      alert('All purchases cleared!');
    }
  });
  
  document.getElementById('btnClearExpenses').addEventListener('click', () => {
    if (confirm('Clear all expenses? This cannot be undone!')) {
      db.expenses = [];
      saveData();
      renderExpenses();
      updateDashboardStats();
      alert('All expenses cleared!');
    }
  });
}

function exportAllData() {
  try {
    const wb = XLSX.utils.book_new();
    
    // Products sheet
    const productsData = db.products.map(p => ({
      'ID': p.id,
      'Name': p.name,
      'Category': p.category || 'other',
      'Purchase Price': p.purchasePrice || 0,
      'Sale Price': p.salePrice || 0,
      'Opening Stock': p.openingStock || 0,
      'Current Stock': p.currentStock || 0,
      'Reorder Level': p.reorderLevel || p.minStockLevel || 5,
      'Target Stock': p.targetStock || 30,
      'Unit': p.unit || 'bottle',
      'Sold Count': p.soldCount || 0,
      'Total Sales': p.totalSales || 0,
      'Total Profit': p.totalProfit || 0,
      'Stock Value': (p.currentStock || 0) * (p.purchasePrice || 0),
      'Stock Status': p.stockStatus || 'good'
    }));
    
    const wsProducts = XLSX.utils.json_to_sheet(productsData);
    XLSX.utils.book_append_sheet(wb, wsProducts, 'Products');
    
    // Purchases sheet
    const purchasesData = db.purchases.flatMap(p => 
      (p.items || []).map(item => ({
        'Date': p.date,
        'Supplier': p.supplier || '',
        'Invoice No': p.invoiceNo || '',
        'Product': InventorySystem.getProductById(item.productId)?.name || 'Unknown',
        'Quantity': item.quantity || 0,
        'Unit Cost': item.unitCost || 0,
        'Total': item.total || 0,
        'Status': p.status || 'pending',
        'Payment Method': p.paymentMethod || 'cash',
        'Total Purchase': p.total || 0
      }))
    );
    
    if (purchasesData.length > 0) {
      const wsPurchases = XLSX.utils.json_to_sheet(purchasesData);
      XLSX.utils.book_append_sheet(wb, wsPurchases, 'Purchases');
    }
    
    // Sales sheet
    const salesData = [];
    Object.values(db.dailySheets).forEach(sheet => {
      (sheet.items || []).forEach(item => {
        const product = InventorySystem.getProductById(item.productId);
        salesData.push({
          'Date': sheet.date,
          'Shift': sheet.shift || 'full',
          'Product': product?.name || 'Unknown',
          'Quantity': item.quantity || 0,
          'Unit Price': item.unitPrice || 0,
          'Total Sales': item.total || 0,
          'Cost': item.cost || 0,
          'Profit': item.profit || 0,
          'Source': sheet.source || 'manual'
        });
      });
    });
    
    if (salesData.length > 0) {
      const wsSales = XLSX.utils.json_to_sheet(salesData);
      XLSX.utils.book_append_sheet(wb, wsSales, 'Sales');
    }
    
    // Expenses sheet
    if (db.expenses.length > 0) {
      const wsExpenses = XLSX.utils.json_to_sheet(db.expenses);
      XLSX.utils.book_append_sheet(wb, wsExpenses, 'Expenses');
    }
    
    // Summary sheet
    const summaryData = [
      ["BAR MANAGEMENT SYSTEM - COMPLETE DATA EXPORT"],
      ["Export Date:", new Date().toLocaleString()],
      ["Total Products:", db.products.length],
      ["Total Purchases:", db.purchases.length],
      ["Total Sales Days:", Object.keys(db.dailySheets).length],
      ["Total Expenses:", db.expenses.length],
      ["Total Inventory Value:", UGX(InventorySystem.getInventoryValue())]
    ];
    
    const wsSummary = XLSX.utils.aoa_to_sheet(summaryData);
    XLSX.utils.book_append_sheet(wb, wsSummary, 'Summary');
    
    // Download
    const wbout = XLSX.write(wb, { bookType: 'xlsx', type: 'binary' });
    
    function s2ab(s) {
      const buf = new ArrayBuffer(s.length);
      const view = new Uint8Array(buf);
      for (let i = 0; i < s.length; i++) view[i] = s.charCodeAt(i) & 0xFF;
      return buf;
    }
    
    download(`bar-export-complete-${todayStr()}.xlsx`, new Blob([s2ab(wbout)], { type: "application/octet-stream" }));
    
    alert('All data exported to Excel successfully!');
  } catch (error) {
    console.error('Export error:', error);
    alert('Error exporting to Excel: ' + error.message);
  }
}

function exportInventoryExcel() {
  try {
    const inventoryData = db.products.map(p => ({
      'Product': p.name,
      'Category': p.category || 'other',
      'Purchase Price': p.purchasePrice || 0,
      'Sale Price': p.salePrice || 0,
      'Opening Stock': p.openingStock || 0,
      'Current Stock': p.currentStock || 0,
      'Reorder Level': p.reorderLevel || p.minStockLevel || 5,
      'Target Stock': p.targetStock || 30,
      'Stock Value': (p.currentStock || 0) * (p.purchasePrice || 0),
      'Unit': p.unit || 'bottle',
      'Sold This Month': p.soldCount || 0,
      'Profit Margin': p.purchasePrice > 0 ? 
        ((p.salePrice - p.purchasePrice) / p.purchasePrice * 100).toFixed(1) + '%' : '0%',
      'Stock Status': p.stockStatus || 'good',
      'Last Updated': p.lastStockUpdate ? new Date(p.lastStockUpdate).toLocaleString() : 'Never'
    }));
    
    const ws = XLSX.utils.json_to_sheet(inventoryData);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'Inventory');
    
    const wbout = XLSX.write(wb, { bookType: 'xlsx', type: 'binary' });
    
    function s2ab(s) {
      const buf = new ArrayBuffer(s.length);
      const view = new Uint8Array(buf);
      for (let i = 0; i < s.length; i++) view[i] = s.charCodeAt(i) & 0xFF;
      return buf;
    }
    
    download(`bar-inventory-${todayStr()}.xlsx`, new Blob([s2ab(wbout)], { type: "application/octet-stream" }));
    
    alert('Inventory exported to Excel successfully!');
  } catch (error) {
    console.error('Inventory export error:', error);
    alert('Error exporting inventory: ' + error.message);
  }
}

function runDataAudit() {
  const auditResults = [];
  const auditEl = document.getElementById('dataAuditResults');
  const auditText = document.getElementById('auditResultsText');
  
  auditEl.style.display = 'block';
  
  // Check for negative stocks
  const negativeStocks = db.products.filter(p => (p.currentStock || 0) < 0);
  if (negativeStocks.length > 0) {
    auditResults.push(` Found ${negativeStocks.length} products with negative stock`);
    negativeStocks.forEach(p => {
      auditResults.push(`   - ${p.name}: ${p.currentStock}`);
    });
  }
  
  // Check for zero price products
  const zeroPrice = db.products.filter(p => (p.purchasePrice || 0) <= 0 || (p.salePrice || 0) <= 0);
  if (zeroPrice.length > 0) {
    auditResults.push(` Found ${zeroPrice.length} products with zero or negative prices`);
  }
  
  // Check for missing categories
  const missingCategory = db.products.filter(p => !p.category || p.category.trim() === '');
  if (missingCategory.length > 0) {
    auditResults.push(` Found ${missingCategory.length} products without category`);
  }
  
  // Check for duplicate product names
  const productNames = db.products.map(p => p.name.toLowerCase());
  const duplicates = productNames.filter((name, index) => productNames.indexOf(name) !== index);
  if (duplicates.length > 0) {
    auditResults.push(` Found ${duplicates.length} duplicate product names`);
  }
  
  // Check for invalid dates in transactions
  let invalidDates = 0;
  [...db.purchases, ...db.expenses].forEach(item => {
    if (item.date && !/^\d{4}-\d{2}-\d{2}$/.test(item.date)) {
      invalidDates++;
    }
  });
  if (invalidDates > 0) {
    auditResults.push(` Found ${invalidDates} transactions with invalid date formats`);
  }
  
  // Calculate data completeness
  const totalProducts = db.products.length;
  const completeProducts = db.products.filter(p => 
    p.name && p.category && p.purchasePrice > 0 && p.salePrice > 0
  ).length;
  const completeness = totalProducts > 0 ? (completeProducts / totalProducts * 100).toFixed(1) : 0;
  
  auditResults.push(`\n Data Completeness: ${completeness}% (${completeProducts}/${totalProducts} products complete)`);
  
  // Inventory accuracy check
  InventorySystem.updateAllStocks();
  const mismatched = db.products.filter(p => {
    const calculated = InventorySystem.calculateCurrentStock(p.id);
    return Math.abs(calculated - (p.currentStock || 0)) > 0.01;
  });
  
  if (mismatched.length > 0) {
    auditResults.push(` Found ${mismatched.length} products with stock calculation mismatches`);
  } else {
    auditResults.push(` Inventory calculations are accurate`);
  }
  
  auditText.textContent = auditResults.join('\n');
  
  if (negativeStocks.length === 0 && duplicates.length === 0) {
    auditEl.style.borderColor = '#16a34a';
    auditEl.style.background = '#ecfdf5';
  } else {
    auditEl.style.borderColor = '#ef4444';
    auditEl.style.background = '#fee2e2';
  }
}

// ================ GOOGLE DRIVE INTEGRATION ================
const GOOGLE_CLIENT_ID = "1012401719257-nm0hj0h1na9d7tm8eat4tllgigjrbir0.apps.googleusercontent.com";
const DRIVE_SCOPE = "https://www.googleapis.com/auth/drive.file";
const DRIVE_FILE_NAME = "bar-management-backup.json";
let driveAccessToken = null;
let driveTokenClient = null;

function setCloudStatus(text, good = false) {
  const el = document.getElementById('cloudStatus');
  if (el) {
    el.textContent = text;
    el.style.background = good ? '#16a34a' : '#64748b';
    el.style.color = 'white';
  }
}

async function initGoogleDrive() {
  return new Promise((resolve) => {
    if (typeof google === 'undefined' || !google.accounts) {
      setTimeout(() => initGoogleDrive().then(resolve), 100);
      return;
    }
    
    try {
      driveTokenClient = google.accounts.oauth2.initTokenClient({
        client_id: GOOGLE_CLIENT_ID,
        scope: DRIVE_SCOPE,
        callback: async (tokenResponse) => {
          if (tokenResponse && tokenResponse.access_token) {
            driveAccessToken = tokenResponse.access_token;
            setCloudStatus(" Signed in", true);
            document.getElementById('btnCloudSave').disabled = false;
            document.getElementById('btnCloudLoad').disabled = false;
            document.getElementById('btnGSignIn').disabled = true;
          }
        }
      });
      
      resolve();
    } catch (error) {
      console.error('Google Drive init error:', error);
      setCloudStatus(" Not available", false);
      resolve();
    }
  });
}

async function driveSave() {
  const ok = await driveEnsureToken(true);
  if (!ok) {
    alert("Please sign in to Google first.");
    return;
  }
  
  const btn = document.getElementById('btnCloudSave');
  const originalText = btn.textContent;
  
  try {
    btn.textContent = "Saving...";
    btn.disabled = true;
    
    const jsonData = JSON.stringify(db, null, 2);
    const existing = await driveFindBackup();
    
    if (existing) {
      await driveUpdateBackup(existing.id, jsonData);
    } else {
      await driveCreateBackup(jsonData);
    }
    
    const now = new Date().toISOString();
    document.getElementById('lastCloudBackup').textContent = new Date(now).toLocaleString();
    setCloudStatus(` Saved: ${new Date().toLocaleTimeString()}`, true);
    
    btn.textContent = " Saved!";
    setTimeout(() => {
      btn.textContent = originalText;
      btn.disabled = false;
    }, 2000);
    
    alert(" Backup saved to Google Drive!");
  } catch (error) {
    console.error('Google Drive save error:', error);
    btn.textContent = originalText;
    btn.disabled = false;
    alert("Error saving to Google Drive: " + error.message);
  }
}

async function driveLoad() {
  const ok = await driveEnsureToken(true);
  if (!ok) {
    alert("Please sign in to Google first.");
    return;
  }
  
  try {
    const existing = await driveFindBackup();
    if (!existing) {
      alert("No backup file found in Google Drive.");
      return;
    }
    
    if (!confirm(`Load backup from ${new Date(existing.modifiedTime).toLocaleString()}?`)) {
      return;
    }
    
    const jsonText = await driveDownloadFile(existing.id);
    const backupData = JSON.parse(jsonText);
    
    if (confirm("This will replace ALL current data. Continue?")) {
      db = backupData;
      saveData();
      
      const btn = document.getElementById('btnCloudLoad');
      const originalText = btn.textContent;
      btn.textContent = " Loaded!";
      btn.disabled = true;
      
      setTimeout(() => {
        btn.textContent = originalText;
        btn.disabled = false;
        location.reload();
      }, 1000);
    }
  } catch (error) {
    console.error('Google Drive load error:', error);
    alert("Error loading from Google Drive: " + error.message);
  }
}

async function driveEnsureToken(interactive = true) {
  return new Promise((resolve) => {
    if (driveAccessToken) {
      resolve(true);
      return;
    }
    
    if (!driveTokenClient) {
      setCloudStatus("Google Drive not initialized");
      resolve(false);
      return;
    }
    
    driveTokenClient.callback = (resp) => {
      if (resp && resp.access_token) {
        driveAccessToken = resp.access_token;
        setCloudStatus(" Signed in", true);
        document.getElementById('btnCloudSave').disabled = false;
        document.getElementById('btnCloudLoad').disabled = false;
        document.getElementById('btnGSignIn').disabled = true;
        resolve(true);
      } else {
        resolve(false);
      }
    };
    
    driveTokenClient.requestAccessToken(interactive ? {prompt: 'consent'} : {prompt: ''});
  });
}

async function driveFindBackup() {
  try {
    const q = encodeURIComponent(`name='${DRIVE_FILE_NAME}' and mimeType='application/json' and trashed=false`);
    const url = `https://www.googleapis.com/drive/v3/files?q=${q}&fields=files(id,name,modifiedTime,size)`;
    
    const response = await fetch(url, {
      headers: { Authorization: `Bearer ${driveAccessToken}` }
    });
    
    if (!response.ok) {
      throw new Error(`Drive API error: ${response.status}`);
    }
    
    const data = await response.json();
    return data.files && data.files[0] ? data.files[0] : null;
  } catch (error) {
    console.error('Error finding backup:', error);
    return null;
  }
}

async function driveDownloadFile(fileId) {
  const response = await fetch(`https://www.googleapis.com/drive/v3/files/${fileId}?alt=media`, {
    headers: { Authorization: `Bearer ${driveAccessToken}` }
  });
  
  if (!response.ok) {
    throw new Error(`Download failed: ${response.status}`);
  }
  
  return response.text();
}

function makeMultipartBody(meta, contentStr) {
  const boundary = "-------bar-backup" + Math.random().toString(36).slice(2);
  const delimiter = `\r\n--${boundary}\r\n`;
  const close = `\r\n--${boundary}--`;
  
  const body = delimiter +
    "Content-Type: application/json; charset=UTF-8\r\n\r\n" +
    JSON.stringify(meta) +
    delimiter +
    "Content-Type: application/json\r\n\r\n" +
    contentStr +
    close;
  
  return {
    body,
    headers: {
      "Content-Type": `multipart/related; boundary=${boundary}`,
      "Authorization": `Bearer ${driveAccessToken}`
    }
  };
}

async function driveCreateBackup(jsonStr) {
  const meta = {
    name: DRIVE_FILE_NAME,
    mimeType: "application/json",
    description: "Bar Management System Backup"
  };
  
  const { body, headers } = makeMultipartBody(meta, jsonStr);
  const url = "https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart";
  
  const response = await fetch(url, {
    method: "POST",
    headers,
    body
  });
  
  if (!response.ok) {
    throw new Error(`Create failed: ${response.status}`);
  }
  
  return response.json();
}

async function driveUpdateBackup(fileId, jsonStr) {
  const meta = { mimeType: "application/json" };
  const { body, headers } = makeMultipartBody(meta, jsonStr);
  const url = `https://www.googleapis.com/upload/drive/v3/files/${fileId}?uploadType=multipart`;
  
  const response = await fetch(url, {
    method: "PATCH",
    headers,
    body
  });
  
  if (!response.ok) {
    throw new Error(`Update failed: ${response.status}`);
  }
  
  return response.json();
}

function setupGoogleDrive() {
  document.getElementById('btnGSignIn').addEventListener('click', async () => {
    const ok = await driveEnsureToken(true);
    if (ok) {
      setCloudStatus(" Signed in", true);
    }
  });
  
  document.getElementById('btnCloudSave').addEventListener('click', driveSave);
  document.getElementById('btnCloudLoad').addEventListener('click', driveLoad);
}

// ================ INITIALIZATION ================
async function initializeApp() {
  // Set today's date in all date fields
  const today = todayStr();
  document.querySelectorAll('input[type="date"]').forEach(input => {
    if (!input.value) input.value = today;
  });
  
  // Initialize products from Excel if empty
  initializeProductsFromExcel();
  
  // Update all stocks initially
  InventorySystem.updateAllStocks();
  
  // Setup all components
  setupTabs();
  setupProducts();
  setupPurchases();
  setupSales();
  setupInventory();
  setupExpenses();
  setupReports();
  setupDataManagement();
  
  // Initialize Google Drive
  await initGoogleDrive();
  setupGoogleDrive();
  
  // Initial render
  renderProducts();
  updateDashboardStats();
  renderDataSection();
  
  console.log('Complete Bar Management System with Automated Inventory initialized successfully!');
}

// Start the application
document.addEventListener('DOMContentLoaded', initializeApp);
</script>
</body>
</html>
